<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/static/favicon.png">
  <title>ê²°ì¬ì„  Â· ì •ì‚°</title>
  <style>
    :root {
      --bg: #f8fafc;
      --text: #0f172a;
      --muted: #64748b;
      --line: #e2e8f0;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --card-bg: #ffffff;
      --hover: #f1f5f9;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* í—¤ë” */
    .header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--line);
      padding: 20px 0;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .05);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .logo {
      font-size: 24px;
      font-weight: 800;
      color: var(--text);
      text-decoration: none;
    }

    .logo:hover {
      color: var(--primary);
    }

    .nav-links {
      display: flex;
      gap: 8px;
    }

    .nav-link {
      padding: 8px 16px;
      border-radius: 8px;
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all .2s;
    }

    .nav-link:hover {
      background: var(--hover);
      color: var(--text);
    }

    .nav-link.active {
      background: var(--primary);
      color: #fff;
    }

    .main {
      padding: 32px 0;
    }

    .section {
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
    }

    /* ì¹´ë“œ */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 20px;
      transition: all .2s;
    }

    .card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
    }

    /* í†µê³„ ì¹´ë“œ */
    .stat-card {
      position: relative;
      overflow: hidden;
    }

    .stat-icon {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 32px;
      opacity: 0.2;
    }

    .stat-label {
      font-size: 13px;
      color: var(--muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 800;
      line-height: 1;
      margin-bottom: 8px;
    }

    .panel {
      background: var(--card-bg);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
    }

    .stack {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* ë²„íŠ¼ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all .2s;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: #fff;
      color: var(--text);
      border: 1px solid var(--line);
    }

    .btn-secondary:hover {
      background: var(--hover);
    }

    .btn-success {
      background: var(--success);
      color: #fff;
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn-accent {
      background: var(--primary);
      color: #fff;
      border-radius: 12px;
    }

    .btn-ghost {
      background: #fff;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .btn-outline {
      background: #fff;
      color: var(--text);
      border: 1px solid var(--line);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* ê·¸ë¦¬ë“œ */
    .grid {
      display: grid;
      gap: 20px;
    }

    .grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .grid-4 {
      grid-template-columns: repeat(4, 1fr);
    }

    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 500;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select {
      background: #fff;
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 10px 12px;
      min-width: 200px;
      outline: none;
      transition: all .2s;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, .1);
    }

    .tag {
      display: inline-block;
      padding: 4px 8px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: #f6f8fa;
      font-size: 12px;
      cursor: pointer;
      margin-right: 6px;
      transition: all .2s;
    }

    .tag.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .tag:hover {
      background: var(--hover);
    }

    .muted-sm {
      font-size: 12px;
      color: var(--muted);
    }

    .wizard {
      border: 1px solid var(--line);
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
    }

    .slide {
      display: none;
    }

    .slide.active {
      display: block;
    }

    .two-col {
      display: grid;
      gap: 12px;
    }

    @media(min-width:1100px) {
      .two-col {
        grid-template-columns: 1fr 1fr;
      }
    }

    .muted {
      color: var(--muted);
    }

    .pill {
      border: 1px solid var(--line);
      background: #f6f8fa;
      color: var(--text);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
    }

    .cards {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
    }

    .card .card-hd {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      cursor: pointer;
    }

    .card .card-bd {
      padding: 0 12px 12px 12px;
    }

    .card.collapsed .card-bd {
      display: none;
    }

    .mini {
      font-size: 12px;
    }

    .mini th,
    .mini td {
      padding: 4px 6px;
    }

    .dense th,
    .dense td {
      padding: 6px 8px;
      font-size: 12px;
    }

    .sticky thead th {
      position: sticky;
      top: 0;
      background: var(--card-bg);
      z-index: 1;
    }

    .two-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
    }

    .fill {
      width: 100%;
    }

    .acc-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: minmax(0, 1fr) 140px 160px;
      align-items: end;
    }

    .col-left {
      grid-column: 1 / 2;
    }

    /* í…Œì´ë¸” */
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
    }

    th {
      background: var(--hover);
      padding: 12px 16px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
      border-bottom: 1px solid var(--line);
    }

    td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      font-size: 14px;
    }

    tbody tr {
      transition: background .2s;
    }

    tbody tr:hover {
      background: var(--hover);
    }

    .chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      border: 1px solid var(--line);
      background: #f6f8fa;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
      transition: all .2s;
    }

    .chip.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .chip:hover {
      background: var(--hover);
    }

    /* ë¡œë”© */
    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, .5);
      z-index: 50;
    }

    .spinner {
      width: 34px;
      height: 34px;
      border: 3px solid rgba(59, 130, 246, .3);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    .progress {
      width: 260px;
      height: 8px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      margin: 8px auto 0;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: var(--primary);
      transition: width .2s ease;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* í˜ì´ì§€ 2ì—´ ë ˆì´ì•„ì›ƒ */
    .page {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .subnav {
      width: 200px;
      flex-shrink: 0;
      border: 1px solid var(--line);
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .05);
    }

    .subnav .title-sm {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 12px;
      color: var(--text);
    }

    .subnav .vtab {
      display: block;
      width: 100%;
      text-align: left;
      padding: 10px 16px;
      border: 1px solid var(--line);
      background: #f6f8fa;
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      color: var(--text);
      transition: all .2s;
    }

    .subnav .vtab:hover {
      background: var(--hover);
    }

    .subnav .vtab.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .maincol {
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }

    /* ëª¨ë°”ì¼: ì¢Œì¸¡ íƒ­ ìˆ¨ê¸°ê³  ìƒë‹¨ íƒ­ í‘œì‹œ */
    .tabbar {
      display: none;
    }

    @media(max-width:900px) {
      .page {
        display: block;
      }

      .subnav {
        display: none;
      }

      .tabbar {
        display: block;
      }

      .grid-2,
      .grid-3,
      .grid-4 {
        grid-template-columns: 1fr;
      }
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--text);
      color: #fff;
      padding: 14px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .15);
      z-index: 200;
      opacity: 0;
      transform: translateY(20px);
      transition: all .3s;
      display: none;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
      display: block;
    }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .empty-desc {
      font-size: 14px;
    }

    /* ëª¨ë‹¬ */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow: auto;
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 24px;
      border-top: 1px solid var(--line);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
  </style>
</head>

<body>
  <!-- í—¤ë” -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="/" class="logo">ğŸ¢ ì œì´íˆ¬ë© ê´€ë¦¬ì‹œìŠ¤í…œ</a>
        <div class="nav-links">
          <a href="/" class="nav-link">ë§ˆê° ì•ˆë‚´</a>
          <a href="/manage" class="nav-link">ì›”ë³´ì¥ ê´€ë¦¬</a>
          <a href="/settlement" class="nav-link active">ê²°ì¬ì„  Â· ì •ì‚°</a>
        </div>
        <div id="user-info" style="display:flex; align-items:center; gap:12px;">
          <span id="user-name" style="font-size:13px; color:var(--muted);"></span>
          <span id="user-role" class="pill" style="font-size:11px;"></span>
          <button id="btn-logout" class="btn btn-sm btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ë©”ì¸ -->
  <main class="main">
    <div class="container">
      <div class="page">
        <aside class="subnav">
          <div class="title-sm">ê²°ì¬ì„ </div>
          <button id="side-tab-settle" class="vtab active" type="button">ì •ì‚°</button>
          <button id="side-tab-price" class="vtab" type="button">ë‹¨ê°€ ê´€ë¦¬</button>
          <button id="side-tab-agency" class="vtab" type="button">ğŸ” ëŒ€í–‰ì‚¬ ì¡°íšŒ</button>
        </aside>
        <div class="maincol">
          <!-- ëª¨ë°”ì¼ ìƒë‹¨ íƒ­: ë°ìŠ¤í¬í†±ì—ì„œëŠ” ìˆ¨ê¹€ -->
          <div id="tabbar" class="card tabbar" style="margin-bottom:16px">
            <div class="stack" style="justify-content:flex-start">
              <button id="tab-settle" class="btn btn-primary" type="button">ì •ì‚°</button>
              <button id="tab-price" class="btn btn-secondary" type="button">ë‹¨ê°€ ê´€ë¦¬</button>
              <button id="tab-agency" class="btn btn-secondary" type="button">ğŸ” ëŒ€í–‰ì‚¬ ì¡°íšŒ</button>
            </div>
          </div>

          <!-- ì •ì‚° íƒ­ ì½˜í…ì¸  -->
          <div id="settle-content">

            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="section" id="settle-stats-section" style="display:none;">
              <div style="display:flex; gap:12px; overflow-x:auto;">
                <div class="card stat-card"
                  style="border-left:4px solid var(--primary); min-width:200px; flex:1; padding:16px;">
                  <div class="stat-icon" style="font-size:24px;">ğŸ“‘</div>
                  <div class="stat-label">ì„ íƒëœ íƒ­</div>
                  <div class="stat-value" style="font-size:28px;" id="stat-selected-tabs">0</div>
                </div>
                <div class="card stat-card"
                  style="border-left:4px solid var(--success); min-width:200px; flex:1; padding:16px;">
                  <div class="stat-icon" style="font-size:24px;">ğŸ¢</div>
                  <div class="stat-label">ì´ ê±°ë˜ì²˜</div>
                  <div class="stat-value" style="font-size:28px;" id="stat-total-clients">0</div>
                </div>
                <div class="card stat-card"
                  style="border-left:4px solid var(--warning); min-width:200px; flex:1; padding:16px;">
                  <div class="stat-icon" style="font-size:24px;">ğŸ’°</div>
                  <div class="stat-label" style="font-size:11px;">ì´ ì§€ì¶œ (VAT í¬í•¨)</div>
                  <div class="stat-value" style="font-size:28px;" id="stat-total-expense">0</div>
                </div>
                <div class="card stat-card"
                  style="border-left:4px solid var(--danger); min-width:200px; flex:1; padding:16px;">
                  <div class="stat-icon" style="font-size:24px;">âš ï¸</div>
                  <div class="stat-label">ë¯¸ì • ë‹¨ê°€</div>
                  <div class="stat-value" style="font-size:28px;" id="stat-missing-prices">0</div>
                </div>
              </div>
            </div>

            <!-- 1) ì¤‘ì•™ íˆì–´ë¡œ: íƒ­ ë¶ˆëŸ¬ì˜¤ê¸°/ê¸°ê°„/ê°€ì ¸ì˜¤ê¸°ë§Œ í‘œì‹œ (ì •ì‚° íƒ­ì—ì„œë§Œ ë³´ì„) -->
            <div class="section" id="settle-query-section">
              <div class="section-header">
                <h2 class="section-title">ğŸ“Š ì •ì‚° ë°ì´í„° ì¡°íšŒ</h2>
              </div>
              <div id="hero" class="card" style="display:block">
                <div class="stack" style="align-items:flex-end">
                  <div>
                    <label>êµ¬ê¸€ ì‹œíŠ¸ í•˜ë‹¨ íƒ­</label>
                    <div class="stack">
                      <button id="load-tabs" class="btn btn-secondary">ğŸ“‘ íƒ­ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                      <span id="tab-count" class="pill">0ê°œ</span>
                    </div>
                  </div>
                  <div style="flex:1; min-width:260px">
                    <label>íƒ­(ë‚ ì§œ) ì„ íƒ</label>
                    <div id="tab-chips" class="chips"></div>
                  </div>
                  <!-- ê¸°ê°„ ì„ íƒ ì œê±° -->
                  <button id="fetch-data" class="btn btn-primary">ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
                </div>
                <div class="muted" style="margin-top:8px; font-size:12px">íƒ­ëª…ì€ ë‚ ì§œ(ì˜ˆ: 2025-10-06) í˜•ì‹ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</div>
              </div>
            </div>

          </div>
          <!-- ì •ì‚° íƒ­ ì½˜í…ì¸  ë -->

          <!-- ë‹¨ê°€ ê´€ë¦¬ íƒ­ ì½˜í…ì¸  -->
          <div id="price-content" style="display:none;">
            <div class="section">
              <div class="section-header">
                <h2 class="section-title">ğŸ’° ë‹¨ê°€ ê´€ë¦¬</h2>
                <div class="btn-group">
                  <button id="btn-save-price" class="btn btn-success btn-sm">ğŸ’¾ ì €ì¥</button>
                  <button id="btn-bulk-toggle" class="btn btn-secondary btn-sm">ğŸ“¤ ì—‘ì…€ ëŒ€ëŸ‰ë“±ë¡</button>
                  <a id="bulk-download" class="btn btn-secondary btn-sm" href="/api/settlement/pricebook/template">ğŸ“¥ ì–‘ì‹
                    ë‹¤ìš´ë¡œë“œ</a>
                </div>
              </div>

              <!-- ì‹ ê·œ ìƒí’ˆ ë“±ë¡ -->
              <div class="card" style="margin-bottom:20px;">
                <h3 style="font-size:16px; font-weight:600; margin-bottom:16px; color:var(--text);">â• ì‹ ê·œ ìƒí’ˆ ë“±ë¡</h3>
                <div class="panel" style="background:var(--bg);">
                  <div
                    style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:12px;">
                    <div>
                      <label>ê±°ë˜ì²˜ *</label>
                      <input id="pb-client" type="text" placeholder="ì˜ˆ: ì¼ë¥˜ê¸°íš" style="width:100%;" />
                    </div>
                    <div>
                      <label>ìƒí’ˆëª… *</label>
                      <input id="pb-product" type="text" placeholder="ì˜ˆ: ì¼ë¥˜1" style="width:100%;" />
                    </div>
                    <div>
                      <label>ë‹¨ê°€ *</label>
                      <input id="pb-price" type="text" placeholder="ì˜ˆ: 1750" style="width:100%;" />
                    </div>
                  </div>
                  <div
                    style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:12px;">
                    <div>
                      <label>ê³„ì¢Œ</label>
                      <input id="pb-account" type="text" placeholder="ê³„ì¢Œë²ˆí˜¸" style="width:100%;" />
                    </div>
                    <div>
                      <label>ì€í–‰</label>
                      <input id="pb-bank" type="text" placeholder="ì€í–‰ëª…" style="width:100%;" />
                    </div>
                    <div>
                      <label>ì˜ˆê¸ˆì£¼</label>
                      <input id="pb-holder" type="text" placeholder="ì˜ˆ: ãˆœì œì´í‹°ë”ë¸”ìœ ë©" style="width:100%;" />
                    </div>
                  </div>
                  <div class="stack" style="justify-content:space-between; align-items:center; flex-wrap:wrap;">
                    <div class="stack" style="gap:12px; align-items:center;">
                      <label style="margin:0; color:var(--muted); font-size:13px; font-weight:600;">ìœ í˜•</label>
                      <label class="muted" style="display:flex; align-items:center; gap:6px; font-weight:500;"><input
                          type="radio" name="pb-type" value="ê³µí†µ" checked />ê³µí†µ</label>
                      <label class="muted" style="display:flex; align-items:center; gap:6px; font-weight:500;"><input
                          type="radio" name="pb-type" value="ì €ì¥" />ì €ì¥</label>
                      <label class="muted" style="display:flex; align-items:center; gap:6px; font-weight:500;"><input
                          type="radio" name="pb-type" value="íŠ¸ë˜í”½" />íŠ¸ë˜í”½</label>
                    </div>
                    <div class="btn-group">
                      <button id="pb-add-one" class="btn btn-primary" type="button">â• ì¶”ê°€</button>
                      <button id="pb-add-both" class="btn btn-secondary" type="button">â• ì €ì¥Â·íŠ¸ë˜í”½ ë™ì‹œ ì¶”ê°€</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ëŒ€ëŸ‰ ë“±ë¡ íŒ¨ë„ -->
              <div id="bulk-panel" class="card" style="display:none; margin-bottom:20px;">
                <h3 style="font-size:16px; font-weight:600; margin-bottom:12px; color:var(--text);">ğŸ“¤ ì—‘ì…€ ëŒ€ëŸ‰ë“±ë¡</h3>
                <div class="muted" style="margin-bottom:12px; font-size:13px;">ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”. í—¤ë”: ê±°ë˜ì²˜, ìƒí’ˆëª…,
                  ìœ í˜•(ê³µë€/ì €ì¥/íŠ¸ë˜í”½), ë‹¨ê°€, ê³„ì¢Œ, ì€í–‰, ì˜ˆê¸ˆì£¼</div>
                <div class="stack" style="gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px;">
                  <input id="bulk-file" type="file" accept=".xlsx" style="padding:8px;" />
                  <button id="bulk-upload" class="btn btn-primary btn-sm">ğŸ“¤ ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸°</button>
                  <button id="bulk-apply-xlsx" class="btn btn-success btn-sm">âœ… ì¼ê´„ ì¶”ê°€/ë³‘í•©</button>
                  <span id="bulk-status" class="muted" style="font-size:12px; font-weight:500;"></span>
                </div>
                <div style="overflow-x:auto; border:1px solid var(--line); border-radius:8px; max-height:320px;">
                  <table id="tbl-bulk" class="dense sticky" style="width:100%; min-width:900px;">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>ê±°ë˜ì²˜</th>
                        <th>ìƒí’ˆëª…</th>
                        <th>ìœ í˜•</th>
                        <th>ë‹¨ê°€</th>
                        <th>ê³„ì¢Œ</th>
                        <th>ì€í–‰</th>
                        <th>ì˜ˆê¸ˆì£¼</th>
                        <th>ìƒíƒœ</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <!-- ë‹¨ê°€ ëª©ë¡ -->
              <div class="card">
                <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:12px;">
                  <h3 style="font-size:16px; font-weight:600; color:var(--text); margin:0;">ğŸ“‹ ë“±ë¡ëœ ë‹¨ê°€ ëª©ë¡</h3>
                  <div style="flex:1; max-width:300px;">
                    <input id="pb-search" type="text" placeholder="ğŸ” ê±°ë˜ì²˜/ìƒí’ˆ ê²€ìƒ‰..." style="width:100%;" />
                  </div>
                </div>
                <div style="overflow-x:auto; border:1px solid var(--line); border-radius:8px; max-height:500px;">
                  <table id="tbl-price" class="dense sticky" style="width:100%; min-width:900px;">
                    <thead>
                      <tr>
                        <th>ê±°ë˜ì²˜</th>
                        <th>ìƒí’ˆëª…</th>
                        <th>ìœ í˜•</th>
                        <th>ë‹¨ê°€</th>
                        <th>ê³„ì¢Œ</th>
                        <th>ì€í–‰</th>
                        <th>ì˜ˆê¸ˆì£¼</th>
                        <th>ê´€ë¦¬</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- í¬ë¦¼2 ë°°í¬ ê³„ì • ê´€ë¦¬ -->
            <div class="card" style="margin-top:20px;">
              <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3 style="font-size:16px; font-weight:600; color:var(--text); margin:0;">ğŸ¯ í¬ë¦¼2 ë°°í¬(ìºë¦¬ ë°°í¬2) ê³„ì • ê´€ë¦¬</h3>
              </div>

              <!-- ì‹ ê·œ ê³„ì • ë“±ë¡ -->
              <div class="panel" style="background:var(--bg); margin-bottom:16px;">
                <div
                  style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:12px;">
                  <div>
                    <label>ê±°ë˜ì²˜(ëŒ€í–‰ì‚¬ëª…) *</label>
                    <input id="cream2-client" type="text" placeholder="ì˜ˆ: ì—”í‹°ì œì»´í¼ë‹ˆ" style="width:100%;" />
                  </div>
                  <div>
                    <label>ê³„ì • ì•„ì´ë”” *</label>
                    <input id="cream2-account" type="text" placeholder="ì˜ˆ: dngus286" style="width:100%;" />
                  </div>
                  <div>
                    <label>ë‹¨ê°€(í¬ì¸íŠ¸ í™˜ì‚°) *</label>
                    <input id="cream2-price" type="number" placeholder="ì˜ˆ: 650" style="width:100%;" />
                  </div>
                </div>
                <div class="btn-group">
                  <button id="cream2-add" class="btn btn-primary" type="button">â• ì¶”ê°€</button>
                  <button id="btn-save-cream2" class="btn btn-success">ğŸ’¾ ì €ì¥</button>
                </div>
              </div>

              <!-- ê³„ì • ëª©ë¡ -->
              <div style="overflow-x:auto; border:1px solid var(--line); border-radius:8px; max-height:300px;">
                <table id="tbl-cream2" class="dense sticky" style="width:100%; min-width:600px;">
                  <thead>
                    <tr>
                      <th>ê±°ë˜ì²˜</th>
                      <th>ê³„ì • ì•„ì´ë””</th>
                      <th>ë‹¨ê°€</th>
                      <th>ê´€ë¦¬</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="muted" style="margin-top:8px; font-size:12px;">
                â„¹ï¸ ê¸°ë³¸ ê³„ì •: kimcy1388 (ë‹¨ê°€: 550ì›) - ë“±ë¡ë˜ì§€ ì•Šì€ ê±°ë˜ì²˜ëŠ” ìë™ìœ¼ë¡œ ê¸°ë³¸ ê³„ì • ì‚¬ìš©
              </div>
            </div>

          </div>
          <!-- ë‹¨ê°€ ê´€ë¦¬ íƒ­ ì½˜í…ì¸  ë -->

          <!-- ëŒ€í–‰ì‚¬ ì¡°íšŒ íƒ­ ì½˜í…ì¸  -->
          <div id="agency-content" style="display:none;">
            <div class="section">
              <div class="section-header">
                <h2 class="section-title">ğŸ’¼ ëŒ€í–‰ì‚¬ íŒë§¤ ë‹¨ê°€ ê´€ë¦¬</h2>
                <div class="btn-group">
                  <button id="btn-save-agency-pricing" class="btn btn-success btn-sm">ğŸ’¾ ì €ì¥</button>
                </div>
              </div>

              <!-- ì„¤ëª… -->
              <div class="card"
                style="margin-bottom:20px; background:linear-gradient(135deg, #667eea10, #764ba210); border-left:4px solid #667eea;">
                <div style="font-size:14px; color:var(--text);">
                  ğŸ“Œ <strong>ëŒ€í–‰ì‚¬ íŒë§¤ ë‹¨ê°€</strong>: ëŒ€í–‰ì‚¬ë“¤ì´ ìš°ë¦¬ì—ê²Œ ì ‘ìˆ˜í•  ë•Œ ì ìš©ë˜ëŠ” ë‹¨ê°€ì…ë‹ˆë‹¤.
                  <span class="muted" style="display:block; margin-top:4px; font-size:12px;">
                    (ë‹¨ê°€ ê´€ë¦¬ íƒ­ = ìš°ë¦¬ê°€ ê³µê¸‰ì‚¬ì— ì§€ë¶ˆí•˜ëŠ” ë¹„ìš© / ì´ íƒ­ = ëŒ€í–‰ì‚¬ê°€ ìš°ë¦¬ì—ê²Œ ì§€ë¶ˆí•˜ëŠ” ë§¤ì¶œ)
                  </span>
                </div>
              </div>

              <!-- ì‹ ê·œ ë“±ë¡ í¼ -->
              <div class="card" style="margin-bottom:20px;">
                <h3 style="font-size:16px; font-weight:600; margin-bottom:16px; color:var(--text);">â• ë‹¨ê°€ ë“±ë¡/ìˆ˜ì •</h3>

                <!-- ë¹ ë¥¸ ìƒí’ˆ ì„ íƒ (ë‹¨ê°€ ê´€ë¦¬ íƒ­ì—ì„œ ê°€ì ¸ì˜¤ê¸°) -->
                <div
                  style="margin-bottom:16px; padding:12px; background:var(--bg); border-radius:8px; border:1px dashed var(--line);">
                  <label style="font-weight:600; color:var(--primary);">ğŸ“¦ ë‹¨ê°€ ê´€ë¦¬ì—ì„œ ìƒí’ˆ ê°€ì ¸ì˜¤ê¸°</label>
                  <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
                    <select id="ap-pricebook-select"
                      style="flex:1; min-width:200px; padding:8px; border:1px solid var(--line); border-radius:6px;">
                      <option value="">-- ìƒí’ˆ ì„ íƒ --</option>
                    </select>
                    <button id="ap-import-product" class="btn btn-outline btn-sm">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
                  </div>
                </div>

                <div
                  style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:12px; margin-bottom:12px;">
                  <div>
                    <label>ëŒ€í–‰ì‚¬ëª… *</label>
                    <input id="ap-agency" type="text" placeholder="ì˜ˆ: ì• ë“œí—ˆë¸Œ..." list="ap-agency-list"
                      style="width:100%;" />
                    <datalist id="ap-agency-list"></datalist>
                  </div>
                  <div>
                    <label>ìƒí’ˆëª… *</label>
                    <input id="ap-product" type="text" placeholder="ì˜ˆ: í”Œë ˆì´ìŠ¤..." list="ap-product-list"
                      style="width:100%;" />
                    <datalist id="ap-product-list"></datalist>
                  </div>
                  <div>
                    <label>ìœ í˜•</label>
                    <select id="ap-type"
                      style="width:100%; padding:8px; border:1px solid var(--line); border-radius:6px;">
                      <option value="ê³µí†µ">ê³µí†µ</option>
                      <option value="ì €ì¥">ì €ì¥</option>
                      <option value="íŠ¸ë˜í”½">íŠ¸ë˜í”½</option>
                    </select>
                  </div>
                  <div>
                    <label>íŒë§¤ ë‹¨ê°€ (ì›)</label>
                    <input id="ap-price" type="number" placeholder="50000" style="width:100%;" />
                  </div>
                  <div>
                    <label>ë©”ëª¨</label>
                    <input id="ap-memo" type="text" placeholder="ë¹„ê³ ..." style="width:100%;" />
                  </div>
                </div>
                <div class="btn-group">
                  <button id="ap-add-btn" class="btn btn-primary btn-sm">â• ì¶”ê°€</button>
                  <button id="ap-clear-btn" class="btn btn-secondary btn-sm">ğŸ”„ ì´ˆê¸°í™”</button>
                </div>
              </div>

              <!-- ê²€ìƒ‰/í•„í„° ì˜ì—­ -->
              <div class="card" style="margin-bottom:20px;">
                <div
                  style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:16px;">
                  <div>
                    <label>ëŒ€í–‰ì‚¬ëª… ê²€ìƒ‰</label>
                    <input id="agency-search-client" type="text" placeholder="ëŒ€í–‰ì‚¬ëª… ì…ë ¥..." style="width:100%;" />
                  </div>
                  <div>
                    <label>ìƒí’ˆëª… ê²€ìƒ‰</label>
                    <input id="agency-search-product" type="text" placeholder="ìƒí’ˆëª… ì…ë ¥..." style="width:100%;" />
                  </div>
                  <div style="display:flex; align-items:flex-end; gap:8px;">
                    <button id="btn-agency-search" class="btn btn-primary">ğŸ” ê²€ìƒ‰</button>
                    <button id="btn-agency-reset" class="btn btn-secondary">ğŸ”„ ì´ˆê¸°í™”</button>
                  </div>
                </div>

                <!-- ë¹ ë¥¸ ëŒ€í–‰ì‚¬ ì„ íƒ ì¹© -->
                <div style="margin-top:12px;">
                  <label style="margin-bottom:8px;">ìì£¼ ì°¾ëŠ” ëŒ€í–‰ì‚¬</label>
                  <div id="agency-chips" class="chips" style="margin-top:8px;"></div>
                </div>
              </div>

              <!-- í†µê³„ ìš”ì•½ -->
              <div style="display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap;">
                <div class="card stat-card"
                  style="flex:1; min-width:150px; padding:16px; border-left:4px solid var(--primary);">
                  <div class="stat-label">ë“±ë¡ëœ ëŒ€í–‰ì‚¬</div>
                  <div class="stat-value" style="font-size:28px;" id="stat-agency-count">0</div>
                </div>
                <div class="card stat-card"
                  style="flex:1; min-width:150px; padding:16px; border-left:4px solid var(--success);">
                  <div class="stat-label">ë“±ë¡ëœ ìƒí’ˆ</div>
                  <div class="stat-value" style="font-size:28px;" id="stat-product-count">0</div>
                </div>
                <div class="card stat-card"
                  style="flex:1; min-width:150px; padding:16px; border-left:4px solid var(--warning);">
                  <div class="stat-label">ê²€ìƒ‰ ê²°ê³¼</div>
                  <div class="stat-value" style="font-size:28px;" id="stat-search-result">0</div>
                </div>
              </div>

              <!-- ê²°ê³¼ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
              <div id="agency-results" class="grid grid-2" style="margin-bottom:20px;"></div>

              <!-- ì „ì²´ ëª©ë¡ í…Œì´ë¸” -->
              <div class="card" style="margin-top:20px;">
                <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:12px;">
                  <h3 style="font-size:16px; font-weight:600; color:var(--text); margin:0;">ğŸ“‹ ë“±ë¡ëœ ë‹¨ê°€ ëª©ë¡</h3>
                </div>
                <div style="overflow-x:auto; border:1px solid var(--line); border-radius:8px; max-height:500px;">
                  <table id="tbl-agency-view" class="dense sticky" style="width:100%; min-width:600px;">
                    <thead>
                      <tr>
                        <th style="cursor:pointer;" onclick="sortAgencyTable('agency')">ëŒ€í–‰ì‚¬ â‡…</th>
                        <th style="cursor:pointer;" onclick="sortAgencyTable('product')">ìƒí’ˆëª… â‡…</th>
                        <th style="cursor:pointer;" onclick="sortAgencyTable('type')">ìœ í˜• â‡…</th>
                        <th style="cursor:pointer;" onclick="sortAgencyTable('price')">íŒë§¤ ë‹¨ê°€ â‡…</th>
                        <th>ë©”ëª¨</th>
                        <th>ê´€ë¦¬</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <!-- ëŒ€í–‰ì‚¬ ì¡°íšŒ íƒ­ ì½˜í…ì¸  ë -->

          <!-- 3) ì •ì‚° ë¯¸ë¦¬ë³´ê¸°(í˜ì´ì§€ í•˜ë‹¨ í‘œì‹œ) -->
          <!-- ì‚¬ì „ ì ê²€ íŒ¨ë„: ë¯¸ì • ë‹¨ê°€ / ì¶”ê°€ ì§€ì¶œ -->
          <div class="section" id="precheck-section" style="display:none;">
            <div class="section-header">
              <h2 class="section-title">ğŸ” ì‚¬ì „ ì ê²€</h2>
            </div>
            <div id="precheck-panel" class="card">
              <div class="grid">
                <div class="panel">
                  <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:6px">
                    <div class="muted" style="font-weight:600;">ì‹ ê·œ ìƒí’ˆ</div>
                    <button id="btn-apply-missing" class="btn btn-primary btn-sm">ì¶”ê°€</button>
                  </div>
                  <div style="overflow-x:auto; max-height:300px;">
                    <table class="mini" style="width:100%; min-width:600px;">
                      <thead>
                        <tr>
                          <th>ë°˜ì˜</th>
                          <th>ëŒ€í–‰ì‚¬</th>
                          <th>ìƒí’ˆëª…</th>
                          <th>ìœ í˜•</th>
                          <th>ìˆ˜ëŸ‰ í•©ê³„</th>
                          <th>ë‹¨ê°€(ì…ë ¥)</th>
                        </tr>
                      </thead>
                      <tbody id="tbl-missing-body"></tbody>
                    </table>
                  </div>
                </div>
                <div class="panel">
                  <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:6px">
                    <div class="muted" style="font-weight:600;">ì¶”ê°€ ì§€ì¶œ</div>
                    <div class="stack" style="gap:6px">
                      <button id="btn-add-extra" class="btn btn-sm btn-secondary">í–‰ ì¶”ê°€</button>
                      <button id="btn-save-extra" class="btn btn-primary btn-sm">ì¶”ê°€ ì§€ì¶œ ì €ì¥</button>
                    </div>
                  </div>
                  <div style="overflow-x:auto; max-height:300px;">
                    <table class="mini" style="width:100%; min-width:600px;">
                      <thead>
                        <tr>
                          <th>ë°˜ì˜</th>
                          <th>ë‚ ì§œ</th>
                          <th>ëŒ€í–‰ì‚¬</th>
                          <th>ìƒí’ˆ</th>
                          <th>ê¸ˆì•¡</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody id="tbl-extra-body"></tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="stack" style="justify-content:flex-end; margin-top:8px">
                <button id="btn-finalize" class="btn btn-primary">âœ… ìµœì¢… ë°˜ì˜</button>
              </div>
            </div>
          </div>

          <!-- ê²°ê³¼ íŒ¨ë„ -->
          <div class="section" id="results-section" style="display:none;">
            <div class="section-header">
              <h2 class="section-title">ğŸ“Š ì •ì‚° ê²°ê³¼</h2>
            </div>
            <div id="results-panel" class="card">
              <div style="margin-bottom:16px;">
                <div class="stack" style="gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap;">
                  <label class="muted" style="display:flex; align-items:center; gap:6px; font-weight:500;"><input
                      type="checkbox" id="cb-guarantee" style="width:16px; height:16px;"> ë³´ì¥í˜•</label>
                  <label class="muted" style="display:flex; align-items:center; gap:6px; font-weight:500;"><input
                      type="checkbox" id="cb-manage" style="width:16px; height:16px;"> ê´€ë¦¬í˜•</label>
                  <label class="muted" style="display:flex; align-items:center; gap:6px; font-weight:500;"><input
                      type="checkbox" id="cb-mincom" style="width:16px; height:16px;"> ë¯¼ì»´&ê¶ì„œ</label>
                  <span id="agg-total-badge" class="pill" style="font-weight:600;"></span>
                </div>
                <div class="stack" style="gap:8px; flex-wrap:wrap;">
                  <button id="btn-toggle-collapse" class="btn btn-sm btn-secondary">ì „ì²´ ì ‘ê¸°</button>
                  <button id="btn-delete-toggle" class="btn btn-sm btn-secondary" title="ê²°ì¬ì„  ë°˜ì˜ì—ì„œ íŠ¹ì • ê±´ ì œì™¸">ì‚­ì œ</button>
                  <button id="btn-finalize-wizard" class="btn btn-accent" title="ìµœì¢… ë³´ê³  ìƒì„±">ğŸ¯ ìµœì¢… ì •ì‚°</button>
                  <button id="btn-cream2-message" class="btn btn-success" title="í¬ë¦¼2 ë°°í¬ í¬ì¸íŠ¸ ì¶©ì „ ë©”ì‹œì§€">ğŸ¯ í¬ë¦¼2 ë°°í¬</button>
                </div>
              </div>
              <!-- ìƒí’ˆë³„ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
              <div id="cards-container" class="cards"></div>
              <!-- ìƒí’ˆë³„ ë³´ê¸° -->
              <div style="overflow-x:auto; margin-top:16px;">
                <table id="tbl-product" style="width:100%; display:none; min-width:800px;">
                  <thead>
                    <tr>
                      <th>ë‚ ì§œ</th>
                      <th>ìƒí’ˆëª…</th>
                      <th>ì´ ì ‘ìˆ˜ëŸ‰</th>
                      <th>ì§€ì¶œ</th>
                      <th>ë§¤ì¶œ</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <!-- ëŒ€í–‰ì‚¬ë³„ ë³´ê¸° -->
              <div style="overflow-x:auto; margin-top:16px;">
                <table id="tbl-agency" style="width:100%; display:none; min-width:1000px;">
                  <thead>
                    <tr>
                      <th>ë‚ ì§œ</th>
                      <th>ëŒ€í–‰ì‚¬</th>
                      <th>ìƒí’ˆëª…</th>
                      <th>ìœ í˜•</th>
                      <th>ìˆ˜ëŸ‰</th>
                      <th>ë‹¨ê°€</th>
                      <th>ì§€ì¶œ</th>
                      <th>ë§¤ì¶œ</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div class="overlay" id="overlay">
    <div class="center"
      style="background:#fff; border-radius:16px; padding:32px; box-shadow:0 8px 24px rgba(0,0,0,.15);">
      <div class="spinner"></div>
      <div style="color:var(--text); font-weight:500; margin-bottom:8px;" id="progress-text">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      <div class="progress">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
    </div>
  </div>

  <!-- í¬ë¦¼2 ë°°í¬ ë©”ì‹œì§€ ëª¨ë‹¬ -->
  <div class="modal" id="cream2-modal">
    <div class="modal-content" style="max-width:700px;">
      <div class="modal-header">
        <h3 class="modal-title">ğŸ¯ í¬ë¦¼2 ë°°í¬ í¬ì¸íŠ¸ ì¶©ì „ ë©”ì‹œì§€</h3>
        <button class="btn btn-sm btn-secondary" onclick="closeCream2Modal()">âœ•</button>
      </div>
      <div class="modal-body" style="padding:20px; background:var(--bg);">
        <div id="cream2-content" style="font-family:'Malgun Gothic', sans-serif; font-size:13px; line-height:1.6;">
          <div style="text-align:center; padding:40px; color:var(--muted);">
            <div>ìºë¦¬ ë°°í¬2 í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="btn-copy-cream2" onclick="copyCream2ToClipboard()">ğŸ“‹
          ë³µì‚¬</button>
        <button type="button" class="btn btn-secondary" onclick="closeCream2Modal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
    async function loadUserInfo() {
      try {
        const res = await fetch('/api/auth/me');
        if (res.ok) {
          const data = await res.json();
          const user = data.user;
          if (user) {
            const nameEl = document.getElementById('user-name');
            const roleEl = document.getElementById('user-role');
            if (nameEl) nameEl.textContent = user.name || user.username;
            if (roleEl) {
              const roleNames = { admin: 'ê´€ë¦¬ì', manager: 'ë§¤ë‹ˆì €', user: 'ì¼ë°˜' };
              roleEl.textContent = roleNames[user.role] || user.role;
            }
          }
        }
      } catch (e) { console.warn('User info load error:', e); }
    }

    // ë¡œê·¸ì•„ì›ƒ
    async function logout() {
      try {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.href = '/login';
      } catch (e) {
        window.location.href = '/login';
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', loadUserInfo);

    // ìƒíƒœ ì €ì¥ì†Œ (ì„ì‹œ: í´ë¼ì´ì–¸íŠ¸ ë©”ëª¨ë¦¬)
    const state = {
      tabs: [], // ì‹œíŠ¸ íƒ­ëª…
      selectedTabs: [], // ì„ íƒëœ íƒ­
      priceBook: [], // { client, product, price, account }
      agencyPricing: [], // ëŒ€í–‰ì‚¬ íŒë§¤ ë‹¨ê°€ { agency, product, price, memo }
      previewRows: [], // { date, client, agency, product, qty, price, amount }
      lastAggregates: null, // ë§ˆì§€ë§‰ ê³„ì‚° aggregates ê·¸ëŒ€ë¡œ ë³´ê´€
      missingPrices: [], // compute ì‘ë‹µì˜ missing_prices
      extraExpenses: [], // [{date,client,product,amount,report}]
      unpaidReceivables: {}, // { agency: amount }
      cream2Accounts: [], // [{ client, account_id, unit_price }]
      exclusions: { products: [], rows: [] } // ê²°ì¬ì„  ë°˜ì˜ ì œì™¸ ì„¸íŠ¸
    };
    state.wizard = { step: 1, receivables: [], payables: [], categories: {}, custom: {}, reportDate: '', vendorOrder: [] };

    const $ = (s) => document.querySelector(s);
    const overlay = document.getElementById('overlay');
    const pbar = document.getElementById('progress-bar');
    const ptxt = document.getElementById('progress-text');
    // ë¯¸ë¦¬ë³´ê¸°ëŠ” í•˜ë‹¨ íŒ¨ë„ ì‚¬ìš©

    function showLoading(msg) { overlay.style.display = 'flex'; if (ptxt) ptxt.textContent = msg || 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'; if (pbar) pbar.style.width = '15%'; }
    function setProgress(pct, msg) { if (pbar) { pbar.style.width = Math.max(0, Math.min(100, pct)) + '%'; } if (msg && ptxt) { ptxt.textContent = msg; } }
    function hideLoading() { overlay.style.display = 'none'; if (pbar) pbar.style.width = '0%'; }
    // ì „ì—­ ì•ˆì „ì¥ì¹˜: ì˜ˆì™¸ ë°œìƒ/ë¡œë“œ ì™„ë£Œ ì‹œ ì˜¤ë²„ë ˆì´ ê°•ì œ í•´ì œ
    window.addEventListener('error', () => { try { hideLoading(); } catch (e) { } }, { once: false });
    window.addEventListener('load', () => { try { hideLoading(); } catch (e) { } });

    // ê°„ë‹¨ í† ìŠ¤íŠ¸
    function toast(msg) {
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = msg || 'ì €ì¥ë¨';
      t.classList.add('show');
      setTimeout(() => { t.classList.remove('show'); }, 2000);
    }

    async function savePriceBook() {
      showLoading('ë‹¨ê°€í‘œ ì €ì¥ ì¤‘...');
      try {
        const res = await fetch('/api/settlement/pricebook', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items: state.priceBook }) });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || 'ì €ì¥ ì‹¤íŒ¨');
        toast('ì €ì¥ë¨');
      } catch (e) { alert(e.message || 'ì €ì¥ ì‹¤íŒ¨'); }
      finally { hideLoading(); }
    }

    // 1) íƒ­ ë¶ˆëŸ¬ì˜¤ê¸° (API ì—°ë™ ì˜ˆì •)
    const loadTabsBtn = document.getElementById('load-tabs'); if (loadTabsBtn) loadTabsBtn.addEventListener('click', async () => {
      showLoading('íƒ­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
      try {
        const res = await fetch('/api/settlement/tabs');
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || 'íƒ­ ì¡°íšŒ ì‹¤íŒ¨');
        state.tabs = Array.isArray(data.tabs) ? data.tabs : [];
        renderTabChips();
        $('#tab-count').textContent = `${state.tabs.length}ê°œ`;
        setProgress(100, 'ì™„ë£Œ');
      } catch (e) { alert(e.message || 'íƒ­ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'); }
      finally { hideLoading(); }
    });

    function renderTabChips() {
      const wrap = document.getElementById('tab-chips');
      if (!wrap) return;
      wrap.innerHTML = '';
      state.tabs.forEach(tab => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'chip';
        btn.textContent = tab;
        const active = state.selectedTabs.includes(tab);
        if (active) btn.classList.add('active');
        btn.addEventListener('click', () => {
          const i = state.selectedTabs.indexOf(tab);
          if (i >= 0) state.selectedTabs.splice(i, 1); else state.selectedTabs.push(tab);
          renderTabChips();
        });
        wrap.appendChild(btn);
      });
    }

    // ê¸°ê°„ ì„ íƒ ì œê±°ë¨

    // í†µê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateSettleStats() {
      try {
        // ì„ íƒëœ íƒ­ ìˆ˜
        document.getElementById('stat-selected-tabs').textContent = state.selectedTabs.length;

        // ì´ ê±°ë˜ì²˜ ìˆ˜ (ì¤‘ë³µ ì œê±°)
        const clientSet = new Set();
        state.previewRows.forEach(r => { if (r.client) clientSet.add(r.client); });
        document.getElementById('stat-total-clients').textContent = clientSet.size;

        // ì´ ì§€ì¶œ (VAT í¬í•¨: x1.1)
        const totalExpense = state.previewRows.reduce((sum, r) => sum + (r.expense || 0), 0);
        const totalExpenseVAT = Math.round(totalExpense * 1.1);
        document.getElementById('stat-total-expense').textContent = totalExpenseVAT.toLocaleString();

        // ë¯¸ì • ë‹¨ê°€ ê±´ìˆ˜
        document.getElementById('stat-missing-prices').textContent = (state.missingPrices || []).length;

        // í†µê³„ ì„¹ì…˜ í‘œì‹œ (ë°ì´í„° ìˆìŒ í‘œì‹œ)
        const statsSection = document.getElementById('settle-stats-section');
        if (statsSection) {
          statsSection.dataset.hasData = 'true';
          statsSection.style.display = 'block';
        }
      } catch (e) {
        console.error('Stats update error:', e);
      }
    }

    // 2) ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const fetchBtn = document.getElementById('fetch-data'); if (fetchBtn) fetchBtn.addEventListener('click', async () => {
      showLoading('ì •ì‚° ë°ì´í„°ë¥¼ ì¤€ë¹„ ì¤‘...'); setProgress(25);
      try {
        const res = await fetch('/api/settlement/compute', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tabs: state.selectedTabs }) });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || 'ì§‘ê³„ ì‹¤íŒ¨');
        // data.rows: {date, client, job, type, qty, unit_price, expense, income, agency}
        const rows = Array.isArray(data.rows) ? data.rows : [];
        state.previewRows = rows.map(r => ({ date: r.date, client: r.client, product: (r.type ? `${r.job} ${r.type}` : r.job), qty: r.qty, price: r.unit_price, expense: r.expense || 0, income: r.income || 0, agency: r.agency || r.client }));
        state.lastAggregates = data?.aggregates || {};
        state.missingPrices = Array.isArray(data?.missing_prices) ? data.missing_prices : [];
        state.unpaidReceivables = data?.unpaid_receivables || {};
        await loadExtras();

        // ëŒ€í–‰ì‚¬ íŒë§¤ ë‹¨ê°€ ìë™ ë™ê¸°í™” ì²´í¬
        await checkAgencyPricingSync(rows);

        updateSettleStats(); // í†µê³„ ì—…ë°ì´íŠ¸
        renderPrecheck();
        renderPreview();
        renderAggregates(augmentAggregatesWithExtras(state.lastAggregates, state.extraExpenses));
        // ìµœì¢… ë°˜ì˜ ì „ì—ëŠ” ê²°ê³¼ íŒ¨ë„ ìˆ¨ê¹€, ì‚¬ì „ ì ê²€ë§Œ ë…¸ì¶œ
        const preSection = document.getElementById('precheck-section');
        const resSection = document.getElementById('results-section');
        if (window.__finalizing === true) { if (preSection) preSection.style.display = 'none'; if (resSection) resSection.style.display = 'block'; window.__finalizing = false; }
        else { if (preSection) preSection.style.display = 'block'; if (resSection) resSection.style.display = 'none'; }
        // ì •ì‚° íƒ­ ìƒíƒœ ê°•ì œ ìœ ì§€
        try { setTab('settle'); } catch (e) { }
        setPvTab();
      } catch (e) { alert(e.message || 'ì§‘ê³„ ì‹¤íŒ¨'); }
      finally { setProgress(100, 'ì™„ë£Œ'); hideLoading(); }
    });

    function renderAggregates(aggs) {
      try {
        // ìƒí’ˆë³„ ë‹¨ì¼ ë·° ì¹´ë“œ ë Œë”ë§ (ë‚ ì§œ ë¬´ì‹œ: ë™ì¼ ìƒí’ˆì€ í•©ì‚°)
        const cards = document.getElementById('cards-container');
        if (!cards) return;
        cards.innerHTML = '';
        const filterGuarantee = window.__filterGuarantee === true;
        const filterManage = window.__filterManage === true;
        const filterMincom = window.__filterMincom === true;
        const mincomClients = ['ë¯¼ì»´í¼ë‹ˆ', 'ê¶ì„œì• ë“œ'];
        const onlyMincomMode = filterMincom && !filterGuarantee && !filterManage;
        const noFilter = !filterGuarantee && !filterManage && !filterMincom;
        // 1) ìƒí’ˆë³„ ì´í•© ì§‘ê³„ (ëª¨ë“  ë‚ ì§œ í•©ì‚°)
        const totalByProduct = {}; let grandTotal = 0;
        Object.entries(aggs?.by_product || {}).forEach(([date, prods]) => {
          Object.entries(prods || {}).forEach(([prod, v]) => {
            const acc = totalByProduct[prod] || { qty: 0, expense: 0, income: 0 };
            acc.qty += v.qty || 0; acc.expense += v.expense || 0; acc.income += v.income || 0; totalByProduct[prod] = acc;
          });
        });

        // 2) ìƒí’ˆë³„ ì¹´ë“œ ìƒì„± + ëŒ€í–‰ì‚¬ë³„ ìƒì„¸(ëª¨ë“  ë‚ ì§œ í¬í•¨)
        const byAgencyAllDates = aggs?.by_agency || {};
        Object.keys(totalByProduct).sort().forEach(prod => {
          // ì „ì²´ ìƒí’ˆ ì œì™¸ ì²˜ë¦¬
          try { if (Array.isArray(state.exclusions?.products) && state.exclusions.products.includes(prod)) { return; } } catch (e) { }
          // í•„í„°ë³„ ì¹´ë“œ ì¬ì§‘ê³„
          const rawS = totalByProduct[prod];
          let cardQty = 0, cardExpense = 0, cardIncome = 0, hasMatch = false;
          Object.keys(byAgencyAllDates).forEach(date => {
            const map = byAgencyAllDates[date] || {};
            Object.keys(map).forEach(client => {
              const arr = map[client] || [];
              arr.filter(it => (it.product || '') === prod).forEach(it => {
                const itype = it.internal_type || null;
                const isGuarantee = itype === 'guarantee';
                const isManage = itype === 'manage';
                const isMincom = mincomClients.includes(client);
                let pass = true;
                if (filterGuarantee && !isGuarantee) pass = false;
                if (filterManage && !isManage) pass = false;
                if (filterMincom && !isMincom) pass = false;
                if (onlyMincomMode && !isGuarantee) pass = false; // ë¯¼ì»´ ì „ìš© ëª¨ë“œì—ì„œëŠ” ë³´ì¥í˜•ë§Œ í—ˆìš©
                if (filterGuarantee && isMincom) pass = false; // ë³´ì¥í˜• ëª¨ë“œì—ì„œëŠ” ë¯¼ì»´/ê¶ì„œ ì œì™¸
                // í–‰ ë‹¨ìœ„ ì œì™¸
                try {
                  const rowKey = `${date}|||${client}|||${prod}|||${it.type || ''}|||${Number(it.qty || 0)}|||${Number(it.unit_price || 0)}|||${Number(it.expense || 0)}`;
                  if (Array.isArray(state.exclusions?.rows) && state.exclusions.rows.includes(rowKey)) pass = false;
                } catch (e) { }
                if (!pass) return;
                hasMatch = true; cardQty += it.qty || 0; cardExpense += it.expense || 0; cardIncome += it.income || 0;
              });
            });
          });
          if ((filterGuarantee || filterManage || filterMincom) && !hasMatch) return; // í•„í„° ì‹œ ë§¤ì¹­ ì—†ìœ¼ë©´ ì¹´ë“œ ìˆ¨ê¹€
          const s = (filterGuarantee || filterManage || filterMincom) ? { qty: cardQty, expense: cardExpense, income: cardIncome } : rawS;
          grandTotal += s.expense || 0;
          const showIncome = !(filterGuarantee || filterManage || filterMincom);
          const card = document.createElement('div'); card.className = 'card';
          card.innerHTML = `
              <div class="card-hd mini">
                <div style="display:flex; align-items:center; gap:8px">
                  ${window.__deleteMode ? `<input type="checkbox" class="chk-del-prod" data-del-prod data-product="${prod}">` : ''}
                  <b>${prod}</b>
                </div>
                <div class="muted">ì´ ì„¸íŒ… ${Number(s.qty || 0).toLocaleString()} Â· ì§€ì¶œ ${Number(s.expense || 0).toLocaleString()}${showIncome ? ' Â· ë§¤ì¶œ ' + Number(s.income || 0).toLocaleString() : ''}</div>
              </div>
              <div class="card-bd" style="overflow:auto">
                <table class="mini" style="width:100%">
                  <thead><tr>${window.__deleteMode ? '<th style="width:36px">ì œì™¸</th>' : ''}<th>ë‚ ì§œ</th><th>ëŒ€í–‰ì‚¬</th><th>ìœ í˜•</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>ì§€ì¶œ</th>${showIncome ? '<th>ë§¤ì¶œ</th>' : ''}</tr></thead>
                  <tbody data-body></tbody>
                </table>
              </div>`;
          const tbody = card.querySelector('[data-body]');
          Object.keys(byAgencyAllDates).sort().forEach(date => {
            const map = byAgencyAllDates[date] || {};
            Object.keys(map).sort().forEach(client => {
              const arr = map[client] || [];
              arr.filter(it => (it.product || '') === prod).forEach(it => {
                const itype = it.internal_type || null;
                const isGuarantee = itype === 'guarantee';
                const isManage = itype === 'manage';
                const isMincom = mincomClients.includes(client);
                let pass = true;
                if (filterGuarantee && !isGuarantee) pass = false;
                if (filterManage && !isManage) pass = false;
                if (filterMincom && !isMincom) pass = false;
                if (onlyMincomMode && !isGuarantee) pass = false; // ë¯¼ì»´ ì „ìš© ëª¨ë“œì—ì„œëŠ” ë³´ì¥í˜•ë§Œ í—ˆìš©
                if (filterGuarantee && isMincom) pass = false; // ë³´ì¥í˜• ëª¨ë“œì—ì„œëŠ” ë¯¼ì»´/ê¶ì„œ ì œì™¸
                // í–‰ ë‹¨ìœ„ ì œì™¸
                let rowKey = '';
                try { rowKey = `${date}|||${client}|||${prod}|||${it.type || ''}|||${Number(it.qty || 0)}|||${Number(it.unit_price || 0)}|||${Number(it.expense || 0)}`; if (Array.isArray(state.exclusions?.rows) && state.exclusions.rows.includes(rowKey)) pass = false; } catch (e) { }
                if (!pass) return;
                const tr = document.createElement('tr');
                const incomeCell = it.income || 0;
                // í–‰ ì „ì²´ ë°°ê²½ ì²˜ë¦¬: ë¯¼ì»´ ì „ìš© ë˜ëŠ” ê¸°ë³¸(ë¬´í•„í„°)ì—ì„œ ë¯¼ì»´&ê¶ì„œ ë³´ì¥í˜•ì€ íŒŒë€ìƒ‰
                let rowBg = '';
                if ((filterMincom || noFilter) && isMincom && isGuarantee) rowBg = '#e0f2fe';
                else if (isGuarantee) rowBg = '#fffbe6';
                else if (isManage) rowBg = '#d9ead3';
                if (rowBg) tr.style.background = rowBg;
                tr.innerHTML = `${window.__deleteMode ? `<td style="text-align:center"><input type="checkbox" class="chk-del-row" data-del-row data-rowkey="${rowKey}"></td>` : ''}<td>${date}</td><td>${client}</td><td>${it.type || ''}</td><td>${Number(it.qty || 0).toLocaleString()}</td><td>${Number(it.unit_price || 0).toLocaleString()}</td><td>${Number(it.expense || 0).toLocaleString()}</td>${showIncome ? `<td>${Number(incomeCell || 0).toLocaleString()}</td>` : ''}`;
                tbody.appendChild(tr);
              });
            });
          });
          // ì¶”ê°€ ì§€ì¶œ í–‰(ë³´ê³  ë°˜ì˜ trueë§Œ) í‘œì‹œ
          (state.extraExpenses || []).filter(ex => ex && ex.report && String(ex.product || '') === String(prod || '')).forEach(ex => {
            const tr = document.createElement('tr');
            tr.innerHTML = `${window.__deleteMode ? '<td></td>' : ''}<td>${ex.date || ''}</td><td>${ex.client || ''}</td><td>ì¶”ê°€</td><td>-</td><td>-</td><td>${Number(ex.amount || 0).toLocaleString()}</td>${showIncome ? `<td class="muted">0</td>` : ''}`;
            tbody.appendChild(tr);
          });
          cards.appendChild(card);

          // ì‚­ì œ ëª¨ë“œ: ìƒí’ˆ ì „ì²´ ì„ íƒ â†’ í–‰ ì „ì²´ í† ê¸€
          if (window.__deleteMode) {
            try {
              const prodChk = card.querySelector('input[data-del-prod]');
              if (prodChk) {
                prodChk.addEventListener('change', () => {
                  const rows = card.querySelectorAll('input[data-del-row]');
                  rows.forEach(r => { r.checked = prodChk.checked; });
                });
              }
            } catch (e) { }
          }
        });
        // ì´ê³„ ë±ƒì§€ ì—…ë°ì´íŠ¸
        const badge = document.getElementById('agg-total-badge');
        let badgeBg = '#f6f8fa';
        if (filterGuarantee) badgeBg = '#fffbe6';
        else if (filterManage) badgeBg = '#d9ead3';
        else if (filterMincom) badgeBg = '#e0f2fe';
        if (badge) { badge.textContent = `ì´ ì§€ì¶œ ${grandTotal.toLocaleString()}`; badge.style.background = badgeBg; }
      } catch (e) { }
    }

    // í•„í„° ì²´í¬ë°•ìŠ¤: ë³´ì¥í˜•/ê´€ë¦¬í˜•/ë¯¼ì»´&ê¶ì„œ (ì„œë¡œ ë°°íƒ€ì , ëª¨ë‘ í•´ì œ ê°€ëŠ¥)
    (function () {
      function setFilters(mode) {
        const cbG = document.getElementById('cb-guarantee');
        const cbM = document.getElementById('cb-manage');
        const cbMin = document.getElementById('cb-mincom');
        const g = (mode === 'g'); const m = (mode === 'm'); const min = (mode === 'min');
        window.__filterGuarantee = g; window.__filterManage = m; window.__filterMincom = min;
        if (cbG) cbG.checked = g; if (cbM) cbM.checked = m; if (cbMin) cbMin.checked = min;
        if (state.lastAggregates) { renderAggregates(augmentAggregatesWithExtras(state.lastAggregates, state.extraExpenses)); }
      }
      const cbG = document.getElementById('cb-guarantee'); if (cbG) { cbG.addEventListener('change', () => { setFilters(cbG.checked ? 'g' : null); }); }
      const cbM = document.getElementById('cb-manage'); if (cbM) { cbM.addEventListener('change', () => { setFilters(cbM.checked ? 'm' : null); }); }
      const cbMin = document.getElementById('cb-mincom'); if (cbMin) { cbMin.addEventListener('change', () => { setFilters(cbMin.checked ? 'min' : null); }); }
    })();

    // --- ì‚¬ì „ ì ê²€: ë¯¸ì • ë‹¨ê°€ / ì¶”ê°€ ì§€ì¶œ ---
    function renderPrecheck() {
      // ë¯¸ì • ë‹¨ê°€
      const mb = document.getElementById('tbl-missing-body'); if (mb) {
        mb.innerHTML = '';
        (state.missingPrices || []).forEach(item => {
          const tr = document.createElement('tr');
          const defApply = !!(item && item.job);
          tr.innerHTML = `<td style="text-align:center"><input type="checkbox" data-apply ${defApply ? 'checked' : ''}></td><td>${item.client || ''}</td><td>${item.job || ''}</td><td>${item.type || ''}</td><td>${Number(item.qty_sum || 0).toLocaleString()}</td><td><input type="number" min="0" step="1" style="width:100px" data-mprice></td>`;
          tr.dataset.client = item.client || ''; tr.dataset.product = item.job || ''; tr.dataset.type = item.type || '';
          mb.appendChild(tr);
        });
      }
      // ì¶”ê°€ ì§€ì¶œ
      const eb = document.getElementById('tbl-extra-body'); if (eb) {
        eb.innerHTML = '';
        (state.extraExpenses || []).forEach((ex, idx) => {
          const tr = document.createElement('tr'); tr.dataset.idx = String(idx);
          tr.innerHTML = `
              <td style="text-align:center"><input type="checkbox" ${ex.report ? 'checked' : ''}></td>
              <td><input type="text" value="${ex.date || ''}" style="width:110px"></td>
              <td><input type="text" value="${ex.client || ''}" style="width:120px"></td>
              <td><input type="text" value="${ex.product || ''}" style="width:140px"></td>
              <td><input type="number" step="1" value="${Number(ex.amount || 0)}" style="width:100px"></td>
              <td><button class="btn" data-del>ì‚­ì œ</button></td>`;
          eb.appendChild(tr);
        });
        // ì‚­ì œ ë°”ì¸ë”©
        eb.querySelectorAll('button[data-del]').forEach(btn => {
          btn.addEventListener('click', () => { const tr = btn.closest('tr'); const i = Number(tr?.dataset.idx || -1); if (i >= 0) { state.extraExpenses.splice(i, 1); renderPrecheck(); } });
        });
      }
    }

    async function loadExtras() {
      try { const r = await fetch('/api/settlement/extra'); const d = await r.json().catch(() => ({})); if (r.ok && Array.isArray(d.items)) state.extraExpenses = d.items; else state.extraExpenses = []; }
      catch (e) { state.extraExpenses = []; }
    }
    async function saveExtras() {
      // í…Œì´ë¸”ì˜ í˜„ì¬ ê°’ì„ stateë¡œ ë°˜ì˜ í›„ ì €ì¥
      const eb = document.getElementById('tbl-extra-body'); if (eb) {
        const rows = Array.from(eb.querySelectorAll('tr'));
        state.extraExpenses = rows.map(tr => {
          const inputs = tr.querySelectorAll('input');
          return { date: inputs[0]?.value || '', client: inputs[1]?.value || '', product: inputs[2]?.value || '', amount: Number(inputs[3]?.value || 0), report: !!inputs[4]?.checked };
        });
      }
      try { await fetch('/api/settlement/extra', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items: state.extraExpenses }) }); }
      catch (e) { }
    }
    // ë¯¸ì • ë‹¨ê°€ ì €ì¥ í›„ ì¬ê³„ì‚°
    async function applyMissingPrices() {
      const mb = document.getElementById('tbl-missing-body'); if (!mb) return;
      // ì…ë ¥ëœ ë‹¨ê°€ë§Œ pricebookì— ì¶”ê°€/ê°±ì‹ 
      const rows = Array.from(mb.querySelectorAll('tr'));
      rows.forEach(tr => {
        const price = Number(tr.querySelector('input[data-mprice]')?.value || 0);
        const apply = tr.querySelector('input[data-apply]')?.checked === true;
        if (!(price > 0 && apply)) return;
        const client = tr.dataset.client || ''; const product = tr.dataset.product || ''; const type = tr.dataset.type || 'ê³µí†µ';
        upsertPrice({ client, product, price, account: '', bank: '', holder: '', type });
      });
      renderPriceBook(); await savePriceBook();
      // ì¬ê³„ì‚°
      if (state.selectedTabs?.length) {
        fetchBtn?.click();
      }
    }

    // ë²„íŠ¼ ë°”ì¸ë”©: ì‚¬ì „ ì ê²€
    (function () {
      const bAdd = document.getElementById('btn-add-extra'); if (bAdd) { bAdd.addEventListener('click', () => { state.extraExpenses.push({ date: '', client: '', product: '', amount: 0, report: true }); renderPrecheck(); }); }
      const bSave = document.getElementById('btn-save-extra'); if (bSave) { bSave.addEventListener('click', async () => { await saveExtras(); if (state.lastAggregates) { renderAggregates(augmentAggregatesWithExtras(state.lastAggregates, state.extraExpenses)); } }); }
      const bApply = document.getElementById('btn-apply-missing'); if (bApply) { bApply.addEventListener('click', applyMissingPrices); }
      const bFinal = document.getElementById('btn-finalize'); if (bFinal) {
        bFinal.addEventListener('click', async () => {
          // ì €ì¥ í›„ ì¬ê³„ì‚°, ì‚¬ì „ ì ê²€ ìˆ¨ê¸°ê³  ê²°ê³¼ë§Œ
          await saveExtras();
          // ë¯¸ì • ë‹¨ê°€ì—ì„œ ë°˜ì˜ ì²´í¬ëœ í•­ëª©ë§Œ ì ìš© í›„ ì¬ê³„ì‚°
          window.__finalizing = true;
          await applyMissingPrices();
          // applyMissingPricesê°€ ì¬ê³„ì‚°ì„ íŠ¸ë¦¬ê±°(fetchBtn.click)í•˜ë¯€ë¡œ, fetch ì™„ë£Œ ì‹œ precheckë¥¼ ìˆ¨ê¹€ ì²˜ë¦¬
        });
      }
    })();

    // Aggregates + extraExpenses í•©ì‚° ìœ í‹¸
    function augmentAggregatesWithExtras(aggs, extras) {
      try {
        const A = JSON.parse(JSON.stringify(aggs || {}));
        const byP = A.by_product = A.by_product || {}; const byA = A.by_agency = A.by_agency || {};
        (extras || []).filter(ex => ex && ex.report).forEach(ex => {
          const date = ex.date || 'ì¶”ê°€'; const prod = ex.product || 'ì¶”ê°€ì§€ì¶œ'; const client = ex.client || 'ê¸°íƒ€'; const amount = Number(ex.amount || 0);
          // by_product
          const pmap = byP[date] = byP[date] || {}; const cur = pmap[prod] = pmap[prod] || { qty: 0, expense: 0, income: 0 };
          cur.expense += amount;
          // by_agency
          const amap = byA[date] = byA[date] || {}; const arr = amap[client] = amap[client] || [];
          arr.push({ product: prod, type: 'ì¶”ê°€', qty: 0, unit_price: 0, expense: amount, income: 0 });
        });
        return A;
      } catch (e) { return aggs; }
    }

    // ëª¨ë‹¬ íƒ­ ì „í™˜
    // ë‹¨ì¼ ìƒí’ˆë³„ ë·°
    function setPvTab() { /* no-op: ë‹¨ì¼ ë·° */ }

    // ë‹¨ê°€ë¶€: ì¶”ê°€/ì‚­ì œ/ì…ì¶œë ¥ (ë¡œì»¬ ë©”ëª¨ë¦¬)
    let clientDefaults = {};
    function rebuildClientDefaults() {
      const map = {};
      for (const it of state.priceBook) {
        const c = (it.client || '').trim(); if (!c) continue;
        const key = c;
        const rec = map[key] || { accountCount: {}, bankCount: {}, holderCount: {} };
        if (it.account) { rec.accountCount[it.account] = 1 + (rec.accountCount[it.account] || 0); }
        if (it.bank) { rec.bankCount[it.bank] = 1 + (rec.bankCount[it.bank] || 0); }
        if (it.holder) { rec.holderCount[it.holder] = 1 + (rec.holderCount[it.holder] || 0); }
        map[key] = rec;
      }
      const pickTop = (countObj) => {
        let bestK = '', bestV = 0; for (const k in countObj) { if (countObj[k] > bestV) { bestV = countObj[k]; bestK = k; } }
        return bestK || '';
      };
      const out = {};
      for (const k in map) { out[k] = { account: pickTop(map[k].accountCount), bank: pickTop(map[k].bankCount), holder: pickTop(map[k].holderCount) }; }
      clientDefaults = out;
    }
    function tryAutofillByClient() {
      const c = (document.getElementById('pb-client')?.value || '').trim(); if (!c) return;
      const def = clientDefaults[c]; if (!def) return;
      const accEl = document.getElementById('pb-account'); const bankEl = document.getElementById('pb-bank'); const holdEl = document.getElementById('pb-holder');
      if (accEl && !accEl.value) accEl.value = def.account || '';
      if (bankEl && !bankEl.value) bankEl.value = def.bank || '';
      if (holdEl && !holdEl.value) holdEl.value = def.holder || '';
    }
    const pbClientEl = document.getElementById('pb-client'); if (pbClientEl) { pbClientEl.addEventListener('change', tryAutofillByClient); }
    async function addOnePrice() {
      const client = (document.getElementById('pb-client')?.value || '').trim(); if (!client) return alert('ê±°ë˜ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      const product = (document.getElementById('pb-product')?.value || '').trim(); if (!product) return alert('ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
      const price = Number((document.getElementById('pb-price')?.value || '0').replace(/,/g, '')) || 0;
      const account = (document.getElementById('pb-account')?.value || '').trim();
      const holder = (document.getElementById('pb-holder')?.value || '').trim();
      const bank = (document.getElementById('pb-bank')?.value || '').trim();
      const type = (document.querySelector('input[name="pb-type"]:checked')?.value) || 'ê³µí†µ';
      upsertPrice({ client, product, price, account, bank, holder, type });
      renderPriceBook();
      await savePriceBook();
    }
    document.getElementById('pb-add-one').addEventListener('click', addOnePrice);
    document.getElementById('pb-add-both').addEventListener('click', async () => {
      const client = (document.getElementById('pb-client')?.value || '').trim(); if (!client) return alert('ê±°ë˜ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      const product = (document.getElementById('pb-product')?.value || '').trim(); if (!product) return alert('ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
      const price = Number((document.getElementById('pb-price')?.value || '0').replace(/,/g, '')) || 0;
      const account = (document.getElementById('pb-account')?.value || '').trim();
      const holder = (document.getElementById('pb-holder')?.value || '').trim();
      const bank = (document.getElementById('pb-bank')?.value || '').trim();
      upsertPrice({ client, product, price, account, bank, holder, type: 'ì €ì¥' });
      upsertPrice({ client, product, price, account, bank, holder, type: 'íŠ¸ë˜í”½' });
      renderPriceBook();
      await savePriceBook();
    });
    {
      const el = document.getElementById('btn-export-price'); if (el) {
        el.addEventListener('click', () => {
          const json = JSON.stringify(state.priceBook, null, 2);
          navigator.clipboard?.writeText(json);
          alert('ë‹¨ê°€í‘œ JSONì„ í´ë¦½ë³´ë“œë¡œ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
        });
      }
    }
    {
      const el = document.getElementById('btn-import-price'); if (el) {
        el.addEventListener('click', async () => {
          const json = prompt('ë‹¨ê°€í‘œ JSONì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”');
          if (!json) return;
          try { const arr = JSON.parse(json); if (Array.isArray(arr)) state.priceBook = arr; } catch (e) { alert('JSON íŒŒì‹± ì‹¤íŒ¨'); }
          renderPriceBook();
          await savePriceBook();
        });
      }
    }
    $('#btn-save-price').addEventListener('click', savePriceBook);

    let pbEditingIndex = -1;
    function upsertPrice(item) {
      if (pbEditingIndex >= 0) { state.priceBook[pbEditingIndex] = item; pbEditingIndex = -1; return; }
      const idx = state.priceBook.findIndex(x => x.client === item.client && x.product === item.product && (String(x.type || 'ê³µí†µ') === String(item.type || 'ê³µí†µ')));
      if (idx >= 0) { state.priceBook[idx] = item; } else { state.priceBook.push(item); }
    }
    function removePrice(client, product, type) {
      state.priceBook = state.priceBook.filter(x => !(x.client === client && x.product === product && String(x.type || 'ê³µí†µ') === String(type || 'ê³µí†µ')));
    }
    function lookupPrice(client, product) {
      const it = state.priceBook.find(x => x.client === client && x.product === product);
      return it ? it.price : null;
    }

    async function loadPriceBook() {
      try {
        const res = await fetch('/api/settlement/pricebook');
        const data = await res.json().catch(() => ({}));
        if (res.ok && Array.isArray(data.items)) state.priceBook = data.items; else state.priceBook = [];
      } catch (e) { state.priceBook = []; }
      rebuildClientDefaults();
    }

    function renderPriceBook() {
      const tb = document.querySelector('#tbl-price tbody');
      tb.innerHTML = '';
      const q = (document.getElementById('pb-search')?.value || '').trim().toLowerCase();
      const list = state.priceBook.filter(it => {
        if (!q) return true; const t = (it.client + ' ' + it.product).toLowerCase(); return t.includes(q);
      });
      for (const it of list) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${it.client || ''}</td>
            <td>${it.product || ''}</td>
            <td>${it.type || 'ê³µí†µ'}</td>
            <td>${it.price ?? ''}</td>
            <td>${it.account || ''}</td>
            <td>${it.bank || ''}</td>
            <td>${it.holder || ''}</td>
            <td>
              <button class="btn" data-edit="${it.client}|||${it.product}|||${it.type || 'ê³µí†µ'}">ìˆ˜ì •</button>
              <button class="btn" data-del="${it.client}|||${it.product}|||${it.type || 'ê³µí†µ'}">ì‚­ì œ</button>
            </td>
          `;
        tb.appendChild(tr);
      }
      tb.querySelectorAll('button[data-del]')?.forEach(btn => {
        btn.addEventListener('click', async () => {
          const [c, p, t] = btn.getAttribute('data-del').split('|||');
          removePrice(c, p, t); renderPriceBook();
          await savePriceBook();
        });
      });
      tb.querySelectorAll('button[data-edit]')?.forEach(btn => {
        btn.addEventListener('click', () => {
          const [c, p, t] = btn.getAttribute('data-edit').split('|||');
          const idx = state.priceBook.findIndex(x => x.client === c && x.product === p && String(x.type || 'ê³µí†µ') === String(t || 'ê³µí†µ'));
          if (idx >= 0) {
            pbEditingIndex = idx; const it = state.priceBook[idx];
            document.getElementById('pb-client').value = it.client || '';
            document.getElementById('pb-product').value = it.product || '';
            document.getElementById('pb-price').value = it.price || '';
            document.getElementById('pb-account').value = it.account || '';
            const bankEl = document.getElementById('pb-bank'); if (bankEl) bankEl.value = it.bank || '';
            document.getElementById('pb-holder').value = it.holder || '';
            const r = document.querySelector(`input[name="pb-type"][value="${it.type || 'ê³µí†µ'}"]`); if (r) r.checked = true;
          }
        });
      });
      // í‘œ ì•ˆì˜ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ì„ ì‘ê²Œ ìŠ¤íƒ€ì¼ë§
      tb.querySelectorAll('button').forEach(b => { b.classList.add('btn-sm', 'btn-outline'); });
      rebuildClientDefaults();
    }

    // ëŒ€ëŸ‰ë“±ë¡: XLSX ì—…ë¡œë“œ â†’ ì„œë²„ íŒŒì‹± ê²°ê³¼ë¥¼ ë¯¸ë¦¬ë³´ê¸°/ì ìš©
    const bulkState = { items: [] };
    const bulkUploadBtn = document.getElementById('bulk-upload'); if (bulkUploadBtn) {
      bulkUploadBtn.addEventListener('click', async () => {
        const inp = document.getElementById('bulk-file'); if (!inp.files || inp.files.length === 0) { alert('ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
        const file = inp.files[0]; const fd = new FormData(); fd.append('file', file);
        showLoading('ì—‘ì…€ ì—…ë¡œë“œ ì¤‘...');
        try {
          const res = await fetch('/api/settlement/pricebook/upload', { method: 'POST', body: fd });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data?.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
          bulkState.items = Array.isArray(data.items) ? data.items : [];
          renderBulkPreview(bulkState.items);
          document.getElementById('bulk-status').textContent = `${bulkState.items.length}ê±´ ì¤€ë¹„ë¨`;
        } catch (e) { alert(e.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨'); }
        finally { hideLoading(); }
      });
    }
    const bulkApplyBtn = document.getElementById('bulk-apply-xlsx'); if (bulkApplyBtn) {
      bulkApplyBtn.addEventListener('click', async () => {
        if (!Array.isArray(bulkState.items) || bulkState.items.length === 0) { alert('ë¯¸ë¦¬ë³´ê¸° í›„ ì ìš©í•˜ì„¸ìš”'); return; }
        for (const it of bulkState.items) { upsertPrice(it); }
        renderPriceBook(); await savePriceBook();
        document.getElementById('bulk-status').textContent = `${bulkState.items.length}ê±´ ë°˜ì˜ë¨`;
      });
    }

    // (ê³¼ê±° TSV ë¶™ì—¬ë„£ê¸° íŒŒì„œëŠ” ìœ ì§€ ê°€ëŠ¥í•˜ë‚˜ UIì—ì„œ ê°ì¶¤)
    function parseBulk(text) {
      const lines = (text || '').replace(/\r/g, '').split('\n').filter(x => x.trim().length > 0);
      if (lines.length === 0) return { items: [], error: null };
      const sep = (lines[0].includes('\t') ? '\t' : ',');
      const cells0 = lines[0].split(sep).map(s => s.trim().toLowerCase());
      const hasHeader = ['client', 'product', 'type', 'price', 'account', 'holder'].some(h => cells0.includes(h));
      const startIdx = hasHeader ? 1 : 0;
      const idxOf = (name) => cells0.indexOf(name);
      const colMap = hasHeader ? {
        client: idxOf('client'), product: idxOf('product'), type: idxOf('type'), price: idxOf('price'), account: idxOf('account'), holder: idxOf('holder')
      } : { client: 0, product: 1, type: 2, price: 3, account: 4, holder: 5 };
      const out = []; let err = null;
      for (let i = startIdx; i < lines.length; i++) {
        const parts = lines[i].split(sep);
        const get = (k) => { const idx = colMap[k]; return (idx >= 0 && idx < parts.length) ? parts[idx].trim() : ''; };
        const client = get('client'), product = get('product');
        let type = get('type') || 'ê³µí†µ'; const priceRaw = get('price'); const account = get('account'); const holder = get('holder');
        if (!client || !product) { err = `í•„ìˆ˜ê°’ ëˆ„ë½ (í–‰ ${i + 1}): client/product`; break; }
        const price = Number((priceRaw || '').replace(/,/g, '')) || 0;
        if (type.toLowerCase() === 'both') { out.push({ client, product, price, account, holder, type: 'ì €ì¥' }); out.push({ client, product, price, account, holder, type: 'íŠ¸ë˜í”½' }); }
        else { if (!['ê³µí†µ', 'ì €ì¥', 'íŠ¸ë˜í”½'].includes(type)) type = 'ê³µí†µ'; out.push({ client, product, price, account, holder, type }); }
      }
      return { items: out, error: err };
    }
    function renderBulkPreview(list) {
      const tb = document.querySelector('#tbl-bulk tbody'); tb.innerHTML = '';
      list.forEach((it, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx + 1}</td><td>${it.client}</td><td>${it.product}</td><td>${it.type}</td><td>${it.price}</td><td>${it.account || ''}</td><td>${it.bank || ''}</td><td>${it.holder || ''}</td><td></td>`;
        tb.appendChild(tr);
      });
      document.getElementById('bulk-status').textContent = `${list.length}ê±´ ì¤€ë¹„ë¨`;
    }
    document.getElementById('btn-bulk-toggle').addEventListener('click', () => {
      const el = document.getElementById('bulk-panel'); el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
    });
    {
      const el = document.getElementById('bulk-preview'); if (el) {
        el.addEventListener('click', () => {
          const { items, error } = parseBulk(document.getElementById('bulk-text').value);
          if (error) { alert(error); return; }
          renderBulkPreview(items);
        });
      }
    }
    {
      const el = document.getElementById('bulk-apply'); if (el) {
        el.addEventListener('click', async () => {
          const { items, error } = parseBulk(document.getElementById('bulk-text').value);
          if (error) { alert(error); return; }
          for (const it of items) { upsertPrice(it); }
          renderPriceBook();
          await savePriceBook();
          document.getElementById('bulk-status').textContent = `${items.length}ê±´ ë°˜ì˜ë¨`;
        });
      }
    }

    // í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œëŠ” ì•µì»¤ ë§í¬(#bulk-download)ë¡œ ì²˜ë¦¬

    function renderPreview() {
      const cont = document.getElementById('cards-container');
      if (!cont) return; cont.innerHTML = '';
      const group = {};
      for (const r of state.previewRows) {
        const key = `${r.date}|||${r.client}`;
        (group[key] = group[key] || []).push(r);
      }
      let grand = 0;
      Object.keys(group).sort().forEach(key => {
        const [date, client] = key.split('|||');
        const rows = group[key];
        let subtotalE = 0, subtotalI = 0;
        const tblRows = rows.map(it => {
          subtotalE += (it.expense || 0); subtotalI += (it.income || 0); grand += (it.expense || 0);
          return `<tr><td>${it.product}</td><td>${it.qty}</td><td>${it.price}</td><td>${it.expense || 0}</td><td>${it.income || 0}</td></tr>`;
        }).join('');
        const card = document.createElement('div'); card.className = 'card collapsed';
        card.innerHTML = `
            <div class="card-hd"><div class="pill">${date}</div><div class="muted" style="font-weight:700">${client}</div></div>
            <div class="card-bd" style="overflow:auto">
              <table style="width:100%">
                <thead><tr><th>ìƒí’ˆëª…</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€</th><th>ì§€ì¶œ</th><th>ë§¤ì¶œ</th></tr></thead>
                <tbody>${tblRows}</tbody>
                <tfoot><tr><th colspan="3" style="text-align:right">ì†Œê³„</th><th>${subtotalE}</th><th>${subtotalI}</th></tr></tfoot>
              </table>
            </div>
          `;
        card.querySelector('.card-hd').addEventListener('click', () => { card.classList.toggle('collapsed'); });
        cont.appendChild(card);
      });
      // ì´ê³„ ë±ƒì§€
      const headerArea = document.querySelector('#results-panel .stack');
      if (headerArea) {
        const onlyInternal = window.__onlyInternal === true;
        // ìƒë‹¨ ì´ ì§€ì¶œ ë±ƒì§€ëŠ” cb-internal ìª½ìœ¼ë¡œ ì´ë™
        const badge = document.getElementById('agg-total-badge');
        if (badge) { badge.textContent = `${onlyInternal ? 'ë‚´ë¶€ ì´ ì§€ì¶œ' : 'ì´ ì§€ì¶œ'} ${grand.toLocaleString()}`; badge.style.background = onlyInternal ? '#fde68a' : '#f6f8fa'; }
      }
    }

    // ì¹´ë“œ ì ‘ê¸°/í¼ì¹˜ê¸° í† ê¸€ ë²„íŠ¼(ë‹¨ì¼)
    (function () {
      const btn = document.getElementById('btn-toggle-collapse'); if (!btn) return; let collapsed = true; const apply = () => {
        document.querySelectorAll('#cards-container .card').forEach(el => el.classList.toggle('collapsed', collapsed));
        btn.textContent = collapsed ? 'ì „ì²´ í¼ì¹˜ê¸°' : 'ì „ì²´ ì ‘ê¸°';
      }; btn.addEventListener('click', () => { collapsed = !collapsed; apply(); }); apply();
    })();

    // ì‚­ì œ ëª¨ë“œ í† ê¸€: 1) ì²« í´ë¦­ â†’ ì²´í¬ë°•ìŠ¤ í‘œì‹œ 2) ë‘ ë²ˆì§¸ í´ë¦­ â†’ ì„ íƒëœ í•­ëª© ì œì™¸ ì ìš©
    (function () {
      const btn = document.getElementById('btn-delete-toggle'); if (!btn) return;
      function setBtnActive(on) { btn.classList.toggle('btn-danger', !!on); btn.textContent = on ? 'ì„ íƒ ì‚­ì œ ì ìš©' : 'ì‚­ì œ'; }
      async function reRender() { if (state.lastAggregates) { renderAggregates(augmentAggregatesWithExtras(state.lastAggregates, state.extraExpenses)); } }
      btn.addEventListener('click', async () => {
        const active = window.__deleteMode === true;
        if (!active) { // í™œì„±í™”
          window.__deleteMode = true; setBtnActive(true); await reRender();
          return;
        }
        // ì ìš©: ì„ íƒ ìˆ˜ì§‘
        try {
          const prodChks = Array.from(document.querySelectorAll('input[data-del-prod]'));
          const rowChks = Array.from(document.querySelectorAll('input[data-del-row]'));
          const selProds = prodChks.filter(c => c.checked).map(c => String(c.getAttribute('data-product') || ''));
          const selRows = rowChks.filter(c => c.checked).map(c => String(c.getAttribute('data-rowkey') || ''));
          // ì¤‘ë³µ ì œê±° ë° ë³‘í•©
          const prodSet = new Set([...(state.exclusions?.products || []), ...selProds.filter(Boolean)]);
          const rowSet = new Set([...(state.exclusions?.rows || []), ...selRows.filter(Boolean)]);
          state.exclusions = { products: Array.from(prodSet), rows: Array.from(rowSet) };
        } catch (e) { }
        window.__deleteMode = false; setBtnActive(false);
        await reRender();
      });
    })();

    // --- ìµœì¢… ì •ì‚° ìœ„ì €ë“œ ---
    // íŒ¨ë„ DOM ì¶”ê°€
    (function mountWizard() {
      const host = document.querySelector('.maincol'); if (!host) return;
      const div = document.createElement('div'); div.id = 'wizard-panel'; div.className = 'wizard'; div.style.display = 'none';
      div.innerHTML = `
          <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:8px">
            <div class="muted">ìµœì¢… ì •ì‚° Â· ì¹´í†¡ ë³´ê³  Â· ì—‘ì…€ ë³´ê³ </div>
            <div class="stack" style="gap:8px">
              <button id="wiz-close" class="btn">ë‹«ê¸°</button>
            </div>
          </div>
          <div id="wiz-steps" class="muted-sm" style="margin-bottom:8px">1) ë¯¸ìˆ˜ê¸ˆ/ë¯¸ì§€ê¸‰ â†’ 2) ì¹´í†¡ ë³´ê³  â†’ 3) ì—‘ì…€ ë³´ê³ </div>
          <div id="slide-1" class="slide active">
            <div class="grid">
              <div class="panel">
                <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:6px"><b>ë¯¸ìˆ˜ê¸ˆ</b><button id="recv-add" class="btn">í–‰ ì¶”ê°€</button></div>
                <div style="overflow:auto">
                  <table class="mini" style="width:100%"><thead><tr><th>ëŒ€í–‰ì‚¬ëª…</th><th>ê¸ˆì•¡</th><th></th></tr></thead><tbody id="recv-body"></tbody></table>
                </div>
              </div>
              <div class="panel">
                <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:6px"><b>ë¯¸ì§€ê¸‰</b><button id="pay-add" class="btn">í–‰ ì¶”ê°€</button></div>
                <div style="overflow:auto">
                  <table class="mini" style="width:100%"><thead><tr><th>ê±°ë˜ì²˜</th><th>ìƒí’ˆëª…</th><th>ê¸ˆì•¡</th><th></th></tr></thead><tbody id="pay-body"></tbody></table>
                </div>
              </div>
            </div>
            <div class="stack" style="justify-content:flex-end; margin-top:8px">
              <button id="wiz-next-1" class="btn-primary">ë‹¤ìŒ</button>
            </div>
          </div>
          <div id="slide-2" class="slide">
            <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:6px">
              <div class="stack" style="align-items:center; gap:8px">
                <label class="muted-sm">ë³´ê³  ë‚ ì§œ</label>
                <input id="report-date" type="text" placeholder="ì˜ˆ: 9/26ì¼" style="min-width:120px">
              </div>
              <div class="stack" style="gap:8px">
                <button id="wiz-preview" class="btn">ì™„ë£Œ</button>
              </div>
            </div>
            <div class="two-col">
              <div class="panel">
                <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:6px"><b>ê±°ë˜ì²˜ë³„ ì´ ê¸ˆì•¡(ë¶€ê°€ì„¸ í¬í•¨)</b><span class="muted-sm">í•­ëª© ì„ íƒìœ¼ë¡œ ë‚´ìš© ìˆ˜ì •</span></div>
                <div id="pc-list" style="max-height:380px; overflow:auto"></div>
              </div>
              <div class="panel">
                <div class="stack" style="justify-content:space-between; align-items:center"><b>ë¯¸ë¦¬ë³´ê¸°</b><div class="stack"><button id="copy-kakao" class="btn">ë³µì‚¬</button></div></div>
                <textarea id="kakao-text" style="width:100%; height:360px; margin-top:8px"></textarea>
              </div>
            </div>
            <div class="stack" style="justify-content:space-between; margin-top:8px">
              <button id="wiz-back-2" class="btn">ì´ì „</button>
              <button id="wiz-next-2" class="btn-primary">ë‹¤ìŒ</button>
            </div>
          </div>
          <div id="slide-3" class="slide">
            <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:6px"><b>ì—‘ì…€ ë³´ê³  í…œí”Œë¦¿</b><div class="stack"><button id="copy-excel" class="btn">ë³µì‚¬</button></div></div>
            <div class="muted-sm" style="margin-bottom:6px">ì—´: êµ¬ë¶„ | ì€í–‰ | ê³„ì¢Œ | ê¸ˆì•¡(vat í¬í•¨) | ë‚´ìš© | ì˜ˆê¸ˆì£¼</div>
            <div style="overflow:auto"><table id="excel-table" class="mini" style="width:100%"><thead><tr><th>êµ¬ë¶„</th><th>ì€í–‰</th><th>ê³„ì¢Œ</th><th>ê¸ˆì•¡(vat í¬í•¨)</th><th>ë‚´ìš©</th><th>ì˜ˆê¸ˆì£¼</th></tr></thead><tbody></tbody></table></div>
            <div class="stack" style="justify-content:space-between; margin-top:8px">
              <button id="wiz-back-3" class="btn">ì´ì „</button>
              <button id="wiz-done" class="btn-primary">ì™„ë£Œ</button>
            </div>
          </div>
        `;
      host.appendChild(div);
    })();

    // ìœ„ì €ë“œ ì—´ê¸°/ë‹«ê¸°
    (function () {
      const btn = document.getElementById('btn-finalize-wizard'); if (btn) {
        btn.addEventListener('mouseenter', () => { btn.textContent = 'í‡´ê·¼ ê³ ?'; });
        btn.addEventListener('mouseleave', () => { btn.textContent = 'ìµœì¢… ì •ì‚°'; });
        btn.addEventListener('click', () => {
          const wiz = document.getElementById('wizard-panel'); const rp = document.getElementById('results-panel'); const hero = document.getElementById('hero');
          if (wiz) { wiz.style.display = 'block'; }
          if (rp) { rp.style.display = 'none'; }
          if (hero) { hero.style.display = 'none'; }
          setSlide(1);

          // ë¯¸ìˆ˜ê¸ˆ ë°ì´í„° ìë™ ì±„ìš°ê¸° (VAT í¬í•¨, ì²œ ë‹¨ìœ„ ì½¤ë§ˆ)
          if (state.unpaidReceivables && Object.keys(state.unpaidReceivables).length > 0) {
            state.wizard.receivables = Object.entries(state.unpaidReceivables).map(([agency, amount]) => ({
              agency,
              amount: Math.round(Number(amount || 0) * 1.1) // VAT í¬í•¨ (1.1 ê³±í•¨)
            }));
          }

          renderReceivables(); renderPayables();
          renderKakaoList(); buildKakaoText(); renderExcelTable();
        });
      }
      const closeBtn = document.getElementById('wiz-close'); if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          const wiz = document.getElementById('wizard-panel'); const rp = document.getElementById('results-panel'); const hero = document.getElementById('hero');
          if (wiz) { wiz.style.display = 'none'; }
          if (rp) { rp.style.display = 'block'; }
          if (hero) { hero.style.display = 'block'; }
        });
      }
    })();

    function setSlide(n) { state.wizard.step = n;['slide-1', 'slide-2', 'slide-3'].forEach((id, i) => { const el = document.getElementById(id); if (el) el.classList.toggle('active', (i + 1) === n); }); }

    // Step1: ë¯¸ìˆ˜ê¸ˆ/ë¯¸ì§€ê¸‰
    function renderReceivables() {
      const tb = document.getElementById('recv-body'); if (!tb) return; tb.innerHTML = ''; (state.wizard.receivables || []).forEach((it, idx) => {
        const tr = document.createElement('tr'); tr.innerHTML = `<td><input type="text" value="${it.agency || ''}" style="width:160px"></td><td><input type="number" step="1" value="${Number(it.amount || 0)}" style="width:120px"></td><td><button class="btn" data-del>ì‚­ì œ</button></td>`; tb.appendChild(tr);
        tr.querySelector('[data-del]')?.addEventListener('click', () => { state.wizard.receivables.splice(idx, 1); renderReceivables(); });
        const inputs = tr.querySelectorAll('input'); inputs[0]?.addEventListener('input', e => { it.agency = e.target.value; }); inputs[1]?.addEventListener('input', e => { it.amount = Number(e.target.value || 0); });
      });
    }
    function renderPayables() {
      const tb = document.getElementById('pay-body'); if (!tb) return; tb.innerHTML = ''; (state.wizard.payables || []).forEach((it, idx) => {
        const tr = document.createElement('tr'); tr.innerHTML = `<td><input type="text" value="${it.client || ''}" style="width:160px"></td><td><input type="text" value="${it.product || ''}" style="width:160px"></td><td><input type="number" step="1" value="${Number(it.amount || 0)}" style="width:120px"></td><td><button class="btn" data-del>ì‚­ì œ</button></td>`; tb.appendChild(tr);
        tr.querySelector('[data-del]')?.addEventListener('click', () => { state.wizard.payables.splice(idx, 1); renderPayables(); });
        const inputs = tr.querySelectorAll('input'); inputs[0]?.addEventListener('input', e => { it.client = e.target.value; }); inputs[1]?.addEventListener('input', e => { it.product = e.target.value; }); inputs[2]?.addEventListener('input', e => { it.amount = Number(e.target.value || 0); });
      });
    }
    (function () {
      const addRecv = document.getElementById('recv-add'); if (addRecv) { addRecv.addEventListener('click', () => { state.wizard.receivables.push({ agency: '', amount: 0 }); renderReceivables(); }); }
      const addPay = document.getElementById('pay-add'); if (addPay) { addPay.addEventListener('click', () => { state.wizard.payables.push({ client: '', product: '', amount: 0 }); renderPayables(); }); }
      const next1 = document.getElementById('wiz-next-1'); if (next1) { next1.addEventListener('click', () => { setSlide(2); renderKakaoList(); buildKakaoText(); }); }
    })();

    // í˜„ì¬ í•„í„°/ì œì™¸ ì ìš© í›„, í´ë¼ì´ì–¸íŠ¸ë³„ ì§€ì¶œ í•©ê³„ êµ¬í•˜ê¸°
    function computeClientTotals() {
      const aggs = augmentAggregatesWithExtras(state.lastAggregates || {}, state.extraExpenses || []);
      const byA = aggs.by_agency || {}; const mincomClients = ['ë¯¼ì»´í¼ë‹ˆ', 'ê¶ì„œì• ë“œ'];
      const filterGuarantee = window.__filterGuarantee === true; const filterManage = window.__filterManage === true; const filterMincom = window.__filterMincom === true; const onlyMincomMode = filterMincom && !filterGuarantee && !filterManage; const noFilter = !filterGuarantee && !filterManage && !filterMincom;
      const out = {}; // client -> expense sum
      Object.keys(byA).forEach(date => {
        const cmap = byA[date] || {}; Object.keys(cmap).forEach(client => {
          const arr = cmap[client] || []; arr.forEach(it => {
            if (state.exclusions?.products?.includes?.(it.product || '')) return;
            const rowKey = `${date}|||${client}|||${it.product || ''}|||${it.type || ''}|||${Number(it.qty || 0)}|||${Number(it.unit_price || 0)}|||${Number(it.expense || 0)}`;
            if (state.exclusions?.rows?.includes?.(rowKey)) return;
            const itype = it.internal_type || null; const isG = itype === 'guarantee'; const isM = itype === 'manage'; const isMin = mincomClients.includes(client);
            if (filterGuarantee && !isG) return; if (filterManage && !isM) return; if (filterMincom && !isMin) return; if (onlyMincomMode && !isG) return; if (filterGuarantee && isMin) return;
            out[client] = (out[client] || 0) + Number(it.expense || 0);
          });
        });
      });
      return out;
    }

    // Step2: ì¹´í†¡ ë³´ê³ ìš© UI (ìƒí’ˆë³„ â†’ ê±°ë˜ì²˜ ëª©ë¡, ê¸ˆì•¡ì€ VAT í¬í•¨)
    const EXPENSE_TAGS = [
      { key: 'ë¦¬ì›Œë“œ', label: 'ë¦¬ì›Œë“œ' },
      { key: 'ë¸”ë¡œê·¸', label: 'ë¸”ë¡œê·¸ ë°°í¬' },
      { key: 'ì˜ìˆ˜ì¦', label: 'ì˜ìˆ˜ì¦' },
      { key: 'ë¯¼ì»´', label: 'ë¯¼ì»´í¼ë‹ˆ ì •ì‚°' },
      { key: 'ê¶ì„œ', label: 'ê¶ì„œì• ë“œ ì •ì‚°' },
    ];
    // ë¶€ê°€ì„¸ í¬í•¨ ê¸ˆì•¡ ê³„ì‚° ìœ í‹¸ (x1.1, ë°˜ì˜¬ë¦¼)
    function withVAT(v) { return Math.round(Number(v || 0) * 1.1); }

    // ìƒí’ˆ-ê±°ë˜ì²˜ ë¦¬ìŠ¤íŠ¸(ë¶€ê°€ì„¸ í¬í•¨) êµ¬ì„±
    function renderProductClientList() {
      const host = document.getElementById('pc-list'); if (!host) return; host.innerHTML = '';
      // ì§‘ê³„: product -> client -> sum(expense)
      const aggs = augmentAggregatesWithExtras(state.lastAggregates || {}, state.extraExpenses || {});
      const byA = aggs.by_agency || {}; const mincomClients = ['ë¯¼ì»´í¼ë‹ˆ', 'ê¶ì„œì• ë“œ'];
      const filterGuarantee = window.__filterGuarantee === true; const filterManage = window.__filterManage === true; const filterMincom = window.__filterMincom === true; const onlyMincomMode = filterMincom && !filterGuarantee && !filterManage;
      const excludeP = new Set(state.exclusions?.products || []); const excludeR = new Set(state.exclusions?.rows || []);
      const map = {}; // prod => client => sum
      Object.keys(byA).forEach(date => {
        const cmap = byA[date] || {}; Object.keys(cmap).forEach(client => {
          (cmap[client] || []).forEach(it => {
            if (excludeP.has(it.product || '')) return;
            const rk = `${date}|||${client}|||${it.product || ''}|||${it.type || ''}|||${Number(it.qty || 0)}|||${Number(it.unit_price || 0)}|||${Number(it.expense || 0)}`;
            if (excludeR.has(rk)) return;
            const itype = it.internal_type || null; const isG = itype === 'guarantee'; const isM = itype === 'manage'; const isMin = mincomClients.includes(client);
            if (filterGuarantee && !isG) return; if (filterManage && !isM) return; if (filterMincom && !isMin) return; if (onlyMincomMode && !isG) return; if (filterGuarantee && isMin) return;
            const prod = it.product || ''; if (!map[prod]) map[prod] = {}; map[prod][client] = (map[prod][client] || 0) + Number(it.expense || 0);
          });
        });
      });
      // ì¹´ë“œ ê·¸ë¦¬ë“œ(ì„¸ë¡œÂ·ê°€ë¡œ ëª¨ë‘ í™œìš©)
      const grid = document.createElement('div'); grid.className = 'cards';
      Object.keys(map).sort().forEach(prod => {
        const card = document.createElement('div'); card.className = 'card';
        const inner = [];
        Object.keys(map[prod]).sort().forEach(client => {
          const v = withVAT(map[prod][client]);
          inner.push(`<div class="stack" style="justify-content:space-between; padding:6px 0; border-bottom:1px solid var(--line)"><span class="home-link" data-pc="${prod}|||${client}|||${v}">[${client}]</span><b>${v.toLocaleString()}ì›</b></div>`);
        });
        card.innerHTML = `<div class="card-hd mini"><div><b>${prod}</b></div><div class="muted">ë¶€ê°€ì„¸ í¬í•¨</div></div><div class="card-bd">${inner.join('')}</div>`;
        grid.appendChild(card);
      });
      host.appendChild(grid);
      // í´ë¦­ ì‹œ ì¹´í†¡ ë¯¸ë¦¬ë³´ê¸° ì‹¤ì‹œê°„ ê°±ì‹ (í•´ë‹¹ ì¤„ë§Œ êµì²´)
      host.querySelectorAll('[data-pc]')?.forEach(el => {
        el.addEventListener('click', () => {
          const payload = String(el.getAttribute('data-pc') || '');
          const [prod, client, amountStr] = payload.split('|||');
          // í•´ë‹¹ í´ë¼ì´ì–¸íŠ¸ ë¼ì¸ì˜ ë¬¸êµ¬ë¥¼ ê°•ì¡° í‘œì‹œ(íƒœê·¸ ì„ íƒ ìƒíƒœ ê¸°ë°˜)ë¥¼ ìœ ì§€í•œ ì±„ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
          // ì¹´í…Œê³ ë¦¬ ì„ íƒì€ ìœ ì§€í•˜ê³ , ê¸ˆì•¡ì€ ë¶€ê°€ì„¸ í¬í•¨ìœ¼ë¡œ ë°˜ì˜
          // ê¸°ì¡´ buildKakaoTextëŠ” ì „ì²´ë¥¼ ë‹¤ì‹œ ë§Œë“œë‹ˆ ê·¸ëŒ€ë¡œ í˜¸ì¶œ
          buildKakaoText();
        });
      });
    }
    function computeProductClientTotals() {
      const aggs = augmentAggregatesWithExtras(state.lastAggregates || {}, state.extraExpenses || {});
      const byA = aggs.by_agency || {}; const mincomClients = ['ë¯¼ì»´í¼ë‹ˆ', 'ê¶ì„œì• ë“œ'];
      const filterGuarantee = window.__filterGuarantee === true; const filterManage = window.__filterManage === true; const filterMincom = window.__filterMincom === true; const onlyMincomMode = filterMincom && !filterGuarantee && !filterManage;
      const excludeP = new Set(state.exclusions?.products || []); const excludeR = new Set(state.exclusions?.rows || []);
      const map = {}; // prod -> client -> sum(expense)
      Object.keys(byA).forEach(date => {
        const cmap = byA[date] || {}; Object.keys(cmap).forEach(client => {
          (cmap[client] || []).forEach(it => {
            if (excludeP.has(it.product || '')) return;
            const rk = `${date}|||${client}|||${it.product || ''}|||${it.type || ''}|||${Number(it.qty || 0)}|||${Number(it.unit_price || 0)}|||${Number(it.expense || 0)}`;
            if (excludeR.has(rk)) return;
            const itype = it.internal_type || null; const isG = itype === 'guarantee'; const isM = itype === 'manage'; const isMin = mincomClients.includes(client);
            if (filterGuarantee && !isG) return; if (filterManage && !isM) return; if (filterMincom && !isMin) return; if (onlyMincomMode && !isG) return; if (filterGuarantee && isMin) return;
            const prod = it.product || ''; if (!map[prod]) map[prod] = {}; map[prod][client] = (map[prod][client] || 0) + Number(it.expense || 0);
          });
        });
      });
      // VAT í¬í•¨ ë³€í™˜
      const out = {}; Object.keys(map).forEach(prod => { out[prod] = {}; Object.keys(map[prod]).forEach(client => { out[prod][client] = withVAT(map[prod][client]); }); });
      return out;
    }
    function computeProductTotals() {
      const pc = computeProductClientTotals();
      const totals = {}; Object.keys(pc).forEach(prod => { totals[prod] = Object.values(pc[prod]).reduce((a, b) => a + Number(b || 0), 0); });
      return totals;
    }
    // ê±°ë˜ì²˜ë³„ í•©ê³„(VAT í¬í•¨): ëª¨ë“  ìƒí’ˆì„ ê±°ë˜ì²˜ ê¸°ì¤€ìœ¼ë¡œ ë³‘í•©
    function computeVendorTotals() {
      const aggs = augmentAggregatesWithExtras(state.lastAggregates || {}, state.extraExpenses || {});
      const byA = aggs.by_agency || {}; const mincomClients = ['ë¯¼ì»´í¼ë‹ˆ', 'ê¶ì„œì• ë“œ'];
      const filterGuarantee = window.__filterGuarantee === true; const filterManage = window.__filterManage === true; const filterMincom = window.__filterMincom === true; const onlyMincomMode = filterMincom && !filterGuarantee && !filterManage;
      const excludeP = new Set(state.exclusions?.products || []); const excludeR = new Set(state.exclusions?.rows || []);
      const map = {}; // vendor -> sum(expense)
      Object.keys(byA).forEach(date => {
        const cmap = byA[date] || {}; Object.keys(cmap).forEach(client => {
          (cmap[client] || []).forEach(it => {
            if (excludeP.has(it.product || '')) return;
            const rk = `${date}|||${client}|||${it.product || ''}|||${it.type || ''}|||${Number(it.qty || 0)}|||${Number(it.unit_price || 0)}|||${Number(it.expense || 0)}`;
            if (excludeR.has(rk)) return;
            const itype = it.internal_type || null; const isG = itype === 'guarantee'; const isM = itype === 'manage'; const isMin = mincomClients.includes(client);
            if (filterGuarantee && !isG) return; if (filterManage && !isM) return; if (filterMincom && !isMin) return; if (onlyMincomMode && !isG) return; if (filterGuarantee && isMin) return;
            const vendor = getVendorNameForProduct(it.product || '');
            map[vendor] = (map[vendor] || 0) + Number(it.expense || 0);
          });
        });
      });
      // VAT í¬í•¨ ë³€í™˜
      const out = {}; Object.keys(map).forEach(v => { out[v] = withVAT(map[v]); });
      return out;
    }

    // ë²¤ë”(ê±°ë˜ì²˜) í‘œì‹œ ìˆœì„œ ìœ ì§€/ë³´ì •
    function computeDefaultVendorOrder(vendors) {
      const s = vendors.slice().sort((a, b) => {
        const A = (a === 'ì¼ë¥˜ê¸°íš') ? '\\x00' + a : a;
        const B = (b === 'ì¼ë¥˜ê¸°íš') ? '\\x00' + b : b;
        return A.localeCompare(B);
      });
      return s;
    }
    function ensureVendorOrder(currentVendors) {
      const cur = Array.isArray(currentVendors) ? currentVendors.slice() : [];
      let ordered = (state.wizard.vendorOrder || []).filter(v => cur.includes(v));
      const remain = cur.filter(v => !ordered.includes(v));
      ordered = ordered.concat(computeDefaultVendorOrder(remain));
      // ì¼ë¥˜ê¸°íš ìµœìƒë‹¨ ìœ ì§€
      const idx = ordered.indexOf('ì¼ë¥˜ê¸°íš'); if (idx > 0) { ordered.splice(idx, 1); ordered.unshift('ì¼ë¥˜ê¸°íš'); }
      state.wizard.vendorOrder = ordered;
      return ordered;
    }
    function reorderVendorOrder(src, dst) {
      const arr = (state.wizard.vendorOrder || []).slice();
      const si = arr.indexOf(src); const di = arr.indexOf(dst);
      if (si < 0 || di < 0 || si === di) return;
      arr.splice(si, 1); arr.splice(di, 0, src);
      // ì¼ë¥˜ê¸°íš ê³ ì •
      const idx = arr.indexOf('ì¼ë¥˜ê¸°íš'); if (idx > 0) { arr.splice(idx, 1); arr.unshift('ì¼ë¥˜ê¸°íš'); }
      state.wizard.vendorOrder = arr;
    }
    // ìƒí’ˆ â†’ ê±°ë˜ì²˜ëª… ë§¤í•‘: priceBookì—ì„œ í•´ë‹¹ ìƒí’ˆì˜ ëŒ€í‘œ ê±°ë˜ì²˜ëª…ì„ ì¶”ì •
    function getVendorNameForProduct(prod) {
      try {
        // priceBookì—ì„œ ë™ì¼ ìƒí’ˆëª…ì˜ ì²« ë ˆì½”ë“œì˜ client ì‚¬ìš©
        const it = (state.priceBook || []).find(x => String(x.product || '') === String(prod || ''));
        return (it && it.client) ? String(it.client) : String(prod || '');
      } catch (e) { return String(prod || ''); }
    }
    function renderKakaoList() {
      const cont = document.getElementById('pc-list'); if (!cont) return; cont.innerHTML = '';
      const totals = computeVendorTotals();
      const keys = ensureVendorOrder(Object.keys(totals));
      keys.forEach(vendor => {
        const wrap = document.createElement('div'); wrap.className = 'panel'; wrap.style.marginBottom = '8px';
        wrap.setAttribute('draggable', 'true'); wrap.dataset.vendor = vendor;
        const amount = Number(totals[vendor] || 0);
        wrap.innerHTML = `
            <div class=\"stack\" style=\"justify-content:space-between; align-items:center\">
              <div><b>[${vendor}]</b></div>
              <div>
                ${(EXPENSE_TAGS || []).map(tag => `<span class=\"tag\" data-vtag data-vendor=\"${vendor}\" data-key=\"${tag.key}\">${tag.key}</span>`).join('')}
              </div>
              <b>${amount.toLocaleString()}ì›</b>
            </div>`;
        cont.appendChild(wrap);
        // DnD
        wrap.addEventListener('dragstart', (e) => { try { e.dataTransfer.setData('text/plain', vendor); } catch (err) { } });
        wrap.addEventListener('dragover', (e) => { e.preventDefault(); });
        wrap.addEventListener('drop', (e) => { e.preventDefault(); let src = ''; try { src = e.dataTransfer.getData('text/plain'); } catch (err) { } if (!src) return; reorderVendorOrder(src, vendor); renderKakaoList(); buildKakaoText(); });
      });
      // íƒœê·¸ í† ê¸€ í•¸ë“¤ëŸ¬ (ê±°ë˜ì²˜ ë‹¨ìœ„)
      cont.querySelectorAll('[data-vtag]')?.forEach(el => {
        el.addEventListener('click', () => {
          const vendor = String(el.getAttribute('data-vendor') || ''); const key = String(el.getAttribute('data-key') || '');
          const cur = new Set(state.wizard.categories[vendor] || []); if (cur.has(key)) cur.delete(key); else cur.add(key); state.wizard.categories[vendor] = Array.from(cur);
          renderKakaoList(); buildKakaoText();
        });
      });
    }

    function buildKakaoText() {
      const txt = [];
      // ë‚ ì§œ ìë™ ìƒì„±: ì„ íƒí•œ íƒ­(ë‚ ì§œë“¤)ì—ì„œ ìµœì†Œ~ìµœëŒ€ë¥¼ MM/DD í˜•ì‹ìœ¼ë¡œ í‘œê¸°. ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ìš°ì„ 
      let dateStr = (document.getElementById('report-date')?.value || state.wizard.reportDate || '').trim();
      try {
        if (!dateStr && Array.isArray(state.selectedTabs) && state.selectedTabs.length) {
          const toMMDD = (s) => { const t = String(s || ''); const m = t.slice(0, 2), d = t.slice(2); return `${m}/${d}`; };
          const nums = state.selectedTabs.map(t => Number(String(t).replace(/\D/g, ''))).filter(n => !isNaN(n));
          if (nums.length) {
            nums.sort((a, b) => a - b); const first = String(nums[0]).padStart(4, '0'); const last = String(nums[nums.length - 1]).padStart(4, '0');
            const fst = toMMDD(first), lst = toMMDD(last); dateStr = (fst === lst) ? fst : `${fst} ~ ${lst}`;
          }
        }
      } catch (e) { }
      if (dateStr) { txt.push(dateStr); txt.push(''); }
      const totals = computeVendorTotals(); let totalSum = 0;
      const ordered = ensureVendorOrder(Object.keys(totals));
      ordered.forEach(vendor => {
        txt.push(`[${vendor}]`);
        const amount = Number(totals[vendor] || 0); totalSum += amount;
        const tags = state.wizard.categories[vendor] || []; const custom = (state.wizard.custom[vendor] || '').trim();
        const pieces = []; tags.forEach(k => { const t = EXPENSE_TAGS.find(x => x.key === k); if (t) pieces.push(t.label); }); if (custom) pieces.push(custom);
        const label = pieces.length ? pieces.join(', ') : 'ì§€ì¶œ';
        txt.push(`${amount.toLocaleString()}ì› - ${label}`);
        txt.push('');
      });
      if ((state.wizard.receivables || []).length) { txt.push('ë¯¸ìˆ˜ê¸ˆ'); (state.wizard.receivables || []).forEach(it => { if (!it) return; const a = String(it.agency || '').trim(); const m = Number(it.amount || 0); if (a && m) { txt.push(`${a} - ${m.toLocaleString()}ì›`); } }); txt.push(''); }
      if ((state.wizard.payables || []).length) { txt.push('ë¯¸ì§€ê¸‰'); let subtotal = 0; (state.wizard.payables || []).forEach(it => { if (!it) return; const c = String(it.client || '').trim(); const p = String(it.product || '').trim(); const m = Number(it.amount || 0); if (c && p && m) { txt.push(`[${c}]`); txt.push(`${p} - ${m.toLocaleString()}ì›`); subtotal += m; } }); if (subtotal > 0) { txt.push(''); txt.push(`ì´ - ${subtotal.toLocaleString()}ì›`); } txt.push(''); }
      txt.push(`ì´ ê¸ˆì•¡: ${totalSum.toLocaleString()}ì›`);
      const ta = document.getElementById('kakao-text'); if (ta) ta.value = txt.join('\n');
    }
    (function () {
      const dateEl = document.getElementById('report-date'); if (dateEl) { dateEl.addEventListener('input', () => { state.wizard.reportDate = dateEl.value; buildKakaoText(); }); }
      const prev = document.getElementById('wiz-back-2'); if (prev) { prev.addEventListener('click', () => setSlide(1)); }
      const preview = document.getElementById('wiz-preview'); if (preview) { preview.addEventListener('click', () => { buildKakaoText(); }); }
      const copy = document.getElementById('copy-kakao'); if (copy) { copy.addEventListener('click', () => { const t = document.getElementById('kakao-text')?.value || ''; navigator.clipboard?.writeText(t); toast('ë³µì‚¬ë¨'); }); }
      const next2 = document.getElementById('wiz-next-2'); if (next2) { next2.addEventListener('click', () => { setSlide(3); renderExcelTable(); }); }
      // ê±°ë˜ì²˜ ë³´ë“œ ë Œë”
      renderKakaoList();
    })();

    // Step3: ì—‘ì…€ ë¯¸ë¦¬ë³´ê¸° (UI ìŠ¤ì¼ˆë ˆí†¤)
    function gatherCurrentRows() {
      const rows = [];
      const vendors = computeVendorTotals();
      // order: ì¼ë¥˜ê¸°íš ìš°ì„ 
      const keys = Object.keys(vendors).sort((a, b) => {
        const A = (a === 'ì¼ë¥˜ê¸°íš') ? '\\x00' + a : a; const B = (b === 'ì¼ë¥˜ê¸°íš') ? '\\x00' + b : b; return A.localeCompare(B);
      });
      let idx = 1;
      keys.forEach(vendor => {
        // bank/account/holder lookup from priceBook (first match by client)
        const rec = (state.priceBook || []).find(x => String(x.client || '') === String(vendor || ''));
        const bank = rec?.bank || ''; const account = rec?.account || ''; const holder = rec?.holder || '';
        // ë‚´ìš©: ì¹´í†¡ ë¯¸ë¦¬ë³´ê¸° ë¼ì¸ê³¼ ë™ì¼ ê·œì¹™(íƒœê·¸ ì„ íƒ)
        const tags = state.wizard.categories[vendor] || []; const custom = (state.wizard.custom[vendor] || '').trim();
        const pieces = []; tags.forEach(k => { const t = EXPENSE_TAGS.find(x => x.key === k); if (t) pieces.push(t.label); }); if (custom) pieces.push(custom);
        const label = pieces.length ? pieces.join(', ') : 'ì§€ì¶œ';
        rows.push({ order: idx++, bank, account, amount: Number(vendors[vendor] || 0), content: label, holder });
      });
      return rows;
    }
    function renderExcelTable() {
      const tb = document.querySelector('#excel-table tbody'); if (!tb) return; tb.innerHTML = ''; const rows = gatherCurrentRows(); rows.forEach(r => {
        const tr = document.createElement('tr'); tr.innerHTML = `<td>${r.order}</td><td>${r.bank}</td><td>${r.account}</td><td>${Number(r.amount).toLocaleString()}</td><td>${r.content}</td><td>${r.holder}</td>`; tb.appendChild(tr);
      });
    }
    (function () {
      const back = document.getElementById('wiz-back-3'); if (back) { back.addEventListener('click', () => setSlide(2)); }
      const done = document.getElementById('wiz-done'); if (done) { done.addEventListener('click', () => { toast('ì™„ë£Œë˜ì—ˆì–´ìš”'); }); }
      const copy = document.getElementById('copy-excel'); if (copy) { copy.addEventListener('click', () => { const rows = gatherCurrentRows(); const headers = ['êµ¬ë¶„', 'ì€í–‰', 'ê³„ì¢Œ', 'ê¸ˆì•¡(vat í¬í•¨)', 'ë‚´ìš©', 'ì˜ˆê¸ˆì£¼']; const lines = [headers.join('\t')]; rows.forEach(r => { lines.push([r.order, r.bank, r.account, r.amount, r.content, r.holder].join('\t')); }); const text = lines.join('\n'); navigator.clipboard?.writeText(text); toast('ë³µì‚¬ë¨'); }); }
    })();

    // 4) ì—‘ì…€ ì–‘ì‹ ë³µë¶™ìš© ìƒì„± (ë²„íŠ¼ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ ë°”ì¸ë”©)
    {
      const btn = document.getElementById('btn-export-excel'); if (btn) {
        btn.addEventListener('click', () => {
          const headers = ['ë‚ ì§œ', 'ëŒ€í–‰ì‚¬', 'ìƒí’ˆëª…', 'ìˆ˜ëŸ‰', 'ë‹¨ê°€', 'ì§€ì¶œ', 'ë§¤ì¶œ'];
          const lines = [headers.join('\t')];
          for (const r of state.previewRows) {
            lines.push([r.date, r.client, r.product, r.qty, r.price, r.expense || 0, r.income || 0].join('\t'));
          }
          const text = lines.join('\n');
          navigator.clipboard?.writeText(text);
          alert('ë³µì‚¬ ì™„ë£Œ! ì—‘ì…€ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
        });
      }
    }

    // ê²€ìƒ‰ ë Œë” ì—…ë°ì´íŠ¸
    document.getElementById('pb-search').addEventListener('input', renderPriceBook);

    // === í¬ë¦¼2 ë°°í¬ ê³„ì • ê´€ë¦¬ ===
    async function loadCream2Accounts() {
      try {
        const res = await fetch('/api/settlement/cream2-accounts');
        const data = await res.json().catch(() => ({}));
        if (res.ok && Array.isArray(data.items)) {
          state.cream2Accounts = data.items;
          console.log('âœ… í¬ë¦¼2 ê³„ì • ë¡œë“œ ì™„ë£Œ:', data.items.length, 'ê°œ');
        } else {
          state.cream2Accounts = [];
          console.warn('âš ï¸ í¬ë¦¼2 ê³„ì • ë°ì´í„° ì—†ìŒ');
        }
      } catch (e) {
        state.cream2Accounts = [];
        console.error('âŒ í¬ë¦¼2 ê³„ì • ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    }

    async function saveCream2Accounts() {
      showLoading('í¬ë¦¼2 ê³„ì • ì €ì¥ ì¤‘...');
      try {
        const res = await fetch('/api/settlement/cream2-accounts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: state.cream2Accounts })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || 'ì €ì¥ ì‹¤íŒ¨');
        toast('ì €ì¥ë¨');
        await loadCream2Accounts(); // ì €ì¥ í›„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ í™•ì‹¤í•˜ê²Œ ë°˜ì˜
        renderCream2Accounts();
      } catch (e) { alert(e.message || 'ì €ì¥ ì‹¤íŒ¨'); }
      finally { hideLoading(); }
    }

    function renderCream2Accounts() {
      const tb = document.querySelector('#tbl-cream2 tbody');
      if (!tb) return;
      tb.innerHTML = '';
      for (const it of state.cream2Accounts) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${it.client || ''}</td>
            <td>${it.account_id || ''}</td>
            <td>${Number(it.unit_price || 0).toLocaleString()}</td>
            <td>
              <button class="btn btn-sm btn-outline" data-edit="${it.client}">ìˆ˜ì •</button>
              <button class="btn btn-sm btn-outline" data-del="${it.client}">ì‚­ì œ</button>
            </td>
          `;
        tb.appendChild(tr);
      }
      tb.querySelectorAll('button[data-del]')?.forEach(btn => {
        btn.addEventListener('click', async () => {
          const client = btn.getAttribute('data-del');
          state.cream2Accounts = state.cream2Accounts.filter(x => x.client !== client);
          renderCream2Accounts();
          await saveCream2Accounts();
        });
      });
      tb.querySelectorAll('button[data-edit]')?.forEach(btn => {
        btn.addEventListener('click', () => {
          const client = btn.getAttribute('data-edit');
          const it = state.cream2Accounts.find(x => x.client === client);
          if (it) {
            document.getElementById('cream2-client').value = it.client || '';
            document.getElementById('cream2-account').value = it.account_id || '';
            document.getElementById('cream2-price').value = it.unit_price || '';
          }
        });
      });
    }

    document.getElementById('cream2-add')?.addEventListener('click', () => {
      const client = (document.getElementById('cream2-client')?.value || '').trim();
      const account_id = (document.getElementById('cream2-account')?.value || '').trim();
      const unit_price = Number(document.getElementById('cream2-price')?.value || 0);

      if (!client) return alert('ê±°ë˜ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      if (!account_id) return alert('ê³„ì • ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      if (!unit_price) return alert('ë‹¨ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”');

      const idx = state.cream2Accounts.findIndex(x => x.client === client);
      if (idx >= 0) {
        state.cream2Accounts[idx] = { client, account_id, unit_price };
      } else {
        state.cream2Accounts.push({ client, account_id, unit_price });
      }

      renderCream2Accounts();
      document.getElementById('cream2-client').value = '';
      document.getElementById('cream2-account').value = '';
      document.getElementById('cream2-price').value = '';
    });

    document.getElementById('btn-save-cream2')?.addEventListener('click', saveCream2Accounts);

    // === í¬ë¦¼2 ë°°í¬ ë©”ì‹œì§€ ìƒì„± ===
    function openCream2Modal() {
      const modal = document.getElementById('cream2-modal');
      if (!modal) return;
      modal.classList.add('show');
      generateCream2Message();
    }

    function closeCream2Modal() {
      const modal = document.getElementById('cream2-modal');
      if (modal) modal.classList.remove('show');
    }

    function generateCream2Message() {
      const content = document.getElementById('cream2-content');
      if (!content) return;

      // 'ìºë¦¬ ë°°í¬2' í•­ëª© í•„í„°ë§
      const aggs = augmentAggregatesWithExtras(state.lastAggregates || {}, state.extraExpenses || []);
      const byAgency = aggs.by_agency || {};

      // ìºë¦¬ ë°°í¬2 í•­ëª© ìˆ˜ì§‘: { client: qty }
      const cream2Data = {};
      Object.keys(byAgency).forEach(date => {
        const clients = byAgency[date] || {};
        Object.keys(clients).forEach(client => {
          const items = clients[client] || [];
          items.forEach(it => {
            const prod = (it.product || '').trim();
            // 'ìºë¦¬ ë°°í¬2' ë˜ëŠ” ìœ ì‚¬í•œ ì´ë¦„ ë§¤ì¹­
            if (prod.includes('ìºë¦¬') && prod.includes('ë°°í¬') && prod.includes('2')) {
              cream2Data[client] = (cream2Data[client] || 0) + Number(it.qty || 0);
            }
          });
        });
      });

      if (Object.keys(cream2Data).length === 0) {
        content.innerHTML = `
            <div style="text-align:center; padding:40px; color:var(--muted);">
              <div class="empty-icon">ğŸ“­</div>
              <div class="empty-title">ìºë¦¬ ë°°í¬2 í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>
              <div class="empty-desc">ì„ íƒí•œ íƒ­ì— ìºë¦¬ ë°°í¬2 ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
          `;
        return;
      }

      // ê³„ì •ë³„ ê·¸ë£¹í•‘ ë° í¬ì¸íŠ¸ ê³„ì‚°
      const DEFAULT_ACCOUNT = 'kimcy1388';
      const DEFAULT_PRICE = 550;

      const accountGroups = {}; // { account_id: { qty, unit_price } }
      let totalQty = 0;

      Object.keys(cream2Data).forEach(client => {
        const qty = cream2Data[client];
        totalQty += qty;

        // í¬ë¦¼2 ê³„ì • ì°¾ê¸°
        const account = state.cream2Accounts.find(x => x.client === client);
        if (account) {
          const aid = account.account_id;
          const price = Number(account.unit_price || DEFAULT_PRICE);
          if (!accountGroups[aid]) {
            accountGroups[aid] = { qty: 0, unit_price: price };
          }
          accountGroups[aid].qty += qty;
        } else {
          // ê¸°ë³¸ ê³„ì •
          if (!accountGroups[DEFAULT_ACCOUNT]) {
            accountGroups[DEFAULT_ACCOUNT] = { qty: 0, unit_price: DEFAULT_PRICE };
          }
          accountGroups[DEFAULT_ACCOUNT].qty += qty;
        }
      });

      // ë‚ ì§œ ìƒì„± (ì„ íƒí•œ íƒ­ ê¸°ì¤€)
      let dateStr = '';
      try {
        if (Array.isArray(state.selectedTabs) && state.selectedTabs.length) {
          const toMMDD = (s) => { const t = String(s || ''); const m = t.slice(0, 2), d = t.slice(2); return `${m}/${d}`; };
          const nums = state.selectedTabs.map(t => Number(String(t).replace(/\D/g, ''))).filter(n => !isNaN(n));
          if (nums.length) {
            nums.sort((a, b) => a - b);
            const first = String(nums[0]).padStart(4, '0');
            const last = String(nums[nums.length - 1]).padStart(4, '0');
            const fst = toMMDD(first), lst = toMMDD(last);
            dateStr = (fst === lst) ? fst : `${fst} ~ ${lst}`;
          }
        }
      } catch (e) { }

      // ë©”ì‹œì§€ ìƒì„±
      const lines = [];
      lines.push('[í¬ë¦¼2]');
      if (dateStr) lines.push(dateStr);

      // ê³„ì •ë³„ í¬ì¸íŠ¸ ì¶©ì „ ìš”ì²­
      Object.keys(accountGroups).sort().forEach(aid => {
        const g = accountGroups[aid];
        const points = g.qty * g.unit_price;
        lines.push(`${g.qty} * ${g.unit_price} = ${points.toLocaleString()} í¬ì¸íŠ¸ (${aid})`);
      });
      lines.push('');
      lines.push('ìœ„ ê³„ì • ì¶©ì „ ìš”ì²­ë“œë¦½ë‹ˆë‹¤!');
      lines.push('');
      lines.push('ì´ ì…ê¸ˆ ê¸ˆì•¡:');

      // ì´ ì…ê¸ˆ ê¸ˆì•¡ (ì´ ê±´ìˆ˜ Ã— 550ì› Ã— 1.1)
      const totalAmount = totalQty * DEFAULT_PRICE;
      const totalAmountVAT = Math.round(totalAmount * 1.1);
      lines.push(`${totalQty}ê±´ Ã— ${DEFAULT_PRICE}ì› Ã— 1.1 = ${totalAmountVAT.toLocaleString()}ì›`);

      const html = lines.map(line => `<div>${line || '&nbsp;'}</div>`).join('');
      content.innerHTML = `<div style="background:#fff; padding:16px; border-radius:8px; border:1px solid var(--line);">${html}</div>`;

      // ë³µì‚¬ìš© í…ìŠ¤íŠ¸ ì €ì¥
      window.__cream2Text = lines.join('\n');
    }

    function copyCream2ToClipboard() {
      const text = window.__cream2Text || '';
      if (!text) {
        toast('ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      navigator.clipboard?.writeText(text).then(() => {
        toast('ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
      }).catch(err => {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        toast('ë³µì‚¬ ì‹¤íŒ¨');
      });
    }

    document.getElementById('btn-cream2-message')?.addEventListener('click', openCream2Modal);

    // ì´ˆê¸°í™”: ê°€ê²©í‘œ ë¡œë“œ ë° ë Œë”
    (async function init() {
      try {
        showLoading('ì´ˆê¸°í™” ì¤‘...');
        await loadPriceBook();
        await loadCream2Accounts();
        renderPriceBook();
        renderCream2Accounts();
      } catch (e) { /* swallow */ }
      finally { hideLoading(); }
      // ì´ˆê¸° íƒ­ ìƒíƒœ ê°•ì œ: ì •ì‚°ìœ¼ë¡œ ì‹œì‘
      try { setTab('settle'); } catch (e) { }
    })();

    // ìƒë‹¨ íƒ­ ì „í™˜: ì •ì‚° / ë‹¨ê°€ ê´€ë¦¬ / ëŒ€í–‰ì‚¬ ì¡°íšŒ
    function setTab(mode) {
      const isSettle = mode === 'settle';
      const isPrice = mode === 'price';
      const isAgency = mode === 'agency';

      // íƒ­ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      try {
        const tabSettle = document.getElementById('tab-settle');
        const tabPrice = document.getElementById('tab-price');
        const tabAgency = document.getElementById('tab-agency');
        if (tabSettle) {
          tabSettle.classList.toggle('btn-primary', isSettle);
          tabSettle.classList.toggle('btn-secondary', !isSettle);
        }
        if (tabPrice) {
          tabPrice.classList.toggle('btn-primary', isPrice);
          tabPrice.classList.toggle('btn-secondary', !isPrice);
        }
        if (tabAgency) {
          tabAgency.classList.toggle('btn-primary', isAgency);
          tabAgency.classList.toggle('btn-secondary', !isAgency);
        }
      } catch (e) { }
      try { document.getElementById('side-tab-settle')?.classList.toggle('active', isSettle); } catch (e) { }
      try { document.getElementById('side-tab-price')?.classList.toggle('active', isPrice); } catch (e) { }
      try { document.getElementById('side-tab-agency')?.classList.toggle('active', isAgency); } catch (e) { }

      const statsSection = document.getElementById('settle-stats-section');
      const querySection = document.getElementById('settle-query-section');
      const precheckSection = document.getElementById('precheck-section');
      const resultsSection = document.getElementById('results-section');
      const priceContent = document.getElementById('price-content');
      const agencyContent = document.getElementById('agency-content');

      if (isSettle) {
        if (statsSection) statsSection.style.display = statsSection.dataset.hasData === 'true' ? 'block' : 'none';
        if (querySection) querySection.style.display = 'block';
        if (priceContent) priceContent.style.display = 'none';
        if (agencyContent) agencyContent.style.display = 'none';
      } else if (isPrice) {
        if (statsSection) statsSection.style.display = 'none';
        if (querySection) querySection.style.display = 'none';
        if (precheckSection) precheckSection.style.display = 'none';
        if (resultsSection) resultsSection.style.display = 'none';
        if (priceContent) priceContent.style.display = 'block';
        if (agencyContent) agencyContent.style.display = 'none';
      } else if (isAgency) {
        if (statsSection) statsSection.style.display = 'none';
        if (querySection) querySection.style.display = 'none';
        if (precheckSection) precheckSection.style.display = 'none';
        if (resultsSection) resultsSection.style.display = 'none';
        if (priceContent) priceContent.style.display = 'none';
        if (agencyContent) agencyContent.style.display = 'block';
        renderAgencyTab(); // ëŒ€í–‰ì‚¬ íƒ­ ì§„ì… ì‹œ ë Œë”ë§
      }
    }

    // ===== ëŒ€í–‰ì‚¬ íŒë§¤ ë‹¨ê°€ íƒ­ ê¸°ëŠ¥ =====
    let agencySortField = 'agency';
    let agencySortDir = 'asc';
    let apEditingIndex = -1;

    // ì •ì‚° ë°ì´í„°ì—ì„œ ëŒ€í–‰ì‚¬ íŒë§¤ ë‹¨ê°€ ìë™ ë™ê¸°í™” ì²´í¬
    async function checkAgencyPricingSync(rows) {
      if (!rows || rows.length === 0) return;

      // ëŒ€í–‰ì‚¬ ë‹¨ê°€ ë¡œë“œ (ì•„ì§ ì•ˆ ëœ ê²½ìš°)
      if (!state.agencyPricing || state.agencyPricing.length === 0) {
        await loadAgencyPricing();
      }

      // ëŒ€í–‰ì‚¬ë³„ ìƒí’ˆë³„ ë‹¨ê°€ ê³„ì‚° (income / qty) - ëª¨ë“  í•­ëª© ìˆ˜ì§‘
      const calculated = {};
      rows.forEach(r => {
        const agency = (r.agency || '').trim();
        const job = (r.job || '').trim();
        const type = (r.type || 'ê³µí†µ').trim();
        const qty = parseInt(r.qty) || 0;
        const income = parseFloat(r.income) || 0;

        if (!agency || !job || qty <= 0) return;

        const unitPrice = income > 0 ? Math.round(income / qty) : 0;
        const key = `${agency}|${job}|${type}`;
        if (!calculated[key]) {
          calculated[key] = { agency, product: job, type, price: unitPrice, qty, income };
        } else {
          // ë™ì¼ ì¡°í•© ì—¬ëŸ¬ ê±´ì´ë©´ í•©ì‚°
          calculated[key].qty += qty;
          calculated[key].income += income;
          calculated[key].price = calculated[key].income > 0 ? Math.round(calculated[key].income / calculated[key].qty) : 0;
        }
      });

      const items = Object.values(calculated);
      if (items.length === 0) return;

      // ê¸°ì¡´ ë“±ë¡ ì—¬ë¶€ ë° ìƒíƒœ ì²´í¬
      items.forEach(item => {
        const existing = state.agencyPricing.find(it =>
          it.agency === item.agency &&
          it.product === item.product &&
          (it.type || 'ê³µí†µ') === item.type
        );
        if (!existing) {
          item.status = 'new';
          item.existingPrice = null;
        } else if (existing.price !== item.price) {
          item.status = 'changed';
          item.existingPrice = existing.price;
        } else {
          item.status = 'same';
          item.existingPrice = existing.price;
        }
      });

      // í…Œì´ë¸” HTML ìƒì„±
      const tableRows = items.map((item, idx) => {
        const statusBadge = item.status === 'new'
          ? '<span style="background:var(--success); color:#fff; padding:2px 8px; border-radius:4px; font-size:11px;">ğŸ†• ì‹ ê·œ</span>'
          : item.status === 'changed'
            ? '<span style="background:var(--warning); color:#fff; padding:2px 8px; border-radius:4px; font-size:11px;">ğŸ”„ ë³€ê²½</span>'
            : '<span style="background:var(--muted); color:#fff; padding:2px 8px; border-radius:4px; font-size:11px;">âœ“ ì¼ì¹˜</span>';

        const priceDisplay = item.status === 'changed'
          ? `<span style="text-decoration:line-through; color:var(--muted);">${item.existingPrice?.toLocaleString()}</span> â†’ <strong style="color:var(--warning);">${item.price.toLocaleString()}</strong>`
          : item.status === 'new'
            ? `<strong style="color:var(--success);">${item.price.toLocaleString()}</strong>`
            : `${item.price.toLocaleString()}`;

        const checked = item.status !== 'same' ? 'checked' : '';

        return `<tr data-idx="${idx}">
          <td style="text-align:center;"><input type="checkbox" class="ap-sync-check" data-idx="${idx}" ${checked}></td>
          <td>${item.agency}</td>
          <td>${item.product}</td>
          <td><span class="pill">${item.type}</span></td>
          <td style="text-align:right;">${priceDisplay}ì›</td>
          <td style="text-align:right; color:var(--muted);">${item.qty}ê±´</td>
          <td style="text-align:right; color:var(--muted);">${item.income.toLocaleString()}ì›</td>
          <td style="text-align:center;">${statusBadge}</td>
        </tr>`;
      }).join('');

      const newCount = items.filter(i => i.status === 'new').length;
      const changedCount = items.filter(i => i.status === 'changed').length;

      // ëª¨ë‹¬ ìƒì„±
      const modal = document.createElement('div');
      modal.className = 'overlay';
      modal.style.cssText = 'display:flex; align-items:center; justify-content:center; z-index:10000;';
      modal.innerHTML = `
        <div style="background:#fff; padding:24px; border-radius:12px; max-width:900px; width:95%; max-height:85vh; overflow:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
          <h3 style="margin:0 0 16px 0; font-size:18px; color:var(--text);">ğŸ’¼ ëŒ€í–‰ì‚¬ íŒë§¤ ë‹¨ê°€ ë™ê¸°í™”</h3>
          <p style="color:var(--muted); margin-bottom:16px;">
            ì •ì‚° ë°ì´í„°ì—ì„œ <strong>${items.length}ê±´</strong>ì˜ ëŒ€í–‰ì‚¬ ë‹¨ê°€ ì •ë³´ë¥¼ ê°ì§€í–ˆìŠµë‹ˆë‹¤.
            ${newCount > 0 ? `<span style="color:var(--success);">ì‹ ê·œ ${newCount}ê±´</span>` : ''}
            ${changedCount > 0 ? `<span style="color:var(--warning); margin-left:8px;">ë³€ê²½ ${changedCount}ê±´</span>` : ''}
          </p>
          
          <div style="margin-bottom:12px; display:flex; gap:12px; align-items:center;">
            <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
              <input type="checkbox" id="ap-sync-all" checked> ì „ì²´ ì„ íƒ/í•´ì œ
            </label>
            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; margin-left:auto;">
              <input type="checkbox" id="ap-sync-only-new" checked> ì‹ ê·œ/ë³€ê²½ë§Œ ì„ íƒ
            </label>
          </div>
          
          <div style="overflow:auto; max-height:400px; border:1px solid var(--line); border-radius:8px;">
            <table class="dense" style="width:100%; min-width:700px;">
              <thead style="position:sticky; top:0; background:#f8f8f8;">
                <tr>
                  <th style="width:40px; text-align:center;">ì„ íƒ</th>
                  <th>ëŒ€í–‰ì‚¬</th>
                  <th>ìƒí’ˆëª…</th>
                  <th>ìœ í˜•</th>
                  <th style="text-align:right;">ë‹¨ê°€</th>
                  <th style="text-align:right;">ìˆ˜ëŸ‰</th>
                  <th style="text-align:right;">ê¸ˆì•¡</th>
                  <th style="text-align:center;">ìƒíƒœ</th>
                </tr>
              </thead>
              <tbody>${tableRows}</tbody>
            </table>
          </div>
          
          <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:16px;">
            <button id="ap-sync-cancel" class="btn btn-secondary">ê±´ë„ˆë›°ê¸°</button>
            <button id="ap-sync-confirm" class="btn btn-primary">âœ… ì„ íƒ í•­ëª© ì—…ë°ì´íŠ¸</button>
          </div>
        </div>`;
      document.body.appendChild(modal);

      // ì „ì²´ ì„ íƒ í† ê¸€
      const allCheck = modal.querySelector('#ap-sync-all');
      const onlyNewCheck = modal.querySelector('#ap-sync-only-new');
      const checkboxes = modal.querySelectorAll('.ap-sync-check');

      allCheck.addEventListener('change', () => {
        checkboxes.forEach(cb => cb.checked = allCheck.checked);
      });

      onlyNewCheck.addEventListener('change', () => {
        checkboxes.forEach((cb, idx) => {
          cb.checked = onlyNewCheck.checked ? items[idx].status !== 'same' : true;
        });
      });

      return new Promise(resolve => {
        modal.querySelector('#ap-sync-cancel').addEventListener('click', () => {
          modal.remove();
          resolve(false);
        });

        modal.querySelector('#ap-sync-confirm').addEventListener('click', async () => {
          // ì„ íƒëœ í•­ëª©ë§Œ ì—…ë°ì´íŠ¸
          const selectedItems = [];
          checkboxes.forEach((cb, idx) => {
            if (cb.checked) selectedItems.push(items[idx]);
          });

          if (selectedItems.length === 0) {
            toast('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤');
            return;
          }

          selectedItems.forEach(item => {
            const idx = state.agencyPricing.findIndex(it =>
              it.agency === item.agency &&
              it.product === item.product &&
              (it.type || 'ê³µí†µ') === item.type
            );
            if (idx >= 0) {
              state.agencyPricing[idx] = { ...state.agencyPricing[idx], price: item.price };
            } else {
              state.agencyPricing.push({
                agency: item.agency,
                product: item.product,
                type: item.type,
                price: item.price,
                memo: 'ì •ì‚° ë™ê¸°í™”'
              });
            }
          });

          await saveAgencyPricing();
          toast(`âœ… ëŒ€í–‰ì‚¬ ë‹¨ê°€ ${selectedItems.length}ê±´ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
          modal.remove();
          resolve(true);
        });
      });
    }

    // ëŒ€í–‰ì‚¬ íŒë§¤ ë‹¨ê°€ ë¡œë“œ
    async function loadAgencyPricing() {
      try {
        const res = await fetch('/api/agency-pricing');
        const data = await res.json().catch(() => ({}));
        if (res.ok && Array.isArray(data.items)) state.agencyPricing = data.items;
        else state.agencyPricing = [];
      } catch (e) { state.agencyPricing = []; }
    }

    // ëŒ€í–‰ì‚¬ íŒë§¤ ë‹¨ê°€ ì €ì¥
    async function saveAgencyPricing() {
      showLoading('ëŒ€í–‰ì‚¬ ë‹¨ê°€ ì €ì¥ ì¤‘...');
      try {
        const res = await fetch('/api/agency-pricing', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: state.agencyPricing })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || 'ì €ì¥ ì‹¤íŒ¨');
        toast('ëŒ€í–‰ì‚¬ ë‹¨ê°€ ì €ì¥ë¨');
      } catch (e) { alert(e.message || 'ì €ì¥ ì‹¤íŒ¨'); }
      finally { hideLoading(); }
    }

    function renderAgencyTab() {
      loadAgencyPricing().then(() => {
        renderAgencyChips();
        updateAgencyStats();
        updateAgencyDatalist();
        updatePricebookSelector();
        renderAgencyTable();
      });
    }

    // ë‹¨ê°€ ê´€ë¦¬ íƒ­ ìƒí’ˆ ëª©ë¡ì„ ë“œë¡­ë‹¤ìš´ì— ì±„ìš°ê¸°
    function updatePricebookSelector() {
      const sel = document.getElementById('ap-pricebook-select');
      if (!sel) return;
      const products = state.priceBook || [];
      const unique = [...new Map(products.map(p => [`${p.product}|${p.type || 'ê³µí†µ'}`, p])).values()];
      sel.innerHTML = '<option value="">-- ìƒí’ˆ ì„ íƒ --</option>' +
        unique.map((p, i) => `<option value="${i}">${p.product} (${p.type || 'ê³µí†µ'})</option>`).join('');
      window._pricebookProducts = unique;
    }

    // ë‹¨ê°€ ê´€ë¦¬ì—ì„œ ìƒí’ˆ ê°€ì ¸ì˜¤ê¸°
    function importFromPricebook() {
      const sel = document.getElementById('ap-pricebook-select');
      if (!sel || !sel.value) return alert('ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”');
      const idx = parseInt(sel.value);
      const p = window._pricebookProducts?.[idx];
      if (!p) return;
      document.getElementById('ap-product').value = p.product || '';
      document.getElementById('ap-type').value = p.type || 'ê³µí†µ';
      toast('ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜´ - ëŒ€í–‰ì‚¬ëª…ê³¼ ë‹¨ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
    }

    function renderAgencyChips() {
      const container = document.getElementById('agency-chips');
      if (!container) return;

      // ëŒ€í–‰ì‚¬ ëª©ë¡ ì¶”ì¶œ (ë“±ë¡ëœ ê±´ìˆ˜ ê¸°ì¤€ ìƒìœ„ 10ê°œ)
      const agencyCounts = {};
      state.agencyPricing.forEach(it => {
        const a = it.agency || '';
        if (a) agencyCounts[a] = (agencyCounts[a] || 0) + 1;
      });
      const topAgencies = Object.entries(agencyCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([name]) => name);

      container.innerHTML = topAgencies.map(a =>
        `<span class="chip" onclick="selectAgencyChip('${a.replace(/'/g, "\\'")}')">${a}</span>`
      ).join('');
    }

    window.selectAgencyChip = function (agency) {
      const input = document.getElementById('agency-search-client');
      if (input) input.value = agency;
      searchAgency();
    };

    function updateAgencyStats() {
      const agencies = new Set(state.agencyPricing.map(it => it.agency || '').filter(a => a));
      const products = new Set(state.agencyPricing.map(it => it.product || '').filter(p => p));

      const statAgencyCount = document.getElementById('stat-agency-count');
      const statProductCount = document.getElementById('stat-product-count');
      if (statAgencyCount) statAgencyCount.textContent = agencies.size;
      if (statProductCount) statProductCount.textContent = products.size;
    }

    function updateAgencyDatalist() {
      // ëŒ€í–‰ì‚¬ datalist
      const agencyList = document.getElementById('ap-agency-list');
      if (agencyList) {
        const agencies = [...new Set(state.agencyPricing.map(it => it.agency).filter(a => a))];
        agencyList.innerHTML = agencies.map(a => `<option value="${a}">`).join('');
      }
      // ìƒí’ˆ datalist
      const productList = document.getElementById('ap-product-list');
      if (productList) {
        const products = [...new Set(state.agencyPricing.map(it => it.product).filter(p => p))];
        productList.innerHTML = products.map(p => `<option value="${p}">`).join('');
      }
    }

    function searchAgency() {
      const agencyQ = (document.getElementById('agency-search-client')?.value || '').trim().toLowerCase();
      const productQ = (document.getElementById('agency-search-product')?.value || '').trim().toLowerCase();

      const filtered = state.agencyPricing.filter(it => {
        const aMatch = !agencyQ || (it.agency || '').toLowerCase().includes(agencyQ);
        const pMatch = !productQ || (it.product || '').toLowerCase().includes(productQ);
        return aMatch && pMatch;
      });

      document.getElementById('stat-search-result').textContent = filtered.length;
      renderAgencyResults(filtered);
      renderAgencyTable(filtered);
    }

    function renderAgencyResults(list) {
      const container = document.getElementById('agency-results');
      if (!container) return;

      if (!list || list.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column:1/-1;">
            <div class="empty-icon">ğŸ”</div>
            <div class="empty-title">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            <div class="empty-desc">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ìœ„ì—ì„œ ë‹¨ê°€ë¥¼ ë“±ë¡í•˜ì„¸ìš”</div>
          </div>`;
        return;
      }

      // ëŒ€í–‰ì‚¬ë³„ë¡œ ê·¸ë£¹í•‘
      const byAgency = {};
      list.forEach(it => {
        const a = it.agency || 'ë¯¸ì§€ì •';
        if (!byAgency[a]) byAgency[a] = [];
        byAgency[a].push(it);
      });

      // ì¹´ë“œ ìƒì„± (ìƒìœ„ 6ê°œ ëŒ€í–‰ì‚¬ë§Œ)
      const agencyEntries = Object.entries(byAgency).slice(0, 6);
      container.innerHTML = agencyEntries.map(([agency, items]) => {
        const productList = items.slice(0, 5).map(it =>
          `<div style="display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid var(--line);">
            <span>${it.product || '-'}</span>
            <span style="font-weight:600; color:var(--success);">${(it.price || 0).toLocaleString()}ì›</span>
          </div>`
        ).join('');
        const moreCount = items.length - 5;
        const moreText = moreCount > 0 ? `<div class="muted" style="font-size:12px; margin-top:8px;">+${moreCount}ê°œ ë”ë³´ê¸°</div>` : '';

        return `
          <div class="card" style="cursor:pointer;" onclick="selectAgencyChip('${agency.replace(/'/g, "\\'")}')">
            <div style="font-weight:700; font-size:16px; margin-bottom:12px; color:var(--text);">
              ğŸ¢ ${agency}
              <span class="pill" style="margin-left:8px; font-size:11px; background:var(--success); color:#fff;">${items.length}ê°œ ìƒí’ˆ</span>
            </div>
            ${productList}
            ${moreText}
          </div>`;
      }).join('');
    }

    function renderAgencyTable(list) {
      const tb = document.querySelector('#tbl-agency-view tbody');
      if (!tb) return;

      const data = list || state.agencyPricing;
      if (!data || data.length === 0) {
        tb.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--muted);">ë“±ë¡ëœ ë‹¨ê°€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
      }

      // ì •ë ¬
      const sorted = [...data].sort((a, b) => {
        let va = a[agencySortField] || '';
        let vb = b[agencySortField] || '';
        if (agencySortField === 'price') {
          va = parseFloat(va) || 0;
          vb = parseFloat(vb) || 0;
        } else {
          va = String(va).toLowerCase();
          vb = String(vb).toLowerCase();
        }
        const cmp = va < vb ? -1 : (va > vb ? 1 : 0);
        return agencySortDir === 'asc' ? cmp : -cmp;
      });

      tb.innerHTML = sorted.map((it, idx) => {
        const origIdx = state.agencyPricing.indexOf(it);
        return `
        <tr>
          <td style="font-weight:600;">${it.agency || '-'}</td>
          <td>${it.product || '-'}</td>
          <td><span class="pill">${it.type || 'ê³µí†µ'}</span></td>
          <td style="font-weight:600; color:var(--success);">${(it.price || 0).toLocaleString()}ì›</td>
          <td>${it.memo || '-'}</td>
          <td>
            <button class="btn btn-sm btn-outline" onclick="editAgencyPricing(${origIdx})">ìˆ˜ì •</button>
            <button class="btn btn-sm btn-outline" onclick="deleteAgencyPricing(${origIdx})">ì‚­ì œ</button>
          </td>
        </tr>`;
      }).join('');
    }

    window.sortAgencyTable = function (field) {
      if (agencySortField === field) {
        agencySortDir = agencySortDir === 'asc' ? 'desc' : 'asc';
      } else {
        agencySortField = field;
        agencySortDir = 'asc';
      }
      searchAgency();
    };

    // ëŒ€í–‰ì‚¬ ë‹¨ê°€ ì¶”ê°€
    window.addAgencyPricing = async function () {
      const agency = (document.getElementById('ap-agency')?.value || '').trim();
      const product = (document.getElementById('ap-product')?.value || '').trim();
      const type = (document.getElementById('ap-type')?.value || 'ê³µí†µ');
      const price = Number((document.getElementById('ap-price')?.value || '0').replace(/,/g, '')) || 0;
      const memo = (document.getElementById('ap-memo')?.value || '').trim();

      if (!agency) return alert('ëŒ€í–‰ì‚¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
      if (!product) return alert('ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”');

      if (apEditingIndex >= 0) {
        // ìˆ˜ì • ëª¨ë“œ
        state.agencyPricing[apEditingIndex] = { agency, product, type, price, memo };
        apEditingIndex = -1;
        document.getElementById('ap-add-btn').textContent = 'â• ì¶”ê°€';
      } else {
        // ì‹ ê·œ ë“±ë¡ (ì¤‘ë³µ ì²´í¬: ëŒ€í–‰ì‚¬ + ìƒí’ˆ + ìœ í˜•)
        const dupIdx = state.agencyPricing.findIndex(it => it.agency === agency && it.product === product && (it.type || 'ê³µí†µ') === type);
        if (dupIdx >= 0) {
          if (!confirm('ì´ë¯¸ ë“±ë¡ëœ ëŒ€í–‰ì‚¬/ìƒí’ˆ/ìœ í˜•ì…ë‹ˆë‹¤. ë®ì–´ì“¸ê¹Œìš”?')) return;
          state.agencyPricing[dupIdx] = { agency, product, type, price, memo };
        } else {
          state.agencyPricing.push({ agency, product, type, price, memo });
        }
      }

      clearAgencyForm();
      updateAgencyDatalist();
      updateAgencyStats();
      renderAgencyChips();
      renderAgencyTable();
      await saveAgencyPricing();
    };

    // ëŒ€í–‰ì‚¬ ë‹¨ê°€ ìˆ˜ì • (í¼ì— ë¡œë“œ)
    window.editAgencyPricing = function (idx) {
      const it = state.agencyPricing[idx];
      if (!it) return;
      document.getElementById('ap-agency').value = it.agency || '';
      document.getElementById('ap-product').value = it.product || '';
      document.getElementById('ap-type').value = it.type || 'ê³µí†µ';
      document.getElementById('ap-price').value = it.price || '';
      document.getElementById('ap-memo').value = it.memo || '';
      apEditingIndex = idx;
      document.getElementById('ap-add-btn').textContent = 'âœï¸ ìˆ˜ì •';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // ëŒ€í–‰ì‚¬ ë‹¨ê°€ ì‚­ì œ
    window.deleteAgencyPricing = async function (idx) {
      const it = state.agencyPricing[idx];
      if (!it) return;
      if (!confirm(`${it.agency} - ${it.product} ë‹¨ê°€ë¥¼ ì‚­ì œí• ê¹Œìš”?`)) return;
      state.agencyPricing.splice(idx, 1);
      updateAgencyStats();
      renderAgencyChips();
      renderAgencyTable();
      await saveAgencyPricing();
    };

    function clearAgencyForm() {
      document.getElementById('ap-agency').value = '';
      document.getElementById('ap-product').value = '';
      document.getElementById('ap-type').value = 'ê³µí†µ';
      document.getElementById('ap-price').value = '';
      document.getElementById('ap-memo').value = '';
      document.getElementById('ap-pricebook-select').value = '';
      apEditingIndex = -1;
      document.getElementById('ap-add-btn').textContent = 'â• ì¶”ê°€';
    }

    // ëŒ€í–‰ì‚¬ íƒ­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    document.getElementById('btn-agency-search')?.addEventListener('click', searchAgency);
    document.getElementById('btn-agency-reset')?.addEventListener('click', () => {
      document.getElementById('agency-search-client').value = '';
      document.getElementById('agency-search-product').value = '';
      document.getElementById('stat-search-result').textContent = '0';
      document.getElementById('agency-results').innerHTML = '';
      renderAgencyTable();
    });
    document.getElementById('agency-search-client')?.addEventListener('keypress', e => { if (e.key === 'Enter') searchAgency(); });
    document.getElementById('agency-search-product')?.addEventListener('keypress', e => { if (e.key === 'Enter') searchAgency(); });
    document.getElementById('ap-add-btn')?.addEventListener('click', addAgencyPricing);
    document.getElementById('ap-clear-btn')?.addEventListener('click', clearAgencyForm);
    document.getElementById('btn-save-agency-pricing')?.addEventListener('click', saveAgencyPricing);
    document.getElementById('ap-import-product')?.addEventListener('click', importFromPricebook);

    // íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸
    const tSettle = document.getElementById('tab-settle'); if (tSettle) { tSettle.addEventListener('click', () => setTab('settle')); }
    const tPrice = document.getElementById('tab-price'); if (tPrice) { tPrice.addEventListener('click', () => setTab('price')); }
    const tAgency = document.getElementById('tab-agency'); if (tAgency) { tAgency.addEventListener('click', () => setTab('agency')); }
    const sSettle = document.getElementById('side-tab-settle'); if (sSettle) { sSettle.addEventListener('click', () => setTab('settle')); }
    const sPrice = document.getElementById('side-tab-price'); if (sPrice) { sPrice.addEventListener('click', () => setTab('price')); }
    const sAgency = document.getElementById('side-tab-agency'); if (sAgency) { sAgency.addEventListener('click', () => setTab('agency')); }
  </script>
</body>

</html>