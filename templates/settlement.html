<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>결재선 · 정산</title>
    <style>
      :root{ --bg:#ffffff; --text:#1f2328; --muted:#6b778c; --line:#e5e7eb; --panel:#ffffff; --pill:#f6f8fa; --btn:#111827; }
      html,body{ height:100% }
      body{ margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, "Noto Sans KR", Arial; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
      .content{ flex:1; padding:24px; }
      .title{ font-weight:800; letter-spacing:.2px; font-size:18px; margin-bottom:16px; }
      .home-link{ color:inherit; text-decoration:none; }
      .home-link:hover{ text-decoration:underline; }
      .nav a{ display:block; padding:10px 12px; border-radius:10px; color:inherit; text-decoration:none; margin-bottom:6px; border:1px solid var(--line); background:var(--pill); }
      .nav a.active{ background:#111827; color:#fff; border-color:#111827; }
      .panel{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:16px; }
      .stack{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
      input[type="text"], input[type="date"], select{ background:#fff; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px; min-width:200px; outline:none; }
      .btn{ border:1px solid var(--line); background:#fff; color:#111827; padding:10px 14px; border-radius:10px; cursor:pointer; }
      .btn-primary{ background:#111827; color:#fff; border-color:#111827; }
      .muted{ color:var(--muted); }
      .pill{ border:1px solid var(--line); background:var(--pill); color:var(--text); padding:6px 10px; border-radius:999px; font-size:12px; }
      .grid{ display:grid; gap:12px; }
      @media(min-width:1100px){ .grid{ grid-template-columns: 1fr 1fr; } }
      table{ width:100%; border-collapse: collapse; }
      th, td{ border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; }
      th{ font-size:12px; color:var(--muted); font-weight:600; }
      .chips{ display:flex; gap:8px; flex-wrap:wrap; }
      .chip{ border:1px solid var(--line); background:var(--pill); color:var(--text); padding:8px 12px; border-radius:999px; cursor:pointer; font-size:12px; }
      .chip.active{ background:#111827; color:#fff; border-color:#111827; }
      .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.08); backdrop-filter: blur(2px); z-index:50; }
      .spinner{ width:34px; height:34px; border:3px solid rgba(17,24,39,.18); border-top-color:#111827; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 10px; }
      .progress{ width:260px; height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin:8px auto 0; }
      .progress-bar{ height:100%; width:0%; background:#111827; transition:width .2s ease; }
      @keyframes spin{ to{ transform:rotate(360deg); } }
      /* 페이지 2열 레이아웃 */
      .page{ display:flex; gap:16px; align-items:flex-start; }
      .subnav{ width:220px; border:1px solid var(--line); background:#fff; border-radius:12px; padding:12px; }
      .subnav .title-sm{ font-weight:700; margin-bottom:10px; }
      .subnav .vtab{ display:block; width:100%; text-align:left; padding:10px 12px; border:1px solid var(--line); background:var(--pill); border-radius:10px; margin-bottom:8px; cursor:pointer; }
      .subnav .vtab.active{ background:#111827; color:#fff; border-color:#111827; }
      .maincol{ flex:1; min-width:0; }
      /* 모바일: 좌측 탭 숨기고 상단 탭 표시 */
      .tabbar{ display:none; }
      @media(max-width:900px){
        .page{ display:block; }
        .subnav{ display:none; }
        .tabbar{ display:block; }
      }
    </style>
  </head>
  <body>
    <div class="content" style="max-width:1100px; margin:0 auto; padding:24px">
      <div class="title"><a class="home-link" href="/">마감 안내 생성기</a> · <a class="home-link" href="/manage">보장 관리</a> · <a class="home-link" href="/settlement" style="font-weight:600">결재선 · 정산</a></div>

      <div class="page">
        <aside class="subnav">
          <div class="title-sm">결재선</div>
          <button id="side-tab-settle" class="vtab active" type="button">정산</button>
          <button id="side-tab-price" class="vtab" type="button">단가 관리</button>
        </aside>
        <div class="maincol">
          <!-- 모바일 상단 탭: 데스크톱에서는 숨김 -->
          <div id="tabbar" class="panel tabbar" style="margin-bottom:12px">
            <div class="stack" style="justify-content:flex-start">
              <button id="tab-settle" class="btn btn-primary" type="button">정산</button>
              <button id="tab-price" class="btn" type="button">단가 관리</button>
            </div>
          </div>

          <!-- 1) 중앙 히어로: 탭 불러오기/기간/가져오기만 표시 (정산 탭에서만 보임) -->
          <div id="hero" class="panel" style="margin-bottom:12px; display:block">
            <div class="stack" style="align-items:flex-end">
              <div>
                <label>구글 시트 하단 탭</label>
                <div class="stack">
                  <button id="load-tabs" class="btn">탭 불러오기</button>
                  <span id="tab-count" class="pill">0개</span>
                </div>
              </div>
              <div style="flex:1; min-width:260px">
                <label>탭(날짜) 선택</label>
                <div id="tab-chips" class="chips"></div>
              </div>
              <div class="stack">
                <button id="select-range" class="btn">기간 선택</button>
                <span id="selected-range" class="muted" style="font-size:12px"></span>
              </div>
              <button id="fetch-data" class="btn btn-primary">데이터 가져오기</button>
            </div>
            <div class="muted" style="margin-top:8px; font-size:12px">탭명은 날짜(예: 2025-10-06) 형식을 권장합니다.</div>
          </div>

          <!-- 2) 단가 관리: 상단/좌측 탭에서 전환 시 표시 -->
          <div id="price-panel" class="panel" style="display:none; margin-bottom:12px">
            <div class="stack" style="justify-content:space-between">
              <div class="muted">거래처별 계좌 · 상품별 단가</div>
              <div class="stack">
                <button id="btn-add-price" class="btn">상품 추가</button>
                <button id="btn-save-price" class="btn btn-primary">저장</button>
                <button id="btn-import-price" class="btn">가져오기</button>
                <button id="btn-export-price" class="btn">내보내기</button>
              </div>
            </div>
            <!-- 인라인 에디터 -->
            <div class="panel" style="margin-top:10px">
              <div class="stack" style="align-items:flex-end; gap:10px; flex-wrap:wrap">
                <div>
                  <label>거래처</label>
                  <input id="pb-client" type="text" placeholder="예: 레알마케팅" />
                </div>
                <div>
                  <label>상품명</label>
                  <input id="pb-product" type="text" placeholder="예: 일류1" />
                </div>
                <div>
                  <label>단가</label>
                  <input id="pb-price" type="text" placeholder="예: 1750" />
                </div>
                <div style="min-width:200px">
                  <label>계좌</label>
                  <input id="pb-account" type="text" placeholder="선택" />
                </div>
                <div class="stack" style="gap:8px">
                  <label style="margin:0; color:var(--muted); font-size:12px">유형</label>
                  <label class="muted" style="display:flex; align-items:center; gap:4px"><input type="radio" name="pb-type" value="공통" checked />공통</label>
                  <label class="muted" style="display:flex; align-items:center; gap:4px"><input type="radio" name="pb-type" value="저장" />저장</label>
                  <label class="muted" style="display:flex; align-items:center; gap:4px"><input type="radio" name="pb-type" value="트래픽" />트래픽</label>
                </div>
                <div class="stack">
                  <button id="pb-add-one" class="btn btn-primary" type="button">추가</button>
                  <button id="pb-add-both" class="btn" type="button">저장·트래픽 동시 추가</button>
                </div>
                <div style="margin-left:auto">
                  <label>검색</label>
                  <input id="pb-search" type="text" placeholder="거래처/상품 검색" />
                </div>
              </div>
            </div>
            <div style="overflow:auto; margin-top:8px">
              <table id="tbl-price">
                <thead>
                  <tr>
                    <th>거래처</th>
                    <th>상품명</th>
                    <th>유형</th>
                    <th>단가</th>
                    <th>계좌</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        
          <!-- 3) 정산 미리보기(페이지 하단 표시) -->
          <div id="results-panel" class="panel" style="display:none; margin-bottom:12px">
            <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:8px">
              <div class="stack" style="gap:8px">
                <button id="pv-tab-rows" class="btn btn-primary" type="button">행 보기</button>
                <button id="pv-tab-product" class="btn" type="button">상품별</button>
                <button id="pv-tab-agency" class="btn" type="button">대행사별</button>
              </div>
              <div class="stack" style="gap:8px">
                <button id="btn-export-excel" class="btn">엑셀 양식 복붙</button>
              </div>
            </div>
            <!-- 정렬 컨트롤: 상품별 -->
            <div id="sort-product" class="stack" style="gap:8px; margin-bottom:8px; display:none">
              <label class="muted" style="margin:0">상품별 정렬</label>
              <select id="sp-key">
                <option value="qty">접수량</option>
                <option value="expense">지출</option>
                <option value="income">매출</option>
              </select>
              <select id="sp-order">
                <option value="desc">내림차순</option>
                <option value="asc">오름차순</option>
              </select>
            </div>
            <!-- 정렬 컨트롤: 대행사별 -->
            <div id="sort-agency" class="stack" style="gap:8px; margin-bottom:8px; display:none">
              <label class="muted" style="margin:0">대행사별 정렬</label>
              <select id="sa-key">
                <option value="client">대행사</option>
                <option value="product">상품명</option>
                <option value="qty">수량</option>
                <option value="expense">지출</option>
                <option value="income">매출</option>
              </select>
              <select id="sa-order">
                <option value="asc">오름차순</option>
                <option value="desc">내림차순</option>
              </select>
            </div>
            <!-- 행 보기 -->
            <div style="overflow:auto">
              <table id="tbl-preview" style="width:100%">
                <thead>
                  <tr>
                    <th>날짜</th>
                    <th>대행사</th>
                    <th>상품명</th>
                    <th>수량</th>
                    <th>단가</th>
                    <th>지출</th>
                    <th>매출</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <th colspan="6" style="text-align:right">총 지출</th>
                    <th id="grand-total">0</th>
                  </tr>
                </tfoot>
              </table>
            </div>
            <!-- 상품별 보기 -->
            <div style="overflow:auto">
              <table id="tbl-product" style="width:100%; display:none">
                <thead>
                  <tr>
                    <th>날짜</th>
                    <th>상품명</th>
                    <th>총 접수량</th>
                    <th>지출</th>
                    <th>매출</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <!-- 대행사별 보기 -->
            <div style="overflow:auto">
              <table id="tbl-agency" style="width:100%; display:none">
                <thead>
                  <tr>
                    <th>날짜</th>
                    <th>대행사</th>
                    <th>상품명</th>
                    <th>유형</th>
                    <th>수량</th>
                    <th>단가</th>
                    <th>지출</th>
                    <th>매출</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="overlay" id="overlay">
      <div class="center">
        <div class="spinner"></div>
        <div class="muted" id="progress-text">불러오는 중...</div>
        <div class="progress"><div class="progress-bar" id="progress-bar"></div></div>
      </div>
    </div>

    <script>
      // 상태 저장소 (임시: 클라이언트 메모리)
      const state = {
        tabs: [], // 시트 탭명
        selectedTabs: [], // 선택된 탭
        priceBook: [], // { client, product, price, account }
        previewRows: [] // { date, client, agency, product, qty, price, amount }
      };

      const $ = (s)=>document.querySelector(s);
      const overlay = document.getElementById('overlay');
      const pbar = document.getElementById('progress-bar');
      const ptxt = document.getElementById('progress-text');
      const modalPreview = document.getElementById('preview-modal');

      function showLoading(msg){ overlay.style.display='flex'; if(ptxt) ptxt.textContent = msg||'불러오는 중...'; if(pbar) pbar.style.width='15%'; }
      function setProgress(pct, msg){ if(pbar){ pbar.style.width = Math.max(0, Math.min(100, pct))+'%'; } if(msg && ptxt){ ptxt.textContent = msg; } }
      function hideLoading(){ overlay.style.display='none'; if(pbar) pbar.style.width='0%'; }

      // 1) 탭 불러오기 (API 연동 예정)
      $('#load-tabs').addEventListener('click', async()=>{
        showLoading('탭 목록을 불러오는 중...');
        try{
          const res = await fetch('/api/settlement/tabs');
          const data = await res.json().catch(()=>({}));
          if(!res.ok) throw new Error(data?.error||'탭 조회 실패');
          state.tabs = Array.isArray(data.tabs) ? data.tabs : [];
          renderTabChips();
          $('#tab-count').textContent = `${state.tabs.length}개`;
          setProgress(100, '완료');
        }catch(e){ alert(e.message||'탭 불러오기 실패'); }
        finally{ hideLoading(); }
      });

      function renderTabChips(){
        const wrap = document.getElementById('tab-chips');
        if(!wrap) return;
        wrap.innerHTML = '';
        state.tabs.forEach(tab=>{
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'chip';
          btn.textContent = tab;
          const active = state.selectedTabs.includes(tab);
          if(active) btn.classList.add('active');
          btn.addEventListener('click', ()=>{
            const i = state.selectedTabs.indexOf(tab);
            if(i>=0) state.selectedTabs.splice(i,1); else state.selectedTabs.push(tab);
            renderTabChips();
          });
          wrap.appendChild(btn);
        });
      }

      // 기간 선택 (간단 데모)
      $('#select-range').addEventListener('click', ()=>{
        const opts = [...state.tabs].sort();
        if(opts.length===0){ $('#selected-range').textContent=''; return; }
        const first = opts[0], last = opts[opts.length-1];
        $('#selected-range').textContent = `${first} ~ ${last}`;
        state.selectedTabs = opts;
        renderTabChips();
      });

      // 2) 데이터 가져오기
      $('#fetch-data').addEventListener('click', async()=>{
        showLoading('정산 데이터를 준비 중...'); setProgress(25);
        try{
          const res = await fetch('/api/settlement/compute', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tabs: state.selectedTabs }) });
          const data = await res.json().catch(()=>({}));
          if(!res.ok) throw new Error(data?.error||'집계 실패');
          // data.rows: {date, client, job, type, qty, unit_price, expense, income}
          const rows = Array.isArray(data.rows) ? data.rows : [];
          state.previewRows = rows.map(r=>({ date: r.date, client: r.client, agency: '', product: (r.type?`${r.job} ${r.type}`:r.job), qty: r.qty, price: r.unit_price, amount: r.expense }));
          renderPreview();
          renderAggregates(data?.aggregates||{});
          try{ modalPreview.style.display='flex'; }catch(e){}
        }catch(e){ alert(e.message||'집계 실패'); }
        finally{ setProgress(100, '완료'); hideLoading(); }
      });

      document.getElementById('btn-close-preview').addEventListener('click', ()=>{ try{ modalPreview.style.display='none'; }catch(e){} });

      function renderAggregates(aggs){
        try{
          const byProduct = aggs?.by_product||{}; const tb1 = document.querySelector('#tbl-product tbody'); tb1.innerHTML='';
          Object.keys(byProduct).sort().forEach(date=>{
            const map = byProduct[date]||{}; Object.keys(map).sort().forEach(prod=>{
              const v = map[prod]||{}; const tr=document.createElement('tr');
              tr.innerHTML = `<td>${date}</td><td>${prod}</td><td>${v.qty||0}</td><td>${v.expense||0}</td><td>${v.income||0}</td>`; tb1.appendChild(tr);
            });
          });
          const byAgency = aggs?.by_agency||{}; const tb2 = document.querySelector('#tbl-agency tbody'); tb2.innerHTML='';
          Object.keys(byAgency).sort().forEach(date=>{
            const map = byAgency[date]||{}; Object.keys(map).sort().forEach(client=>{
              const arr = map[client]||[]; arr.forEach(it=>{
                const tr=document.createElement('tr');
                tr.innerHTML = `<td>${date}</td><td>${client}</td><td>${it.product||''}</td><td>${it.type||''}</td><td>${it.qty||0}</td><td>${it.unit_price||0}</td><td>${it.expense||0}</td><td>${it.income||0}</td>`; tb2.appendChild(tr);
              });
            });
          });
        }catch(e){}
      }

      // 모달 탭 전환
      function setPvTab(name){
        const ids = ['rows','product','agency'];
        ids.forEach(id=>{
          document.getElementById('pv-tab-'+id)?.classList.toggle('btn-primary', id===name);
          const el = document.getElementById('tbl-'+id);
          if(el){ el.style.display = (id===name? 'table' : 'none'); if(id!=='rows') el.style.marginTop = '8px'; }
        });
      }
      document.getElementById('pv-tab-rows').addEventListener('click', ()=>setPvTab('rows'));
      document.getElementById('pv-tab-product').addEventListener('click', ()=>setPvTab('product'));
      document.getElementById('pv-tab-agency').addEventListener('click', ()=>setPvTab('agency'));

      // 단가부: 추가/삭제/입출력 (로컬 메모리)
      $('#btn-add-price').addEventListener('click', ()=>{
        // 인라인 입력값 읽기
        const client = (document.getElementById('pb-client')?.value||'').trim(); if(!client) return alert('거래처를 입력하세요');
        const product = (document.getElementById('pb-product')?.value||'').trim(); if(!product) return alert('상품명을 입력하세요');
        const price = Number((document.getElementById('pb-price')?.value||'0').replace(/,/g,''))||0;
        const account = (document.getElementById('pb-account')?.value||'').trim();
        const type = (document.querySelector('input[name="pb-type"]:checked')?.value)||'공통';
        upsertPrice({ client, product, price, account, type });
        renderPriceBook();
      });
      document.getElementById('pb-add-both').addEventListener('click', ()=>{
        const client = (document.getElementById('pb-client')?.value||'').trim(); if(!client) return alert('거래처를 입력하세요');
        const product = (document.getElementById('pb-product')?.value||'').trim(); if(!product) return alert('상품명을 입력하세요');
        const price = Number((document.getElementById('pb-price')?.value||'0').replace(/,/g,''))||0;
        const account = (document.getElementById('pb-account')?.value||'').trim();
        upsertPrice({ client, product, price, account, type:'저장' });
        upsertPrice({ client, product, price, account, type:'트래픽' });
        renderPriceBook();
      });
      $('#btn-export-price').addEventListener('click', ()=>{
        const json = JSON.stringify(state.priceBook, null, 2);
        navigator.clipboard?.writeText(json);
        alert('단가표 JSON을 클립보드로 복사했습니다.');
      });
      $('#btn-import-price').addEventListener('click', async()=>{
        const json = prompt('단가표 JSON을 붙여넣으세요');
        if(!json) return;
        try{ const arr = JSON.parse(json); if(Array.isArray(arr)) state.priceBook = arr; }catch(e){ alert('JSON 파싱 실패'); }
        renderPriceBook();
      });
      $('#btn-save-price').addEventListener('click', async()=>{
        showLoading('단가표 저장 중...');
        try{
          const res = await fetch('/api/settlement/pricebook', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ items: state.priceBook }) });
          const data = await res.json().catch(()=>({}));
          if(!res.ok) throw new Error(data?.error||'저장 실패');
          alert('저장 완료');
        }catch(e){ alert(e.message||'저장 실패'); }
        finally{ hideLoading(); }
      });

      function upsertPrice(item){
        const idx = state.priceBook.findIndex(x=>x.client===item.client && x.product===item.product && (String(x.type||'공통')===String(item.type||'공통')));
        if(idx>=0){ state.priceBook[idx] = item; } else { state.priceBook.push(item); }
      }
      function removePrice(client, product){
        state.priceBook = state.priceBook.filter(x=> !(x.client===client && x.product===product));
      }
      function lookupPrice(client, product){
        const it = state.priceBook.find(x=>x.client===client && x.product===product);
        return it ? it.price : null;
      }

      async function loadPriceBook(){
        try{
          const res = await fetch('/api/settlement/pricebook');
          const data = await res.json().catch(()=>({}));
          if(res.ok && Array.isArray(data.items)) state.priceBook = data.items; else state.priceBook = [];
        }catch(e){ state.priceBook = []; }
      }

      function renderPriceBook(){
        const tb = document.querySelector('#tbl-price tbody');
        tb.innerHTML = '';
        for(const it of state.priceBook){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${it.client||''}</td>
            <td>${it.product||''}</td>
            <td>${it.type||'공통'}</td>
            <td>${it.price??''}</td>
            <td>${it.account||''}</td>
            <td><button class="btn" data-del="${it.client}|||${it.product}">삭제</button></td>
          `;
          tb.appendChild(tr);
        }
        tb.querySelectorAll('button[data-del]')?.forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const [c,p] = btn.getAttribute('data-del').split('|||');
            removePrice(c, p); renderPriceBook();
          });
        });
      }

      function renderPreview(){
        const tb = document.querySelector('#tbl-preview tbody');
        tb.innerHTML = '';
        let total = 0;
        for(const r of state.previewRows){
          total += (r.amount||0);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.date}</td>
            <td>${r.client}</td>
            <td>${r.agency}</td>
            <td>${r.product}</td>
            <td>${r.qty}</td>
            <td>${r.price}</td>
            <td>${r.amount}</td>
          `;
          tb.appendChild(tr);
        }
        document.getElementById('grand-total').textContent = String(total);
      }

      // 4) 엑셀 양식 복붙용 생성 (간단 CSV 형태)
      document.getElementById('btn-export-excel').addEventListener('click', ()=>{
        const headers = ['날짜','거래처','대행사','상품명','수량','단가','금액'];
        const lines = [headers.join('\t')];
        for(const r of state.previewRows){
          lines.push([r.date, r.client, r.agency, r.product, r.qty, r.price, r.amount].join('\t'));
        }
        const text = lines.join('\n');
        navigator.clipboard?.writeText(text);
        alert('복사 완료! 엑셀에 붙여넣기 하세요.');
      });

      // 초기화: 가격표 로드 및 렌더
      (async function init(){
        showLoading('초기화 중...');
        await loadPriceBook();
        renderPriceBook();
        hideLoading();
      })();

      // 상단 탭 전환: 정산 / 단가 관리
      function setTab(mode){
        const isSettle = mode==='settle';
        try{ document.getElementById('tab-settle')?.classList.toggle('btn-primary', isSettle); }catch(e){}
        try{ document.getElementById('tab-price')?.classList.toggle('btn-primary', !isSettle); }catch(e){}
        try{ document.getElementById('side-tab-settle')?.classList.toggle('active', isSettle); }catch(e){}
        try{ document.getElementById('side-tab-price')?.classList.toggle('active', !isSettle); }catch(e){}
        document.getElementById('price-panel').style.display = isSettle ? 'none' : 'block';
        document.getElementById('hero').style.display = isSettle ? 'block' : 'none';
      }
      document.getElementById('tab-settle').addEventListener('click', ()=>{
        setTab('settle');
      });
      document.getElementById('tab-price').addEventListener('click', ()=>{
        setTab('price');
      });
      document.getElementById('side-tab-settle').addEventListener('click', ()=>{ setTab('settle'); });
      document.getElementById('side-tab-price').addEventListener('click', ()=>{ setTab('price'); });
    </script>
  </body>
  </html>


