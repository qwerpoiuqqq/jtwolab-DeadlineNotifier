<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>결재선 · 정산</title>
    <style>
      :root{ --bg:#ffffff; --text:#1f2328; --muted:#6b778c; --line:#e5e7eb; --panel:#ffffff; --pill:#f6f8fa; --btn:#111827; }
      html,body{ height:100% }
      body{ margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, "Noto Sans KR", Arial; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
      .content{ flex:1; padding:24px; }
      .title{ font-weight:800; letter-spacing:.2px; font-size:18px; margin-bottom:16px; }
      .home-link{ color:inherit; text-decoration:none; }
      .home-link:hover{ text-decoration:underline; }
      .nav a{ display:block; padding:10px 12px; border-radius:10px; color:inherit; text-decoration:none; margin-bottom:6px; border:1px solid var(--line); background:var(--pill); }
      .nav a.active{ background:#111827; color:#fff; border-color:#111827; }
      .panel{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:16px; }
      .stack{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
      input[type="text"], input[type="date"], select{ background:#fff; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px; min-width:200px; outline:none; }
      .btn{ border:1px solid var(--line); background:#fff; color:#111827; padding:10px 14px; border-radius:10px; cursor:pointer; }
      .btn-primary{ background:#111827; color:#fff; border-color:#111827; }
      .muted{ color:var(--muted); }
      .pill{ border:1px solid var(--line); background:var(--pill); color:var(--text); padding:6px 10px; border-radius:999px; font-size:12px; }
      .grid{ display:grid; gap:12px; }
      @media(min-width:1100px){ .grid{ grid-template-columns: 1fr 1fr; } }
      .cards{ display:grid; gap:12px; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); }
      .card{ border:1px solid var(--line); border-radius:10px; background:#fff; }
      .card .card-hd{ display:flex; justify-content:space-between; align-items:center; padding:10px 12px; cursor:pointer; }
      .card .card-bd{ padding:0 12px 12px 12px; }
      .card.collapsed .card-bd{ display:none; }
      .mini{ font-size:12px; }
      table{ width:100%; border-collapse: collapse; }
      th, td{ border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; }
      th{ font-size:12px; color:var(--muted); font-weight:600; }
      .chips{ display:flex; gap:8px; flex-wrap:wrap; }
      .chip{ border:1px solid var(--line); background:var(--pill); color:var(--text); padding:8px 12px; border-radius:999px; cursor:pointer; font-size:12px; }
      .chip.active{ background:#111827; color:#fff; border-color:#111827; }
      .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.08); backdrop-filter: blur(2px); z-index:50; }
      .spinner{ width:34px; height:34px; border:3px solid rgba(17,24,39,.18); border-top-color:#111827; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 10px; }
      .progress{ width:260px; height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin:8px auto 0; }
      .progress-bar{ height:100%; width:0%; background:#111827; transition:width .2s ease; }
      @keyframes spin{ to{ transform:rotate(360deg); } }
      /* 페이지 2열 레이아웃 */
      .page{ display:flex; gap:16px; align-items:flex-start; }
      .subnav{ width:220px; border:1px solid var(--line); background:#fff; border-radius:12px; padding:12px; }
      .subnav .title-sm{ font-weight:700; margin-bottom:10px; }
      .subnav .vtab{ display:block; width:100%; text-align:left; padding:10px 12px; border:1px solid var(--line); background:var(--pill); border-radius:10px; margin-bottom:8px; cursor:pointer; }
      .subnav .vtab.active{ background:#111827; color:#fff; border-color:#111827; }
      .maincol{ flex:1; min-width:0; }
      /* 모바일: 좌측 탭 숨기고 상단 탭 표시 */
      .tabbar{ display:none; }
      @media(max-width:900px){
        .page{ display:block; }
        .subnav{ display:none; }
        .tabbar{ display:block; }
      }
    </style>
  </head>
  <body>
    <div class="content" style="max-width:1100px; margin:0 auto; padding:24px">
      <div class="title"><a class="home-link" href="/">마감 안내 생성기</a> · <a class="home-link" href="/manage">보장 관리</a> · <a class="home-link" href="/settlement" style="font-weight:600">결재선 · 정산</a></div>

      <div class="page">
        <aside class="subnav">
          <div class="title-sm">결재선</div>
          <button id="side-tab-settle" class="vtab active" type="button">정산</button>
          <button id="side-tab-price" class="vtab" type="button">단가 관리</button>
        </aside>
        <div class="maincol">
          <!-- 모바일 상단 탭: 데스크톱에서는 숨김 -->
          <div id="tabbar" class="panel tabbar" style="margin-bottom:12px">
            <div class="stack" style="justify-content:flex-start">
              <button id="tab-settle" class="btn btn-primary" type="button">정산</button>
              <button id="tab-price" class="btn" type="button">단가 관리</button>
            </div>
          </div>

          <!-- 1) 중앙 히어로: 탭 불러오기/기간/가져오기만 표시 (정산 탭에서만 보임) -->
          <div id="hero" class="panel" style="margin-bottom:12px; display:block">
            <div class="stack" style="align-items:flex-end">
              <div>
                <label>구글 시트 하단 탭</label>
                <div class="stack">
                  <button id="load-tabs" class="btn">탭 불러오기</button>
                  <span id="tab-count" class="pill">0개</span>
                </div>
              </div>
              <div style="flex:1; min-width:260px">
                <label>탭(날짜) 선택</label>
                <div id="tab-chips" class="chips"></div>
              </div>
              <!-- 기간 선택 제거 -->
              <button id="fetch-data" class="btn btn-primary">데이터 가져오기</button>
            </div>
            <div class="muted" style="margin-top:8px; font-size:12px">탭명은 날짜(예: 2025-10-06) 형식을 권장합니다.</div>
          </div>

          <!-- 2) 단가 관리: 상단/좌측 탭에서 전환 시 표시 -->
          <div id="price-panel" class="panel" style="display:none; margin-bottom:12px">
            <div class="stack" style="justify-content:space-between">
              <div class="muted">거래처별 계좌 · 상품별 단가</div>
              <div class="stack">
                <button id="btn-add-price" class="btn btn-primary">상품 추가</button>
                <button id="btn-save-price" class="btn">저장</button>
                <button id="btn-bulk-toggle" class="btn">엑셀 대량등록</button>
                <a id="bulk-download" class="btn" href="/api/settlement/pricebook/template">대량등록 양식</a>
              </div>
            </div>
            <!-- 인라인 에디터 -->
            <div class="panel" style="margin-top:10px">
              <div class="stack" style="align-items:flex-end; gap:10px; flex-wrap:wrap">
                <div>
                  <label>거래처</label>
                  <input id="pb-client" type="text" placeholder="예: 레알마케팅" />
                </div>
                <div>
                  <label>상품명</label>
                  <input id="pb-product" type="text" placeholder="예: 일류1" />
                </div>
                <div>
                  <label>단가</label>
                  <input id="pb-price" type="text" placeholder="예: 1750" />
                </div>
                <div style="min-width:200px">
                  <label>계좌</label>
                  <input id="pb-account" type="text" placeholder="선택" />
                </div>
                <div style="min-width:200px">
                  <label>예금주</label>
                  <input id="pb-holder" type="text" placeholder="예: ㈜제이티더블유랩" />
                </div>
                <div class="stack" style="gap:8px">
                  <label style="margin:0; color:var(--muted); font-size:12px">유형</label>
                  <label class="muted" style="display:flex; align-items:center; gap:4px"><input type="radio" name="pb-type" value="공통" checked />공통</label>
                  <label class="muted" style="display:flex; align-items:center; gap:4px"><input type="radio" name="pb-type" value="저장" />저장</label>
                  <label class="muted" style="display:flex; align-items:center; gap:4px"><input type="radio" name="pb-type" value="트래픽" />트래픽</label>
                </div>
                <div class="stack">
                  <button id="pb-add-one" class="btn btn-primary" type="button">추가</button>
                  <button id="pb-add-both" class="btn" type="button">저장·트래픽 동시 추가</button>
                </div>
                <div class="panel" style="margin-top:6px; width:100%">
                  <label>검색</label>
                  <input id="pb-search" type="text" placeholder="거래처/상품 검색" style="width:100%" />
                </div>
              </div>
            </div>

            <!-- 대량 등록 패널 -->
            <div id="bulk-panel" class="panel" style="margin-top:10px; display:none">
              <div class="muted" style="margin-bottom:6px; font-size:12px">대량등록 엑셀을 업로드하세요. 헤더: 거래처, 상품명, 유형(공란/저장/트래픽), 단가, 계좌, 은행, 예금주</div>
              <div class="stack" style="gap:10px; align-items:center; flex-wrap:wrap">
                <input id="bulk-file" type="file" accept=".xlsx" />
                <button id="bulk-upload" class="btn btn-primary">업로드 미리보기</button>
                <button id="bulk-apply-xlsx" class="btn">일괄 추가/병합</button>
                <span id="bulk-status" class="muted" style="font-size:12px"></span>
              </div>
              <div style="overflow:auto; margin-top:8px">
                <table id="tbl-bulk" style="width:100%">
                  <thead>
                    <tr>
                      <th style="font-size:12px">#</th>
                      <th style="font-size:12px">거래처</th>
                      <th style="font-size:12px">상품명</th>
                      <th style="font-size:12px">유형</th>
                      <th style="font-size:12px">단가</th>
                      <th style="font-size:12px">계좌</th>
                      <th style="font-size:12px">은행</th>
                      <th style="font-size:12px">예금주</th>
                      <th style="font-size:12px">상태</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            <div style="overflow:auto; margin-top:8px">
              <table id="tbl-price">
                <thead>
                  <tr>
                    <th>거래처</th>
                    <th>상품명</th>
                    <th>유형</th>
                    <th>단가</th>
                    <th>계좌</th>
                    <th>은행</th>
                    <th>예금주</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        
          <!-- 3) 정산 미리보기(페이지 하단 표시) -->
          <div id="results-panel" class="panel" style="display:none; margin-bottom:12px">
            <div class="stack" style="justify-content:space-between; align-items:center; margin-bottom:8px">
              <div class="muted">상품별 요약</div>
              <div class="stack" style="gap:8px">
                <button id="btn-collapse-all" class="btn">전체 접기</button>
                <button id="btn-expand-all" class="btn">전체 펼치기</button>
              </div>
            </div>
            <!-- 상품별 카드 그리드 -->
            <div id="cards-container" class="cards"></div>
            <!-- 상품별 보기 -->
            <div style="overflow:auto">
              <table id="tbl-product" style="width:100%; display:none">
                <thead>
                  <tr>
                    <th>날짜</th>
                    <th>상품명</th>
                    <th>총 접수량</th>
                    <th>지출</th>
                    <th>매출</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <!-- 대행사별 보기 -->
            <div style="overflow:auto">
              <table id="tbl-agency" style="width:100%; display:none">
                <thead>
                  <tr>
                    <th>날짜</th>
                    <th>대행사</th>
                    <th>상품명</th>
                    <th>유형</th>
                    <th>수량</th>
                    <th>단가</th>
                    <th>지출</th>
                    <th>매출</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="overlay" id="overlay">
      <div class="center">
        <div class="spinner"></div>
        <div class="muted" id="progress-text">불러오는 중...</div>
        <div class="progress"><div class="progress-bar" id="progress-bar"></div></div>
      </div>
    </div>

    <script>
      // 상태 저장소 (임시: 클라이언트 메모리)
      const state = {
        tabs: [], // 시트 탭명
        selectedTabs: [], // 선택된 탭
        priceBook: [], // { client, product, price, account }
        previewRows: [] // { date, client, agency, product, qty, price, amount }
      };

      const $ = (s)=>document.querySelector(s);
      const overlay = document.getElementById('overlay');
      const pbar = document.getElementById('progress-bar');
      const ptxt = document.getElementById('progress-text');
      // 미리보기는 하단 패널 사용

      function showLoading(msg){ overlay.style.display='flex'; if(ptxt) ptxt.textContent = msg||'불러오는 중...'; if(pbar) pbar.style.width='15%'; }
      function setProgress(pct, msg){ if(pbar){ pbar.style.width = Math.max(0, Math.min(100, pct))+'%'; } if(msg && ptxt){ ptxt.textContent = msg; } }
      function hideLoading(){ overlay.style.display='none'; if(pbar) pbar.style.width='0%'; }

      // 간단 토스트
      function toast(msg){
        try{
          const d=document.createElement('div');
          d.textContent = msg||'저장됨';
          d.style.position='fixed'; d.style.right='16px'; d.style.bottom='16px';
          d.style.background='#111827'; d.style.color='#fff'; d.style.border='1px solid #111827';
          d.style.padding='10px 12px'; d.style.borderRadius='10px'; d.style.zIndex='60';
          document.body.appendChild(d);
          setTimeout(()=>{ try{ document.body.removeChild(d);}catch(e){} }, 1200);
        }catch(e){}
      }

      async function savePriceBook(){
        showLoading('단가표 저장 중...');
        try{
          const res = await fetch('/api/settlement/pricebook', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ items: state.priceBook }) });
          const data = await res.json().catch(()=>({}));
          if(!res.ok) throw new Error(data?.error||'저장 실패');
          toast('저장됨');
        }catch(e){ alert(e.message||'저장 실패'); }
        finally{ hideLoading(); }
      }

      // 1) 탭 불러오기 (API 연동 예정)
      const loadTabsBtn = document.getElementById('load-tabs'); if(loadTabsBtn) loadTabsBtn.addEventListener('click', async()=>{
        showLoading('탭 목록을 불러오는 중...');
        try{
          const res = await fetch('/api/settlement/tabs');
          const data = await res.json().catch(()=>({}));
          if(!res.ok) throw new Error(data?.error||'탭 조회 실패');
          state.tabs = Array.isArray(data.tabs) ? data.tabs : [];
          renderTabChips();
          $('#tab-count').textContent = `${state.tabs.length}개`;
          setProgress(100, '완료');
        }catch(e){ alert(e.message||'탭 불러오기 실패'); }
        finally{ hideLoading(); }
      });

      function renderTabChips(){
        const wrap = document.getElementById('tab-chips');
        if(!wrap) return;
        wrap.innerHTML = '';
        state.tabs.forEach(tab=>{
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'chip';
          btn.textContent = tab;
          const active = state.selectedTabs.includes(tab);
          if(active) btn.classList.add('active');
          btn.addEventListener('click', ()=>{
            const i = state.selectedTabs.indexOf(tab);
            if(i>=0) state.selectedTabs.splice(i,1); else state.selectedTabs.push(tab);
            renderTabChips();
          });
          wrap.appendChild(btn);
        });
      }

      // 기간 선택 제거됨

      // 2) 데이터 가져오기
      const fetchBtn = document.getElementById('fetch-data'); if(fetchBtn) fetchBtn.addEventListener('click', async()=>{
        showLoading('정산 데이터를 준비 중...'); setProgress(25);
        try{
          const res = await fetch('/api/settlement/compute', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tabs: state.selectedTabs }) });
          const data = await res.json().catch(()=>({}));
          if(!res.ok) throw new Error(data?.error||'집계 실패');
          // data.rows: {date, client, job, type, qty, unit_price, expense, income}
          const rows = Array.isArray(data.rows) ? data.rows : [];
          state.previewRows = rows.map(r=>({ date: r.date, client: r.client, product: (r.type?`${r.job} ${r.type}`:r.job), qty: r.qty, price: r.unit_price, expense: r.expense||0, income: r.income||0 }));
          renderPreview();
          renderAggregates(data?.aggregates||{});
          document.getElementById('results-panel').style.display = 'block';
          setPvTab();
        }catch(e){ alert(e.message||'집계 실패'); }
        finally{ setProgress(100, '완료'); hideLoading(); }
      });

      function renderAggregates(aggs){
        try{
          // 상품별 단일 뷰 카드 렌더링 (날짜 무시: 동일 상품은 합산)
          const cards = document.getElementById('cards-container');
          if(!cards) return;
          cards.innerHTML='';
          // 1) 상품별 총합 집계 (모든 날짜 합산)
          const totalByProduct = {};
          Object.entries(aggs?.by_product||{}).forEach(([date, prods])=>{
            Object.entries(prods||{}).forEach(([prod, v])=>{
              const acc = totalByProduct[prod]||{qty:0, expense:0, income:0};
              acc.qty += v.qty||0; acc.expense += v.expense||0; acc.income += v.income||0; totalByProduct[prod]=acc;
            });
          });

          // 2) 상품별 카드 생성 + 대행사별 상세(모든 날짜 포함)
          const byAgencyAllDates = aggs?.by_agency||{};
          Object.keys(totalByProduct).sort().forEach(prod=>{
            const s = totalByProduct[prod];
            const card=document.createElement('div'); card.className='card';
            card.innerHTML = `
              <div class="card-hd mini"><div><b>${prod}</b></div>
                <div class="muted">총 세팅 ${s.qty} · 지출 ${s.expense.toLocaleString()} · 매출 ${s.income.toLocaleString()}</div>
              </div>
              <div class="card-bd" style="overflow:auto">
                <table class="mini" style="width:100%">
                  <thead><tr><th>날짜</th><th>대행사</th><th>유형</th><th>수량</th><th>단가</th><th>지출</th><th>매출</th></tr></thead>
                  <tbody data-body></tbody>
                </table>
              </div>`;
            const tbody = card.querySelector('[data-body]');
            Object.keys(byAgencyAllDates).sort().forEach(date=>{
              const map = byAgencyAllDates[date]||{};
              Object.keys(map).sort().forEach(client=>{
                const arr = map[client]||[];
                arr.filter(it=> (it.product||'')===prod).forEach(it=>{
                  const tr=document.createElement('tr');
                  const incomeCell = it.income||0;
                  const rowStyle = (incomeCell===0? 'style="background:#fffbe6"' : ''); // 내부/관리형 강조
                  tr.innerHTML = `<td>${date}</td><td>${client}</td><td>${it.type||''}</td><td>${it.qty||0}</td><td>${it.unit_price||0}</td><td>${it.expense||0}</td><td ${rowStyle}>${incomeCell}</td>`;
                  tbody.appendChild(tr);
                });
              });
            });
            cards.appendChild(card);
          });
        }catch(e){}
      }

      // 모달 탭 전환
      // 단일 상품별 뷰
      function setPvTab(){ /* no-op: 단일 뷰 */ }

      // 단가부: 추가/삭제/입출력 (로컬 메모리)
      let clientDefaults = {};
      function rebuildClientDefaults(){
        const map = {};
        for(const it of state.priceBook){
          const c = (it.client||'').trim(); if(!c) continue;
          const key = c;
          const rec = map[key]||{accountCount:{}, bankCount:{}, holderCount:{}};
          if(it.account){ rec.accountCount[it.account] = 1 + (rec.accountCount[it.account]||0); }
          if(it.bank){ rec.bankCount[it.bank] = 1 + (rec.bankCount[it.bank]||0); }
          if(it.holder){ rec.holderCount[it.holder] = 1 + (rec.holderCount[it.holder]||0); }
          map[key] = rec;
        }
        const pickTop = (countObj)=>{
          let bestK='', bestV=0; for(const k in countObj){ if(countObj[k]>bestV){ bestV=countObj[k]; bestK=k; } }
          return bestK||'';
        };
        const out={};
        for(const k in map){ out[k] = { account: pickTop(map[k].accountCount), bank: pickTop(map[k].bankCount), holder: pickTop(map[k].holderCount) }; }
        clientDefaults = out;
      }
      function tryAutofillByClient(){
        const c = (document.getElementById('pb-client')?.value||'').trim(); if(!c) return;
        const def = clientDefaults[c]; if(!def) return;
        const accEl = document.getElementById('pb-account'); const bankEl = document.getElementById('pb-bank'); const holdEl = document.getElementById('pb-holder');
        if(accEl && !accEl.value) accEl.value = def.account||'';
        if(bankEl && !bankEl.value) bankEl.value = def.bank||'';
        if(holdEl && !holdEl.value) holdEl.value = def.holder||'';
      }
      const pbClientEl = document.getElementById('pb-client'); if(pbClientEl){ pbClientEl.addEventListener('change', tryAutofillByClient); }
      async function addOnePrice(){
        const client = (document.getElementById('pb-client')?.value||'').trim(); if(!client) return alert('거래처를 입력하세요');
        const product = (document.getElementById('pb-product')?.value||'').trim(); if(!product) return alert('상품명을 입력하세요');
        const price = Number((document.getElementById('pb-price')?.value||'0').replace(/,/g,''))||0;
        const account = (document.getElementById('pb-account')?.value||'').trim();
        const holder = (document.getElementById('pb-holder')?.value||'').trim();
        const bank = (document.getElementById('pb-bank')?.value||'').trim();
        const type = (document.querySelector('input[name="pb-type"]:checked')?.value)||'공통';
        upsertPrice({ client, product, price, account, bank, holder, type });
        renderPriceBook();
        await savePriceBook();
      }
      $('#btn-add-price').addEventListener('click', addOnePrice);
      document.getElementById('pb-add-one').addEventListener('click', addOnePrice);
      document.getElementById('pb-add-both').addEventListener('click', async()=>{
        const client = (document.getElementById('pb-client')?.value||'').trim(); if(!client) return alert('거래처를 입력하세요');
        const product = (document.getElementById('pb-product')?.value||'').trim(); if(!product) return alert('상품명을 입력하세요');
        const price = Number((document.getElementById('pb-price')?.value||'0').replace(/,/g,''))||0;
        const account = (document.getElementById('pb-account')?.value||'').trim();
        const holder = (document.getElementById('pb-holder')?.value||'').trim();
        const bank = (document.getElementById('pb-bank')?.value||'').trim();
        upsertPrice({ client, product, price, account, bank, holder, type:'저장' });
        upsertPrice({ client, product, price, account, bank, holder, type:'트래픽' });
        renderPriceBook();
        await savePriceBook();
      });
      { const el=document.getElementById('btn-export-price'); if(el){ el.addEventListener('click', ()=>{
        const json = JSON.stringify(state.priceBook, null, 2);
        navigator.clipboard?.writeText(json);
        alert('단가표 JSON을 클립보드로 복사했습니다.');
      }); } }
      { const el=document.getElementById('btn-import-price'); if(el){ el.addEventListener('click', async()=>{
        const json = prompt('단가표 JSON을 붙여넣으세요');
        if(!json) return;
        try{ const arr = JSON.parse(json); if(Array.isArray(arr)) state.priceBook = arr; }catch(e){ alert('JSON 파싱 실패'); }
        renderPriceBook();
        await savePriceBook();
      }); } }
      $('#btn-save-price').addEventListener('click', savePriceBook);

      let pbEditingIndex = -1;
      function upsertPrice(item){
        if(pbEditingIndex>=0){ state.priceBook[pbEditingIndex] = item; pbEditingIndex=-1; return; }
        const idx = state.priceBook.findIndex(x=>x.client===item.client && x.product===item.product && (String(x.type||'공통')===String(item.type||'공통')));
        if(idx>=0){ state.priceBook[idx] = item; } else { state.priceBook.push(item); }
      }
      function removePrice(client, product, type){
        state.priceBook = state.priceBook.filter(x=> !(x.client===client && x.product===product && String(x.type||'공통')===String(type||'공통')));
      }
      function lookupPrice(client, product){
        const it = state.priceBook.find(x=>x.client===client && x.product===product);
        return it ? it.price : null;
      }

      async function loadPriceBook(){
        try{
          const res = await fetch('/api/settlement/pricebook');
          const data = await res.json().catch(()=>({}));
          if(res.ok && Array.isArray(data.items)) state.priceBook = data.items; else state.priceBook = [];
        }catch(e){ state.priceBook = []; }
        rebuildClientDefaults();
      }

      function renderPriceBook(){
        const tb = document.querySelector('#tbl-price tbody');
        tb.innerHTML = '';
        const q = (document.getElementById('pb-search')?.value||'').trim().toLowerCase();
        const list = state.priceBook.filter(it=>{
          if(!q) return true; const t=(it.client+' '+it.product).toLowerCase(); return t.includes(q);
        });
        for(const it of list){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${it.client||''}</td>
            <td>${it.product||''}</td>
            <td>${it.type||'공통'}</td>
            <td>${it.price??''}</td>
            <td>${it.account||''}</td>
            <td>${it.bank||''}</td>
            <td>${it.holder||''}</td>
            <td>
              <button class="btn" data-edit="${it.client}|||${it.product}|||${it.type||'공통'}">수정</button>
              <button class="btn" data-del="${it.client}|||${it.product}|||${it.type||'공통'}">삭제</button>
            </td>
          `;
          tb.appendChild(tr);
        }
        tb.querySelectorAll('button[data-del]')?.forEach(btn=>{
          btn.addEventListener('click', async()=>{
            const [c,p,t] = btn.getAttribute('data-del').split('|||');
            removePrice(c, p, t); renderPriceBook();
            await savePriceBook();
          });
        });
        tb.querySelectorAll('button[data-edit]')?.forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const [c,p,t] = btn.getAttribute('data-edit').split('|||');
            const idx = state.priceBook.findIndex(x=>x.client===c && x.product===p && String(x.type||'공통')===String(t||'공통'));
            if(idx>=0){ pbEditingIndex=idx; const it=state.priceBook[idx];
              document.getElementById('pb-client').value = it.client||'';
              document.getElementById('pb-product').value = it.product||'';
              document.getElementById('pb-price').value = it.price||'';
              document.getElementById('pb-account').value = it.account||'';
              const bankEl = document.getElementById('pb-bank'); if(bankEl) bankEl.value = it.bank||'';
              document.getElementById('pb-holder').value = it.holder||'';
              const r = document.querySelector(`input[name="pb-type"][value="${it.type||'공통'}"]`); if(r) r.checked = true;
            }
          });
        });
        rebuildClientDefaults();
      }

      // 대량등록: XLSX 업로드 → 서버 파싱 결과를 미리보기/적용
      const bulkState = { items: [] };
      const bulkUploadBtn = document.getElementById('bulk-upload'); if(bulkUploadBtn){ bulkUploadBtn.addEventListener('click', async()=>{
        const inp = document.getElementById('bulk-file'); if(!inp.files || inp.files.length===0){ alert('엑셀 파일을 선택하세요'); return; }
        const file = inp.files[0]; const fd = new FormData(); fd.append('file', file);
        showLoading('엑셀 업로드 중...');
        try{
          const res = await fetch('/api/settlement/pricebook/upload', { method:'POST', body: fd });
          const data = await res.json().catch(()=>({}));
          if(!res.ok) throw new Error(data?.error||'업로드 실패');
          bulkState.items = Array.isArray(data.items)? data.items : [];
          renderBulkPreview(bulkState.items);
          document.getElementById('bulk-status').textContent = `${bulkState.items.length}건 준비됨`;
        }catch(e){ alert(e.message||'업로드 실패'); }
        finally{ hideLoading(); }
      }); }
      const bulkApplyBtn = document.getElementById('bulk-apply-xlsx'); if(bulkApplyBtn){ bulkApplyBtn.addEventListener('click', async()=>{
        if(!Array.isArray(bulkState.items) || bulkState.items.length===0){ alert('미리보기 후 적용하세요'); return; }
        for(const it of bulkState.items){ upsertPrice(it); }
        renderPriceBook(); await savePriceBook();
        document.getElementById('bulk-status').textContent = `${bulkState.items.length}건 반영됨`;
      }); }

      // (과거 TSV 붙여넣기 파서는 유지 가능하나 UI에서 감춤)
      function parseBulk(text){
        const lines = (text||'').replace(/\r/g,'').split('\n').filter(x=>x.trim().length>0);
        if(lines.length===0) return {items:[], error:null};
        const sep = (lines[0].includes('\t')? '\t' : ',');
        const cells0 = lines[0].split(sep).map(s=>s.trim().toLowerCase());
        const hasHeader = ['client','product','type','price','account','holder'].some(h=>cells0.includes(h));
        const startIdx = hasHeader?1:0;
        const idxOf = (name) => cells0.indexOf(name);
        const colMap = hasHeader? {
          client: idxOf('client'), product: idxOf('product'), type: idxOf('type'), price: idxOf('price'), account: idxOf('account'), holder: idxOf('holder')
        } : { client:0, product:1, type:2, price:3, account:4, holder:5 };
        const out=[]; let err=null;
        for(let i=startIdx;i<lines.length;i++){
          const parts = lines[i].split(sep);
          const get=(k)=>{ const idx=colMap[k]; return (idx>=0 && idx<parts.length)? parts[idx].trim():''; };
          const client=get('client'), product=get('product');
          let type=get('type')||'공통'; const priceRaw=get('price'); const account=get('account'); const holder=get('holder');
          if(!client || !product){ err = `필수값 누락 (행 ${i+1}): client/product`; break; }
          const price = Number((priceRaw||'').replace(/,/g,''))||0;
          if(type.toLowerCase()==='both'){ out.push({client,product,price,account,holder,type:'저장'}); out.push({client,product,price,account,holder,type:'트래픽'}); }
          else{ if(!['공통','저장','트래픽'].includes(type)) type='공통'; out.push({client,product,price,account,holder,type}); }
        }
        return {items: out, error: err};
      }
      function renderBulkPreview(list){
        const tb = document.querySelector('#tbl-bulk tbody'); tb.innerHTML='';
        list.forEach((it,idx)=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${idx+1}</td><td>${it.client}</td><td>${it.product}</td><td>${it.type}</td><td>${it.price}</td><td>${it.account||''}</td><td>${it.bank||''}</td><td>${it.holder||''}</td><td></td>`;
          tb.appendChild(tr);
        });
        document.getElementById('bulk-status').textContent = `${list.length}건 준비됨`;
      }
      document.getElementById('btn-bulk-toggle').addEventListener('click', ()=>{
        const el = document.getElementById('bulk-panel'); el.style.display = (el.style.display==='none'||!el.style.display)? 'block':'none';
      });
      { const el=document.getElementById('bulk-preview'); if(el){ el.addEventListener('click', ()=>{
        const {items,error} = parseBulk(document.getElementById('bulk-text').value);
        if(error) { alert(error); return; }
        renderBulkPreview(items);
      }); } }
      { const el=document.getElementById('bulk-apply'); if(el){ el.addEventListener('click', async()=>{
        const {items,error} = parseBulk(document.getElementById('bulk-text').value);
        if(error){ alert(error); return; }
        for(const it of items){ upsertPrice(it); }
        renderPriceBook();
        await savePriceBook();
        document.getElementById('bulk-status').textContent = `${items.length}건 반영됨`;
      }); } }

      // 템플릿 다운로드는 앵커 링크(#bulk-download)로 처리

      function renderPreview(){
        const cont = document.getElementById('cards-container');
        if(!cont) return; cont.innerHTML='';
        const group = {};
        for(const r of state.previewRows){
          const key = `${r.date}|||${r.client}`;
          (group[key] = group[key]||[]).push(r);
        }
        let grand = 0;
        Object.keys(group).sort().forEach(key=>{
          const [date, client] = key.split('|||');
          const rows = group[key];
          let subtotalE=0, subtotalI=0;
          const tblRows = rows.map(it=>{
            subtotalE += (it.expense||0); subtotalI += (it.income||0); grand += (it.expense||0);
            return `<tr><td>${it.product}</td><td>${it.qty}</td><td>${it.price}</td><td>${it.expense||0}</td><td>${it.income||0}</td></tr>`;
          }).join('');
          const card = document.createElement('div'); card.className='card collapsed';
          card.innerHTML = `
            <div class="card-hd"><div class="pill">${date}</div><div class="muted" style="font-weight:700">${client}</div></div>
            <div class="card-bd" style="overflow:auto">
              <table style="width:100%">
                <thead><tr><th>상품명</th><th>수량</th><th>단가</th><th>지출</th><th>매출</th></tr></thead>
                <tbody>${tblRows}</tbody>
                <tfoot><tr><th colspan="3" style="text-align:right">소계</th><th>${subtotalE}</th><th>${subtotalI}</th></tr></tfoot>
              </table>
            </div>
          `;
          card.querySelector('.card-hd').addEventListener('click', ()=>{ card.classList.toggle('collapsed'); });
          cont.appendChild(card);
        });
        // 총계 뱃지
        const headerArea = document.querySelector('#results-panel .stack');
        if(headerArea){
          let badge = document.getElementById('grand-badge');
          if(!badge){ badge = document.createElement('span'); badge.id='grand-badge'; badge.className='pill'; headerArea.appendChild(badge); }
          badge.textContent = `총 지출 ${grand.toLocaleString()}`;
        }
      }

      // 카드 전체 접기/펼치기
      document.getElementById('btn-collapse-all').addEventListener('click', ()=>{
        document.querySelectorAll('#cards-container .card').forEach(el=>el.classList.add('collapsed'));
      });
      document.getElementById('btn-expand-all').addEventListener('click', ()=>{
        document.querySelectorAll('#cards-container .card').forEach(el=>el.classList.remove('collapsed'));
      });

      // 4) 엑셀 양식 복붙용 생성 (간단 CSV 형태)
      document.getElementById('btn-export-excel').addEventListener('click', ()=>{
        const headers = ['날짜','대행사','상품명','수량','단가','지출','매출'];
        const lines = [headers.join('\t')];
        for(const r of state.previewRows){
          lines.push([r.date, r.client, r.product, r.qty, r.price, r.expense||0, r.income||0].join('\t'));
        }
        const text = lines.join('\n');
        navigator.clipboard?.writeText(text);
        alert('복사 완료! 엑셀에 붙여넣기 하세요.');
      });

      // 검색 렌더 업데이트
      document.getElementById('pb-search').addEventListener('input', renderPriceBook);

      // 초기화: 가격표 로드 및 렌더
      (async function init(){
        showLoading('초기화 중...');
        await loadPriceBook();
        renderPriceBook();
        hideLoading();
      })();

      // 상단 탭 전환: 정산 / 단가 관리
      function setTab(mode){
        const isSettle = mode==='settle';
        try{ document.getElementById('tab-settle')?.classList.toggle('btn-primary', isSettle); }catch(e){}
        try{ document.getElementById('tab-price')?.classList.toggle('btn-primary', !isSettle); }catch(e){}
        try{ document.getElementById('side-tab-settle')?.classList.toggle('active', isSettle); }catch(e){}
        try{ document.getElementById('side-tab-price')?.classList.toggle('active', !isSettle); }catch(e){}
        document.getElementById('price-panel').style.display = isSettle ? 'none' : 'block';
        document.getElementById('hero').style.display = isSettle ? 'block' : 'none';
        // 미리보기 패널은 정산 탭에서만 표시
        const rp = document.getElementById('results-panel');
        if(rp){ rp.style.display = isSettle ? (Array.isArray(state.previewRows) && state.previewRows.length? 'block':'none') : 'none'; }
      }
      const tSettle = document.getElementById('tab-settle'); if(tSettle){ tSettle.addEventListener('click', ()=> setTab('settle')); }
      const tPrice = document.getElementById('tab-price'); if(tPrice){ tPrice.addEventListener('click', ()=> setTab('price')); }
      const sSettle = document.getElementById('side-tab-settle'); if(sSettle){ sSettle.addEventListener('click', ()=> setTab('settle')); }
      const sPrice = document.getElementById('side-tab-price'); if(sPrice){ sPrice.addEventListener('click', ()=> setTab('price')); }
    </script>
  </body>
  </html>


