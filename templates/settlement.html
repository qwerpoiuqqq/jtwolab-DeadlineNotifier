<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>결재선 · 정산</title>
    <style>
      :root{ --bg:#ffffff; --text:#1f2328; --muted:#6b778c; --line:#e5e7eb; --panel:#ffffff; --pill:#f6f8fa; --btn:#111827; }
      html,body{ height:100% }
      body{ margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, "Noto Sans KR", Arial; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
      .layout{ display:flex; min-height:100vh; }
      .sidebar{ width:240px; border-right:1px solid var(--line); padding:16px; background:#fff; }
      .content{ flex:1; padding:24px; }
      .title{ font-weight:800; letter-spacing:.2px; font-size:18px; margin-bottom:16px; }
      .nav a{ display:block; padding:10px 12px; border-radius:10px; color:inherit; text-decoration:none; margin-bottom:6px; border:1px solid var(--line); background:var(--pill); }
      .nav a.active{ background:#111827; color:#fff; border-color:#111827; }
      .panel{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:16px; }
      .stack{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
      input[type="text"], input[type="date"], select{ background:#fff; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px; min-width:200px; outline:none; }
      .btn{ border:1px solid var(--line); background:#fff; color:#111827; padding:10px 14px; border-radius:10px; cursor:pointer; }
      .btn-primary{ background:#111827; color:#fff; border-color:#111827; }
      .muted{ color:var(--muted); }
      .pill{ border:1px solid var(--line); background:var(--pill); color:var(--text); padding:6px 10px; border-radius:999px; font-size:12px; }
      .grid{ display:grid; gap:12px; }
      @media(min-width:1100px){ .grid{ grid-template-columns: 1fr 1fr; } }
      table{ width:100%; border-collapse: collapse; }
      th, td{ border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; }
      th{ font-size:12px; color:var(--muted); font-weight:600; }
      .chips{ display:flex; gap:8px; flex-wrap:wrap; }
      .chip{ border:1px solid var(--line); background:var(--pill); color:var(--text); padding:8px 12px; border-radius:999px; cursor:pointer; font-size:12px; }
      .chip.active{ background:#111827; color:#fff; border-color:#111827; }
      .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.08); backdrop-filter: blur(2px); z-index:50; }
      .spinner{ width:34px; height:34px; border:3px solid rgba(17,24,39,.18); border-top-color:#111827; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 10px; }
      .progress{ width:260px; height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin:8px auto 0; }
      .progress-bar{ height:100%; width:0%; background:#111827; transition:width .2s ease; }
      @keyframes spin{ to{ transform:rotate(360deg); } }
    </style>
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <div class="title">Place Manager</div>
        <div class="nav">
          <a href="/" >마감 안내</a>
          <a href="/manage">보장 관리</a>
          <a href="/settlement" class="active">결재선 · 정산</a>
        </div>
        <div class="panel" style="margin-top:12px">
          <div class="muted" style="font-size:12px">워크플로우</div>
          <ol style="padding-left:18px; margin:8px 0 0 0; color:#4b5563; font-size:13px">
            <li>하단 탭 목록 불러오기</li>
            <li>날짜(탭명) 선택</li>
            <li>상품별 수량×단가 산출</li>
            <li>거래처별 합계 확인</li>
            <li>엑셀 양식으로 복붙</li>
          </ol>
        </div>
      </aside>
      <main class="content">
        <div class="title">결재선 · 정산</div>

        <div class="grid">
          <!-- 1) 탭 불러오기 & 날짜 선택 -->
          <div class="panel">
            <div class="stack" style="align-items:flex-end">
              <div>
                <label>구글 시트 하단 탭</label>
                <div class="stack">
                  <button id="load-tabs" class="btn">탭 불러오기</button>
                  <span id="tab-count" class="pill">0개</span>
                </div>
              </div>
              <div style="flex:1; min-width:260px">
                <label>탭(날짜) 선택</label>
                <div id="tab-chips" class="chips"></div>
              </div>
              <div class="stack">
                <button id="select-range" class="btn">기간 선택</button>
                <span id="selected-range" class="muted" style="font-size:12px"></span>
              </div>
              <button id="fetch-data" class="btn btn-primary">데이터 가져오기</button>
            </div>
            <div class="muted" style="margin-top:8px; font-size:12px">탭명은 날짜(예: 2025-10-06) 형식을 권장합니다.</div>
          </div>

          <!-- 2) 단가 관리 -->
          <div class="panel">
            <div class="stack" style="justify-content:space-between">
              <div class="muted">거래처별 계좌 · 상품별 단가</div>
              <div class="stack">
                <button id="btn-add-price" class="btn">상품 추가</button>
                <button id="btn-save-price" class="btn btn-primary">저장</button>
                <button id="btn-import-price" class="btn">가져오기</button>
                <button id="btn-export-price" class="btn">내보내기</button>
              </div>
            </div>
            <div style="overflow:auto; margin-top:8px">
              <table id="tbl-price">
                <thead>
                  <tr>
                    <th>거래처</th>
                    <th>상품명</th>
                    <th>단가</th>
                    <th>계좌</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- 3) 정산 미리보기 -->
          <div class="panel" style="grid-column:1/-1">
            <div class="stack" style="justify-content:space-between">
              <div class="muted">정산 미리보기 (날짜 ▶ 거래처 ▶ 대행사)</div>
              <div class="stack">
                <button id="btn-export-excel" class="btn btn-primary">엑셀 양식 복붙</button>
              </div>
            </div>
            <div style="overflow:auto; margin-top:8px">
              <table id="tbl-preview">
                <thead>
                  <tr>
                    <th>날짜</th>
                    <th>거래처</th>
                    <th>대행사</th>
                    <th>상품명</th>
                    <th>수량</th>
                    <th>단가</th>
                    <th>금액</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <th colspan="6" style="text-align:right">총액</th>
                    <th id="grand-total">0</th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

      </main>
    </div>

    <div class="overlay" id="overlay">
      <div class="center">
        <div class="spinner"></div>
        <div class="muted" id="progress-text">불러오는 중...</div>
        <div class="progress"><div class="progress-bar" id="progress-bar"></div></div>
      </div>
    </div>

    <script>
      // 상태 저장소 (임시: 클라이언트 메모리)
      const state = {
        tabs: [], // 시트 탭명
        selectedTabs: [], // 선택된 탭
        priceBook: [], // { client, product, price, account }
        previewRows: [] // { date, client, agency, product, qty, price, amount }
      };

      const $ = (s)=>document.querySelector(s);
      const overlay = document.getElementById('overlay');
      const pbar = document.getElementById('progress-bar');
      const ptxt = document.getElementById('progress-text');

      function showLoading(msg){ overlay.style.display='flex'; if(ptxt) ptxt.textContent = msg||'불러오는 중...'; if(pbar) pbar.style.width='15%'; }
      function setProgress(pct, msg){ if(pbar){ pbar.style.width = Math.max(0, Math.min(100, pct))+'%'; } if(msg && ptxt){ ptxt.textContent = msg; } }
      function hideLoading(){ overlay.style.display='none'; if(pbar) pbar.style.width='0%'; }

      // 1) 탭 불러오기 (API 연동 예정)
      $('#load-tabs').addEventListener('click', async()=>{
        showLoading('탭 목록을 불러오는 중...');
        try{
          const res = await fetch('/api/settlement/tabs');
          const data = await res.json().catch(()=>({}));
          if(!res.ok) throw new Error(data?.error||'탭 조회 실패');
          state.tabs = Array.isArray(data.tabs) ? data.tabs : [];
          renderTabChips();
          $('#tab-count').textContent = `${state.tabs.length}개`;
          setProgress(100, '완료');
        }catch(e){ alert(e.message||'탭 불러오기 실패'); }
        finally{ hideLoading(); }
      });

      function renderTabChips(){
        const wrap = document.getElementById('tab-chips');
        if(!wrap) return;
        wrap.innerHTML = '';
        state.tabs.forEach(tab=>{
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'chip';
          btn.textContent = tab;
          const active = state.selectedTabs.includes(tab);
          if(active) btn.classList.add('active');
          btn.addEventListener('click', ()=>{
            const i = state.selectedTabs.indexOf(tab);
            if(i>=0) state.selectedTabs.splice(i,1); else state.selectedTabs.push(tab);
            renderTabChips();
          });
          wrap.appendChild(btn);
        });
      }

      // 기간 선택 (간단 데모)
      $('#select-range').addEventListener('click', ()=>{
        const opts = [...state.tabs].sort();
        if(opts.length===0){ $('#selected-range').textContent=''; return; }
        const first = opts[0], last = opts[opts.length-1];
        $('#selected-range').textContent = `${first} ~ ${last}`;
        state.selectedTabs = opts;
        renderTabChips();
      });

      // 2) 데이터 가져오기 (임시 계산 로직: 상품별 수량 합계 × 단가)
      $('#fetch-data').addEventListener('click', ()=>{
        showLoading('정산 데이터를 준비 중...'); setProgress(25);
        // 임시: 랜덤 더미 데이터 생성
        const products = ['트래픽', '저장'];
        const agencies = ['A대행', 'B대행'];
        const clients = ['거래처1', '거래처2'];
        const rows = [];
        for(const date of state.selectedTabs){
          for(const client of clients){
            for(const agency of agencies){
              for(const product of products){
                const qty = Math.floor(Math.random()*5)+1;
                const price = lookupPrice(client, product) ?? (product==='트래픽' ? 1000 : 2000);
                rows.push({ date, client, agency, product, qty, price, amount: qty*price });
              }
            }
          }
        }
        state.previewRows = rows;
        renderPreview();
        setProgress(100, '완료'); hideLoading();
      });

      // 단가부: 추가/삭제/입출력 (로컬 메모리)
      $('#btn-add-price').addEventListener('click', ()=>{
        const client = prompt('거래처명?'); if(!client) return;
        const product = prompt('상품명?'); if(!product) return;
        const price = Number(prompt('단가? (숫자)')||'0')||0;
        const account = prompt('계좌? (예: 국민 000-00-000000, 홍길동)')||'';
        upsertPrice({ client, product, price, account });
        renderPriceBook();
      });
      $('#btn-export-price').addEventListener('click', ()=>{
        const json = JSON.stringify(state.priceBook, null, 2);
        navigator.clipboard?.writeText(json);
        alert('단가표 JSON을 클립보드로 복사했습니다.');
      });
      $('#btn-import-price').addEventListener('click', async()=>{
        const json = prompt('단가표 JSON을 붙여넣으세요');
        if(!json) return;
        try{ const arr = JSON.parse(json); if(Array.isArray(arr)) state.priceBook = arr; }catch(e){ alert('JSON 파싱 실패'); }
        renderPriceBook();
      });
      $('#btn-save-price').addEventListener('click', async()=>{
        showLoading('단가표 저장 중...');
        try{
          const res = await fetch('/api/settlement/pricebook', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ items: state.priceBook }) });
          const data = await res.json().catch(()=>({}));
          if(!res.ok) throw new Error(data?.error||'저장 실패');
          alert('저장 완료');
        }catch(e){ alert(e.message||'저장 실패'); }
        finally{ hideLoading(); }
      });

      function upsertPrice(item){
        const idx = state.priceBook.findIndex(x=>x.client===item.client && x.product===item.product);
        if(idx>=0){ state.priceBook[idx] = item; } else { state.priceBook.push(item); }
      }
      function removePrice(client, product){
        state.priceBook = state.priceBook.filter(x=> !(x.client===client && x.product===product));
      }
      function lookupPrice(client, product){
        const it = state.priceBook.find(x=>x.client===client && x.product===product);
        return it ? it.price : null;
      }

      async function loadPriceBook(){
        try{
          const res = await fetch('/api/settlement/pricebook');
          const data = await res.json().catch(()=>({}));
          if(res.ok && Array.isArray(data.items)) state.priceBook = data.items; else state.priceBook = [];
        }catch(e){ state.priceBook = []; }
      }

      function renderPriceBook(){
        const tb = document.querySelector('#tbl-price tbody');
        tb.innerHTML = '';
        for(const it of state.priceBook){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${it.client||''}</td>
            <td>${it.product||''}</td>
            <td>${it.price??''}</td>
            <td>${it.account||''}</td>
            <td><button class="btn" data-del="${it.client}|||${it.product}">삭제</button></td>
          `;
          tb.appendChild(tr);
        }
        tb.querySelectorAll('button[data-del]')?.forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const [c,p] = btn.getAttribute('data-del').split('|||');
            removePrice(c, p); renderPriceBook();
          });
        });
      }

      function renderPreview(){
        const tb = document.querySelector('#tbl-preview tbody');
        tb.innerHTML = '';
        let total = 0;
        for(const r of state.previewRows){
          total += (r.amount||0);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.date}</td>
            <td>${r.client}</td>
            <td>${r.agency}</td>
            <td>${r.product}</td>
            <td>${r.qty}</td>
            <td>${r.price}</td>
            <td>${r.amount}</td>
          `;
          tb.appendChild(tr);
        }
        document.getElementById('grand-total').textContent = String(total);
      }

      // 4) 엑셀 양식 복붙용 생성 (간단 CSV 형태)
      document.getElementById('btn-export-excel').addEventListener('click', ()=>{
        const headers = ['날짜','거래처','대행사','상품명','수량','단가','금액'];
        const lines = [headers.join('\t')];
        for(const r of state.previewRows){
          lines.push([r.date, r.client, r.agency, r.product, r.qty, r.price, r.amount].join('\t'));
        }
        const text = lines.join('\n');
        navigator.clipboard?.writeText(text);
        alert('복사 완료! 엑셀에 붙여넣기 하세요.');
      });

      // 초기화: 가격표 로드 및 렌더
      (async function init(){
        showLoading('초기화 중...');
        await loadPriceBook();
        renderPriceBook();
        hideLoading();
      })();
    </script>
  </body>
  </html>


