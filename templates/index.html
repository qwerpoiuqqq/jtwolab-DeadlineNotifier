<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>마감 안내 생성기</title>
    <style>
      :root{
        --bg:#ffffff;
        --text:#1f2328;          /* neutral-900 */
        --muted:#6b778c;         /* neutral-500 */
        --line:#e5e7eb;          /* neutral-200 */
        --panel:#ffffff;         /* card bg */
        --pill:#f6f8fa;          /* subtle chip */
        --btn:#111827;           /* dark text for primary */
      }
      html,body{height:100%}
      body{
        margin:0; background:var(--bg); color:var(--text);
        font-family: ui-sans-serif, system-ui, "Noto Sans KR", Arial;
        -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      }
      .container{ max-width:980px; margin:0 auto; padding:24px; }
      .title{ font-weight:800; letter-spacing:.2px; font-size:18px; margin-bottom:16px; }
      .home-link{ color:inherit; text-decoration:none; }
      .home-link:hover{ text-decoration:underline; }

      /* Panel (Notion-like card) */
      .panel{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:16px; }
      .stack{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      .stack-right{ margin-left:auto; display:flex; gap:8px; }

      label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
      input[type="text"],input[type="date"],select{
        background:#fff; color:var(--text); border:1px solid var(--line); border-radius:10px;
        padding:10px 12px; min-width:220px; outline:none;
      }
      input::placeholder{ color:#9da7b1; }

      .btn{ border:1px solid var(--line); background:#fff; color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer; }
      .btn-primary{ background:#111827; color:#fff; border-color:#111827; }

      .chips{ display:flex; gap:8px; flex-wrap:wrap; }
      .chip{ border:1px solid var(--line); background:var(--pill); color:var(--text); padding:6px 10px; border-radius:999px; cursor:pointer; font-size:12px; }

      .muted{ color:var(--muted); }
      .pill{ border:1px solid var(--line); background:var(--pill); color:var(--text); padding:6px 10px; border-radius:999px; font-size:12px; }

      /* Results */
      .grid{ display:grid; gap:12px; }
      @media(min-width:900px){ .grid{ grid-template-columns:1fr 1fr; } }
      .card{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; }
      .card-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
      .name{ font-weight:700; }
      .copy{ white-space:pre-wrap; background:#fff; border:1px dashed var(--line); border-radius:10px; padding:10px; font-family: ui-monospace, Menlo, Consolas, "Courier New"; color:#0b0f14; }

      /* Overlay spinner (neutral) */
      .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.08); backdrop-filter: blur(2px); z-index:50; }
      .spinner{ width:34px; height:34px; border:3px solid rgba(17,24,39,.18); border-top-color:#111827; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 10px; }
      @keyframes spin{ to{ transform:rotate(360deg); } }
      .center{ text-align:center; }
      .progress{ width:240px; height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin:10px auto 0; }
      .progress-bar{ height:100%; width:0%; background:#111827; transition:width .3s ease; }

      /* Toast */
      .toast{ position:fixed; right:16px; bottom:16px; background:#111827; color:#fff; border:1px solid #111827; padding:10px 12px; border-radius:10px; display:none; z-index:60; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="title"><a class="home-link" href="/">마감 안내 생성기</a></div>

      <!-- Controls -->
      <div class="panel" style="margin-bottom:12px">
        <form id="q" method="get" action="/">
          <input type="hidden" name="submit" value="1" />
          <div class="stack">
            <div>
              <label>기준일</label>
              <input type="date" name="base_date" value="{{ base_date_str }}" />
            </div>
            <div>
              <label>만료일(쉼표)</label>
              <input type="text" name="days" value="{{ days_param }}" placeholder="예: 0,1,2" />
            </div>
            <div>
              <label>보기</label>
              <select name="filter_mode">
                <option value="agency" {% if filter_mode!='internal' %}selected{% endif %}>대행사 발주건</option>
                <option value="internal" {% if filter_mode=='internal' %}selected{% endif %}>내부 진행건</option>
              </select>
            </div>
            <div class="stack-right">
              <button class="btn btn-primary" type="submit">조회</button>
              <button class="btn" type="button" id="expand">전체 펼치기</button>
              <button class="btn" type="button" id="collapse">전체 접기</button>
            </div>
          </div>
          <div class="chips" style="margin-top:8px">
            <span class="chip" data-days="0">오늘</span>
            <span class="chip" data-days="1">1일뒤</span>
            <span class="chip" data-days="2">2일뒤</span>
            <span class="chip" data-days="0,1,2">0~2일</span>
          </div>
        </form>
      </div>

      <!-- Summary -->
      {% if did_fetch and ordered_days %}
      <div class="panel" style="margin-bottom:12px">
        <div class="stack" style="flex-wrap:wrap">
          <span class="muted">기준일</span><span class="pill">{{ base_date_str }}</span>
          <span class="muted" style="margin-left:10px">날짜 매핑</span>
          {% for d in ordered_days %}
            <span class="pill">{{ d }}일 → {{ day_to_date_label[d] }}</span>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Results -->
      {% if did_fetch %}
        {% if grouped %}
          <div class="grid" id="results">
            {% for agency, tasks in grouped.items() %}
              <div class="card" data-card>
                <div class="card-head">
                  <div class="name">[{{ agency }}]</div>
                  <div class="stack">
                    <button class="btn" type="button" data-toggle>접기</button>
                    <button class="btn btn-primary" type="button" onclick="copyText('c{{ loop.index }}')">복사</button>
                  </div>
                </div>
                <div class="copy" id="c{{ loop.index }}" data-body>{{ agency_to_message[agency] }}</div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="panel muted">조건에 해당하는 항목이 없습니다.</div>
        {% endif %}
      {% endif %}
    </div>

    <!-- Overlay spinner -->
    <div class="overlay" id="overlay">
      <div class="center">
        <div class="spinner"></div>
        <div class="muted"><span id="pct">0</span>% 진행 중...</div>
        <div class="progress"><div class="progress-bar" id="bar"></div></div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">복사되었습니다.</div>

    <script>
      // 빠른 선택 칩
      document.querySelectorAll('.chip').forEach(ch=>ch.addEventListener('click',()=>{
        const v = ch.getAttribute('data-days');
        document.querySelector('input[name="days"]').value = v;
      }));

      // 오버레이 표시
      const form = document.getElementById('q'); const overlay = document.getElementById('overlay');
      let _progressTimer = null; let _progressValue = 0;
      function startProgress(){
        const pctEl = document.getElementById('pct'); const barEl = document.getElementById('bar');
        _progressValue = 0; if(pctEl) pctEl.textContent = '0'; if(barEl) barEl.style.width = '0%';
        overlay.style.display='flex';
        const step = ()=>{
          // 0→90%까지 천천히 가속/감속하며 증가 (심리적 진행 표시)
          const next = _progressValue + Math.max(1, Math.round((90 - _progressValue) * 0.08));
          _progressValue = Math.min(next, 90);
          if(pctEl) pctEl.textContent = String(_progressValue);
          if(barEl) barEl.style.width = _progressValue + '%';
          if(_progressValue >= 90){ clearInterval(_progressTimer); _progressTimer = null; }
        };
        _progressTimer = setInterval(step, 250);
      }
      function stopProgress(){ if(_progressTimer){ clearInterval(_progressTimer); _progressTimer = null; } overlay.style.display='none'; }
      form?.addEventListener('submit', startProgress);
      window.addEventListener('pageshow', stopProgress);

      // (신규) URL에 base_date가 없을 때 오늘 날짜 자동 설정
      (function setTodayIfEmpty(){
        try{
          const url = new URL(window.location.href);
          if(!url.searchParams.get('base_date')){
            const input = document.querySelector('input[name="base_date"]');
            if(input){
              const t = new Date();
              const yyyy = t.getFullYear();
              const mm = String(t.getMonth()+1).padStart(2,'0');
              const dd = String(t.getDate()).padStart(2,'0');
              input.value = `${yyyy}-${mm}-${dd}`;
            }
          }
        }catch(e){}
      })();

      // 카드 접기/펼치기
      function setCard(card, open){
        const body = card.querySelector('[data-body]');
        const btn = card.querySelector('[data-toggle]');
        body.style.display = open ? 'block' : 'none';
        btn.textContent = open ? '접기' : '펼치기';
      }
      document.querySelectorAll('[data-card]').forEach(card=>{
        const btn = card.querySelector('[data-toggle]');
        btn.addEventListener('click', ()=>{
          const isOpen = card.querySelector('[data-body]').style.display !== 'none';
          setCard(card, !isOpen);
        });
      });
      document.getElementById('expand')?.addEventListener('click', ()=>{
        document.querySelectorAll('[data-card]').forEach(c=>setCard(c,true));
      });
      document.getElementById('collapse')?.addEventListener('click', ()=>{
        document.querySelectorAll('[data-card]').forEach(c=>setCard(c,false));
      });

      // 복사 & 토스트
      function toast(){ const t=document.getElementById('toast'); t.style.display='block'; setTimeout(()=>t.style.display='none',1200); }
      window.copyText = function(id){
        const el = document.getElementById(id); if(!el) return; const tx = el.innerText;
        (navigator.clipboard?.writeText ? navigator.clipboard.writeText(tx) : new Promise((res,rej)=>{
          const ta=document.createElement('textarea'); ta.value=tx; document.body.appendChild(ta); ta.select();
          document.execCommand('copy') ? res() : rej(); document.body.removeChild(ta);
        })).then(toast).catch(toast);
      }
    </script>
  </body>
</html>
