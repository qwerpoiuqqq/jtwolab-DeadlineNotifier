<!-- templates/index.html -->
<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>마감 안내 생성기</title>
    <style>
      :root{
        --bg:#ffffff;
        --text:#1f2328;
        --muted:#6b778c;
        --line:#e5e7eb;
        --panel:#ffffff;
        --pill:#f6f8fa;
        --btn:#111827;
      }
      html,body{height:100%}
      body{
        margin:0; background:var(--bg); color:var(--text);
        font-family: ui-sans-serif, system-ui, "Noto Sans KR", Arial;
        -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      }
      .container{ max-width:980px; margin:0 auto; padding:24px; }
      .title{ font-weight:800; letter-spacing:.2px; font-size:18px; margin-bottom:16px; }
      .home-link{ color:inherit; text-decoration:none; }
      .home-link:hover{ text-decoration:underline; }

      .panel{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:16px; }
      .stack{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      .stack-right{ margin-left:auto; display:flex; gap:8px; }

      label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
      input[type="text"],input[type="date"],select{
        background:#fff; color:var(--text); border:1px solid var(--line); border-radius:10px;
        padding:10px 12px; min-width:220px; outline:none;
      }
      input::placeholder{ color:#9da7b1; }

      .btn{ border:1px solid var(--line); background:#fff; color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer; }
      .btn-primary{ background:#111827; color:#fff; border-color:#111827; }

      .chips{ display:flex; gap:8px; flex-wrap:wrap; }
      .chip{ border:1px solid var(--line); background:var(--pill); color:var(--text); padding:6px 10px; border-radius:999px; cursor:pointer; font-size:12px; }

      .muted{ color:var(--muted); }
      .pill{ border:1px solid var(--line); background:var(--pill); color:var(--text); padding:6px 10px; border-radius:999px; font-size:12px; }

      .grid{ display:grid; gap:12px; }
      textarea{ background:#fff; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:12px 14px; outline:none; width:100%; min-height:110px; resize:vertical; }
      .controls{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      .switch{ display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line); background:var(--pill); border-radius:999px; font-size:12px; }
      @media(min-width:900px){ .grid{ grid-template-columns:1fr 1fr; } }
      .card{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; }
      .card-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
      .name{ font-weight:700; }
      .copy{ white-space:pre-wrap; background:#fff; border:1px dashed var(--line); border-radius:10px; padding:10px; font-family: ui-monospace, Menlo, Consolas, "Courier New"; color:#0b0f14; text-align:left; }

      .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.08); backdrop-filter: blur(2px); z-index:50; }
      .spinner{ width:34px; height:34px; border:3px solid rgba(17,24,39,.18); border-top-color:#111827; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 10px; }
      .progress{ width:260px; height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin:8px auto 0; }
      .progress-bar{ height:100%; width:0%; background:#111827; transition:width .2s ease; }
      @keyframes spin{ to{ transform:rotate(360deg); } }
      .center{ text-align:center; }

      .toast{ position:fixed; right:16px; bottom:16px; background:#111827; color:#fff; border:1px solid #111827; padding:10px 12px; border-radius:10px; display:none; z-index:60; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="title"><a class="home-link" href="/">마감 안내 생성기</a></div>

      <div class="panel" style="margin-bottom:12px">
        <form id="q" method="get" action="/">
          <input type="hidden" name="submit" value="1" />
          <div class="stack">
            <div>
              <label>기준일</label>
              <input type="date" name="base_date" value="{{ base_date_str }}" />
            </div>
            <div>
              <label>만료일(쉼표)</label>
              <input type="text" name="days" value="{{ days_param }}" placeholder="예: 0,1,2" />
            </div>
            <div>
              <label>보기</label>
              <select name="filter_mode">
                <option value="agency" {% if filter_mode!='internal' %}selected{% endif %}>대행사 발주건</option>
                <option value="internal" {% if filter_mode=='internal' %}selected{% endif %}>내부 진행건</option>
              </select>
            </div>
            <div class="stack-right">
              <button class="btn btn-primary" type="submit">조회</button>
              <button class="btn" type="button" id="expand">전체 펼치기</button>
              <button class="btn" type="button" id="collapse">전체 접기</button>
            </div>
          </div>
          <div class="chips" style="margin-top:8px">
            <span class="chip" data-days="0">오늘</span>
            <span class="chip" data-days="1">1일뒤</span>
            <span class="chip" data-days="2">2일뒤</span>
            <span class="chip" data-days="0,1,2">0~2일</span>
          </div>
        </form>
      </div>

      {% if did_fetch and ordered_days %}
      <div class="panel" style="margin-bottom:12px">
        <div class="stack" style="flex-wrap:wrap; justify-content:flex-start">
          <span class="muted">기준일</span><span class="pill">{{ base_date_str }}</span>
          <span class="muted" style="margin-left:10px">날짜 매핑</span>
          {% for d in ordered_days %}
            <span class="pill">{{ d }}일 → {{ day_to_date_label[d] }}</span>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- 자동 멘트 설정 -->
      <div class="panel" style="margin-bottom:12px">
        <div class="stack" style="align-items:flex-start; gap:16px">
          <div style="display:flex; align-items:center; gap:8px; min-width:160px">
            <input id="autoMsgEnabled" type="checkbox" style="width:18px; height:18px" />
            <label for="autoMsgEnabled" style="margin:0">자동 멘트 사용</label>
          </div>
          <div style="flex:1; min-width:240px">
            <label>첫 멘트</label>
            <textarea id="autoMsgPrefix" placeholder="대표님 안녕하세요~"></textarea>
          </div>
          <div style="flex:1; min-width:240px">
            <label>끝 멘트</label>
            <textarea id="autoMsgSuffix" placeholder="예: 연장 여부 확인 후 금일 마감시간전까지 접수 요청 부탁드립니다! 감사합니다~"></textarea>
          </div>
        </div>
        <div class="muted" style="margin-top:8px; font-size:12px">'대행사 발주건' 보기에서만 자동 멘트가 포함됩니다.</div>
      </div>

      {% if did_fetch %}
        {% if grouped %}
          <div class="panel" style="margin-bottom:12px">
            <div class="controls">
              <div class="switch"><input id="toggleDateLine" type="checkbox" style="width:18px; height:18px" /><span>날짜 문구 포함</span></div>
              <div class="switch"><input id="togglePrefix" type="checkbox" style="width:18px; height:18px" checked /><span>첫 멘트 포함</span></div>
              <div class="switch"><input id="toggleSuffix" type="checkbox" style="width:18px; height:18px" checked /><span>끝 멘트 포함</span></div>
              <span class="muted">체크 상태가 본문에 즉시 반영됩니다.</span>
            </div>
          </div>
          <div class="grid" id="results">
            {% for agency, tasks in grouped.items() %}
              <div class="card" data-card data-agency="{{ agency }}">
                <div class="card-head">
                  <div class="name">[{{ agency }}]</div>
                  <div class="stack">
                    <button class="btn" type="button" data-toggle>접기</button>
                    <button class="btn btn-primary" type="button" onclick="copyText('c{{ loop.index }}')">복사</button>
                  </div>
                </div>
                <div class="copy" id="c{{ loop.index }}" data-body>
                  {{ agency_to_message[agency] }}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="panel muted">조건에 해당하는 항목이 없습니다.</div>
        {% endif %}
      {% endif %}
    </div>

    <div class="overlay" id="overlay">
      <div class="center">
        <div class="spinner"></div>
        <div class="muted" id="progress-text">정보를 찾는 중입니다...</div>
        <div class="progress"><div class="progress-bar" id="progress-bar"></div></div>
      </div>
    </div>

    <div class="toast" id="toast">복사되었습니다.</div>

    <script>
      // 자동 멘트 로컬설정 키
      const LS_KEYS = { enabled: 'pm_auto_msg_enabled', prefix: 'pm_auto_msg_prefix', suffix: 'pm_auto_msg_suffix' };

      // 빠른 선택 칩
      document.querySelectorAll('.chip').forEach(ch=>ch.addEventListener('click',()=>{
        const v = ch.getAttribute('data-days');
        document.querySelector('input[name="days"]').value = v;
      }));

      // 오버레이 표시 + SSE 진행률 연동
      const form = document.getElementById('q'); const overlay = document.getElementById('overlay');
      const pbar = document.getElementById('progress-bar');
      const ptxt = document.getElementById('progress-text');
      form?.addEventListener('submit', (e)=>{
        // 기본 submit으로 페이지를 이동하지 않고, SSE로 로딩 후 결과 페이지로 이동
        e.preventDefault();
        overlay.style.display='flex';
        pbar.style.width='0%';
        ptxt.textContent='정보를 찾는 중입니다...';

        const fd = new FormData(form);
        const params = new URLSearchParams();
        params.set('days', fd.get('days')||'');
        params.set('filter_mode', fd.get('filter_mode')||'agency');
        params.set('base_date', fd.get('base_date')||'');

        const es = new EventSource(`/api/fetch-stream?${params.toString()}`);
        let total = 0, processed = 0;
        let finalGrouped = null;
        es.onmessage = (ev)=>{
          try{
            const data = JSON.parse(ev.data);
            if(data.type==='start'){
              total = data.total||0; processed=0;
              ptxt.textContent = total>0 ? `시트 ${total}개 처리 준비` : '처리 준비';
              pbar.style.width = total>0 ? '1%' : '5%';
            }else if(data.type==='progress'){
              processed = data.processed||processed;
              const pct = total>0 ? Math.max(1, Math.min(99, Math.floor(processed/total*99))) : 50;
              pbar.style.width = `${pct}%`;
              ptxt.textContent = `처리 중: ${processed}/${total} ( ${pct}% ) - ${data.tab||''}`;
            }else if(data.type==='result'){
              finalGrouped = data.grouped||{};
              pbar.style.width='100%';
              ptxt.textContent='완료되었습니다. 결과를 그리는 중...';
              es.close();
              // 완료 후 실제 페이지로 이동하여 기존 렌더링 로직 사용
              const url = new URL(window.location.origin+'/');
              url.searchParams.set('submit','1');
              url.searchParams.set('days', fd.get('days')||'');
              url.searchParams.set('filter_mode', fd.get('filter_mode')||'agency');
              url.searchParams.set('base_date', fd.get('base_date')||'');
              window.location.href = url.toString();
            }else if(data.type==='error'){
              ptxt.textContent = `오류: ${data.message}`;
            }
          }catch(err){ /* ignore JSON parse errors */ }
        };
        es.onerror = ()=>{
          // SSE 실패시 기존 submit로 폴백
          es.close();
          form.submit();
        };
      });
      window.addEventListener('pageshow', ()=>{ overlay.style.display='none'; });

      // URL에 base_date 없으면 오늘 자동 설정
      (function setTodayIfEmpty(){
        try{
          const url = new URL(window.location.href);
          if(!url.searchParams.get('base_date')){
            const input = document.querySelector('input[name="base_date"]');
            if(input){
              const t = new Date();
              const yyyy = t.getFullYear();
              const mm = String(t.getMonth()+1).padStart(2,'0');
              const dd = String(t.getDate()).padStart(2,'0');
              input.value = `${yyyy}-${mm}-${dd}`;
            }
          }
        }catch(e){}
      })();

      // 카드 접기/펼치기
      function setCard(card, open){
        const body = card.querySelector('[data-body]');
        const btn = card.querySelector('[data-toggle]');
        body.style.display = open ? 'block' : 'none';
        btn.textContent = open ? '접기' : '펼치기';
      }
      document.querySelectorAll('[data-card]').forEach(card=>{
        const btn = card.querySelector('[data-toggle]');
        btn.addEventListener('click', ()=>{
          const isOpen = card.querySelector('[data-body]').style.display !== 'none';
          setCard(card, !isOpen);
        });
      });
      document.getElementById('expand')?.addEventListener('click', ()=>{
        document.querySelectorAll('[data-card]').forEach(c=>setCard(c,true));
      });
      document.getElementById('collapse')?.addEventListener('click', ()=>{
        document.querySelectorAll('[data-card]').forEach(c=>setCard(c,false));
      });

      // 복사 & 토스트
      function toast(){ const t=document.getElementById('toast'); t.style.display='block'; setTimeout(()=>t.style.display='none',1200); }
      window.copyText = function(id){
        const el = document.getElementById(id); if(!el) return; const tx = el.innerText;
        (navigator.clipboard?.writeText ? navigator.clipboard.writeText(tx) : new Promise((res,rej)=>{
          const ta=document.createElement('textarea'); ta.value=tx; document.body.appendChild(ta); ta.select();
          document.execCommand('copy') ? res() : rej(); document.body.removeChild(ta);
        })).then(toast).catch(toast);
      }

      // 날짜 문구 토글: 실시간 반영 (서버 계산된 대행사별 날짜 문구 사용)
      const agencyToDateLine = {{ (agency_to_date_line or {}) | tojson | safe }};
      const toggleEl = document.getElementById('toggleDateLine');
      const togglePrefix = document.getElementById('togglePrefix');
      const toggleSuffix = document.getElementById('toggleSuffix');
      const agencyToOriginalBody = {};

      function readMentions(){
        const p = (document.getElementById('autoMsgPrefix')?.value || '').trim();
        const s = (document.getElementById('autoMsgSuffix')?.value || '').trim();
        return { p, s };
      }

      function composeAll(){
        const useDate = !!toggleEl?.checked;
        const usePref = !!togglePrefix?.checked;
        const useSuf = !!toggleSuffix?.checked;
        const { p, s } = readMentions();
        document.querySelectorAll('[data-card]').forEach(card=>{
          const agency = card.getAttribute('data-agency');
          const body = card.querySelector('[data-body]'); if(!body) return;
          const original = (agency && agencyToOriginalBody[agency]) || body.getAttribute('data-original') || body.innerText;
          if(!agencyToOriginalBody[agency]) agencyToOriginalBody[agency] = original;
          const line = agencyToDateLine[agency] || '';
          // 헤더(첫 멘트 + 날짜 문구)를 줄바꿈 1번으로 연결
          let header = '';
          if(usePref && p) header = p;
          if(useDate && line) header = header ? (header + '\n' + line) : line;
          const parts = [];
          if(header) parts.push(header);
          parts.push(original);
          if(useSuf && s) parts.push(s);
          body.innerText = parts.join('\n\n').trim();
        });
      }

      toggleEl?.addEventListener('change', composeAll);
      togglePrefix?.addEventListener('change', composeAll);
      toggleSuffix?.addEventListener('change', composeAll);
      document.getElementById('autoMsgPrefix')?.addEventListener('input', ()=>{ composeAll(); try{ localStorage.setItem(LS_KEYS.prefix, document.getElementById('autoMsgPrefix').value); }catch(e){} });
      document.getElementById('autoMsgSuffix')?.addEventListener('input', ()=>{ composeAll(); try{ localStorage.setItem(LS_KEYS.suffix, document.getElementById('autoMsgSuffix').value); }catch(e){} });
      // 초기 상태: 날짜/멘트 토글 OFF/ON 설정
      if(toggleEl){ toggleEl.checked = false; }
      composeAll();

      // 자동 멘트 패널: 값 로드 및 저장 바인딩
      (function initAutoMentions(){
        const enabledEl = document.getElementById('autoMsgEnabled');
        const prefixEl = document.getElementById('autoMsgPrefix');
        const suffixEl = document.getElementById('autoMsgSuffix');
        if(!enabledEl || !prefixEl || !suffixEl) return;
        try{
          enabledEl.checked = localStorage.getItem(LS_KEYS.enabled) === '1';
          const savedPrefix = localStorage.getItem(LS_KEYS.prefix);
          const savedSuffix = localStorage.getItem(LS_KEYS.suffix);
          prefixEl.value = savedPrefix !== null ? savedPrefix : '대표님 안녕하세요~';
          suffixEl.value = savedSuffix !== null ? savedSuffix : '';
        }catch(e){}
        enabledEl.addEventListener('change', ()=>{
          try{ localStorage.setItem(LS_KEYS.enabled, enabledEl.checked ? '1' : '0'); }catch(e){}
        });
        prefixEl.addEventListener('input', ()=>{
          try{ localStorage.setItem(LS_KEYS.prefix, prefixEl.value); }catch(e){}
        });
        suffixEl.addEventListener('input', ()=>{
          try{ localStorage.setItem(LS_KEYS.suffix, suffixEl.value); }catch(e){}
        });
      })();
    </script>
  </body>
</html>
