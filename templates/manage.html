<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/static/favicon.png">
  <title>ì›”ë³´ì¥ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
  <style>
    :root {
      --bg: #f8fafc;
      --text: #0f172a;
      --muted: #64748b;
      --line: #e2e8f0;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --card-bg: #ffffff;
      --hover: #f1f5f9;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    /* ë ˆì´ì•„ì›ƒ */
    .header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--line);
      padding: 20px 0;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .05);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .logo {
      font-size: 24px;
      font-weight: 800;
      color: var(--text);
      text-decoration: none;
    }

    .logo:hover {
      color: var(--primary);
    }

    .nav-links {
      display: flex;
      gap: 8px;
    }

    .nav-link {
      padding: 8px 16px;
      border-radius: 8px;
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all .2s;
    }

    .nav-link:hover {
      background: var(--hover);
      color: var(--text);
    }

    .nav-link.active {
      background: var(--primary);
      color: #fff;
    }

    .main {
      padding: 32px 0;
    }

    .section {
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
    }

    /* í† ê¸€ ìŠ¤ìœ„ì¹˜ */
    .company-toggle {
      display: flex;
      gap: 8px;
      background: var(--card-bg);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 4px;
    }

    .toggle-btn {
      padding: 10px 24px;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s;
    }

    .toggle-btn.active {
      background: var(--primary);
      color: #fff;
    }

    /* ë²„íŠ¼ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all .2s;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: #fff;
      color: var(--text);
      border: 1px solid var(--line);
    }

    .btn-secondary:hover {
      background: var(--hover);
    }

    .btn-success {
      background: var(--success);
      color: #fff;
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* ê·¸ë¦¬ë“œ */
    .grid {
      display: grid;
      gap: 20px;
    }

    .grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .grid-4 {
      grid-template-columns: repeat(4, 1fr);
    }

    /* ì¹´ë“œ */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 20px;
      transition: all .2s;
    }

    .card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
    }

    /* í†µê³„ ì¹´ë“œ */
    .stat-card {
      position: relative;
      overflow: hidden;
    }

    .stat-icon {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 32px;
      opacity: 0.2;
    }

    .stat-label {
      font-size: 13px;
      color: var(--muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 800;
      line-height: 1;
      margin-bottom: 8px;
    }

    .stat-change {
      font-size: 12px;
      font-weight: 500;
    }

    .stat-change.up {
      color: var(--success);
    }

    .stat-change.down {
      color: var(--danger);
    }

    /* ë™ê¸°í™” ë°°ë„ˆ */
    .sync-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .sync-info {
      flex: 1;
    }

    .sync-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .sync-meta {
      font-size: 13px;
      opacity: 0.9;
    }

    /* ì°¨íŠ¸ */
    .chart-container {
      padding: 20px 0;
    }

    .chart-bar-group {
      margin-bottom: 16px;
    }

    .chart-label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
    }

    .chart-bar-bg {
      background: var(--line);
      height: 32px;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .chart-bar {
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      height: 100%;
      transition: width .4s ease;
      display: flex;
      align-items: center;
      padding: 0 12px;
      color: #fff;
      font-size: 12px;
      font-weight: 600;
    }

    /* í•„í„° */
    .filter-bar {
      background: var(--card-bg);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 16px;
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .filter-group {
      flex: 1;
      min-width: 150px;
    }

    .filter-label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
      margin-bottom: 6px;
      display: block;
    }

    .filter-input,
    .filter-select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--line);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: all .2s;
    }

    .filter-input:focus,
    .filter-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, .1);
    }

    /* í…Œì´ë¸” */
    .table-container {
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid var(--line);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
    }

    th {
      background: var(--hover);
      padding: 12px 16px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    td {
      padding: 14px 16px;
      border-top: 1px solid var(--line);
      font-size: 14px;
    }

    tbody tr {
      transition: background .2s;
    }

    tbody tr:hover {
      background: var(--hover);
    }

    /* ë°°ì§€ */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }

    .badge-ì§„í–‰ì¤‘ {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge-ì™„ë£Œ {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-ì„¸íŒ…ëŒ€ê¸° {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-ì¤‘ë‹¨ {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-í™˜ë¶ˆ {
      background: #f3e8ff;
      color: #6b21a8;
    }

    .badge-í›„ë¶ˆ {
      background: #fce7f3;
      color: #9f1239;
    }

    .badge-ì‹ ê·œ {
      background: #e0f2fe;
      color: #075985;
    }

    .badge-ì—°ì¥ {
      background: #fce7f3;
      color: #9f1239;
    }

    /* ì¦ê° í‘œì‹œ */
    .trend {
      font-size: 12px;
      font-weight: 600;
    }

    .trend-up {
      color: var(--success);
    }

    .trend-down {
      color: var(--danger);
    }

    /* ëª¨ë‹¬ */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow: auto;
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }

    .modal-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: all .2s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, .1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-footer {
      padding: 24px;
      border-top: 1px solid var(--line);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--text);
      color: #fff;
      padding: 14px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .15);
      z-index: 200;
      opacity: 0;
      transform: translateY(20px);
      transition: all .3s;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .empty-desc {
      font-size: 14px;
    }

    /* ë¡œë”© */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, .3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ìŠ¤í¬ë¡¤ ë²„íŠ¼ */
    .scroll-buttons {
      position: fixed;
      bottom: 24px;
      right: 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 90;
    }

    .scroll-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      border: none;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(59, 130, 246, .3);
      transition: all .2s;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.8);
    }

    .scroll-btn.show {
      opacity: 1;
      transform: scale(1);
    }

    .scroll-btn:hover {
      background: var(--primary-dark);
      box-shadow: 0 6px 16px rgba(59, 130, 246, .4);
    }

    .scroll-btn:active {
      transform: scale(0.95);
    }

    /* ì •ë ¬ ê°€ëŠ¥í•œ í…Œì´ë¸” í—¤ë” */
    th.sortable {
      position: relative;
    }

    th.sortable:hover {
      background: #e2e8f0;
      color: var(--primary);
    }

    th.sortable.sorted-asc .sort-icon {
      color: var(--primary);
    }

    th.sortable.sorted-desc .sort-icon {
      color: var(--primary);
    }

    th.sortable .sort-icon {
      font-size: 11px;
      color: var(--muted);
      margin-left: 4px;
      transition: color .2s;
    }

    th.sortable.sorted-asc .sort-icon::before {
      content: 'â†‘';
      position: absolute;
      margin-left: 2px;
    }

    th.sortable.sorted-desc .sort-icon::before {
      content: 'â†“';
      position: absolute;
      margin-left: 2px;
    }

    /* ë°˜ì‘í˜• */
    @media(max-width:768px) {
      .header-content {
        flex-direction: column;
        align-items: stretch;
      }

      .grid-2,
      .grid-3,
      .grid-4 {
        grid-template-columns: 1fr;
      }

      .filter-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .modal-content {
        width: 95%;
      }

      .scroll-buttons {
        bottom: 16px;
        right: 16px;
      }

      .scroll-btn {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }
    }
  </style>
</head>

<body>
  <!-- í—¤ë” -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="/" class="logo">ğŸ¢ ì œì´íˆ¬ë© ê´€ë¦¬ì‹œìŠ¤í…œ</a>
        <div class="nav-links">
          <a href="/" class="nav-link">ë§ˆê° ì•ˆë‚´</a>
          <a href="/manage" class="nav-link active">ì›”ë³´ì¥ ê´€ë¦¬</a>
          <a href="/settlement" class="nav-link">ê²°ì¬ì„  Â· ì •ì‚°</a>
        </div>
        <div id="user-info" style="display:flex; align-items:center; gap:12px;">
          <span id="user-name" style="font-size:13px; color:var(--muted);"></span>
          <span id="user-role" class="pill" style="font-size:11px;"></span>
          <button id="btn-logout" class="btn btn-sm btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ë©”ì¸ -->
  <main class="main">
    <div class="container">
      <!-- ë™ê¸°í™” ë°°ë„ˆ -->
      <div class="sync-banner">
        <div class="sync-info">
          <div class="sync-title">ğŸ“¡ êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™”</div>
          <div class="sync-meta">
            <span id="sync-status">ë§ˆì§€ë§‰ ë™ê¸°í™”: -</span> Â·
            <span id="next-sync">ë‹¤ìŒ: -</span>
          </div>
          <div class="sync-meta" style="margin-top:4px; font-size:12px; opacity:0.85;">
            <span id="workload-cache-status">âš¡ ì‘ì—…ëŸ‰ ìºì‹œ: ë¡œë”© ì¤‘...</span>
          </div>
        </div>
        <div style="display:flex; gap:12px; align-items:center;">
          <!-- íšŒì‚¬ í† ê¸€ -->
          <div class="company-toggle" style="background:rgba(255,255,255,.15); border-color:rgba(255,255,255,.2);">
            <button class="toggle-btn active" data-company="ì œì´íˆ¬ë©" style="color:#fff;">ğŸ¢ ì œì´íˆ¬ë©</button>
            <button class="toggle-btn" data-company="ì¼ë¥˜ê¸°íš" style="color:rgba(255,255,255,.7);">ğŸ¢ ì¼ë¥˜ê¸°íš</button>
          </div>
          <button class="btn" id="btn-sync"
            style="background:#fff; color:var(--primary); font-weight:600; box-shadow:0 2px 8px rgba(0,0,0,.15);"
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,.2)'"
            onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(0,0,0,.15)'">
            <span id="sync-btn-text">ğŸ”„ ë™ê¸°í™”</span>
          </button>
          <button class="btn" id="btn-refresh-workload"
            style="background:#10b981; color:#fff; font-weight:600; box-shadow:0 2px 8px rgba(0,0,0,.15);"
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,.2)'; this.style.background='#059669'"
            onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(0,0,0,.15)'; this.style.background='#10b981'">
            <span id="workload-btn-text">âš¡ ì‘ì—…ëŸ‰ ê°±ì‹ </span>
          </button>
          <button class="btn" id="btn-crawl-ranks"
            style="background:#8b5cf6; color:#fff; font-weight:600; box-shadow:0 2px 8px rgba(0,0,0,.15);"
            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,.2)'; this.style.background='#7c3aed'"
            onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(0,0,0,.15)'; this.style.background='#8b5cf6'">
            <span id="rank-btn-text">ğŸ† ìˆœìœ„ ê°±ì‹ </span>
          </button>
          <span id="last-crawl-time" style="margin-left:12px; font-size:12px; color:#666;"></span>
        </div>
      </div>

      <!-- ì£¼ìš” í†µê³„ -->
      <div class="section" style="margin-top:32px;">
        <div class="grid grid-4">
          <div class="card stat-card" style="border-left:4px solid var(--primary);">
            <div class="stat-icon">ğŸš€</div>
            <div class="stat-label">ì§„í–‰ì¤‘ ì—…ì²´</div>
            <div class="stat-value" id="stat-working">0</div>
            <div class="stat-change muted" style="font-size:11px;">ì§„í–‰ì¤‘ + í›„ë¶ˆ</div>
          </div>
          <div class="card stat-card" style="border-left:4px solid var(--success); cursor:pointer;"
            onclick="toggleExposureDetails()">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-label">ì‹¤ì‹œê°„ ë…¸ì¶œ í˜„í™©</div>
            <div style="display:flex; gap:12px; align-items:baseline; margin-top:8px;">
              <div style="flex:1;">
                <div style="font-size:14px; color:var(--success); font-weight:600;">ë…¸ì¶œ <span id="stat-exposed">0</span>
                </div>
              </div>
              <div style="flex:1;">
                <div style="font-size:14px; color:var(--danger); font-weight:600;">ë¯¸ë…¸ì¶œ <span
                    id="stat-not-exposed">0</span></div>
              </div>
            </div>
            <div class="stat-change muted" style="font-size:11px; margin-top:8px;">í´ë¦­í•˜ì—¬ ìƒì„¸ë³´ê¸°</div>
          </div>
          <div class="card stat-card" style="border-left:4px solid var(--warning); cursor:pointer;"
            onclick="toggleDeadlineDetails()">
            <div class="stat-icon">â°</div>
            <div class="stat-label">ë§ˆê° 5ì¼ ì´ë‚´</div>
            <div class="stat-value" style="color:var(--warning);" id="stat-deadline-total">0</div>
            <div style="font-size:12px; color:var(--muted); margin-top:8px; line-height:1.5;">
              <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                <span>ì˜¤ëŠ˜: <strong id="stat-deadline-0">0</strong></span>
                <span>1ì¼: <strong id="stat-deadline-1">0</strong></span>
                <span>2ì¼: <strong id="stat-deadline-2">0</strong></span>
              </div>
              <div style="display:flex; justify-content:space-between;">
                <span>3ì¼: <strong id="stat-deadline-3">0</strong></span>
                <span>4ì¼: <strong id="stat-deadline-4">0</strong></span>
                <span>5ì¼: <strong id="stat-deadline-5">0</strong></span>
              </div>
            </div>
          </div>
          <div class="card stat-card" style="border-left:4px solid #8b5cf6;">
            <div class="stat-icon">ğŸ’³</div>
            <div class="stat-label">í›„ë¶ˆ ì§„í–‰ê±´</div>
            <div class="stat-value" style="color:#8b5cf6;" id="stat-postpaid">0</div>
          </div>
        </div>
      </div>

      <!-- ë ˆì‹œí”¼ ë¶„ì„ ì„¹ì…˜ (N2 í†µê³„ë§Œ ìœ ì§€) -->
      <div class="section">
        <h2 class="section-title">ğŸ“Š N2 ë¶„ì„ í†µê³„ <span id="recipe-weeks-badge"
            style="font-size:12px; background:var(--primary); color:#fff; padding:2px 8px; border-radius:12px; margin-left:8px;">3ì£¼</span>
        </h2>

        <!-- N2 í†µê³„ ì¹´ë“œ -->
        <div class="grid grid-2" style="margin-bottom:20px;">
          <div class="card" style="border-left:4px solid var(--success);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="font-size:13px; color:var(--muted);">ì¼ë°˜ í‚¤ì›Œë“œ</div>
                <div style="font-size:24px; font-weight:700; color:var(--success);" id="general-n2-change">+0.000</div>
              </div>
              <div style="text-align:right;">
                <div style="font-size:12px; color:var(--muted);">ë¶„ì„ ì—…ì²´</div>
                <div style="font-size:18px; font-weight:600;" id="general-count">0</div>
              </div>
            </div>
          </div>
          <div class="card" style="border-left:4px solid var(--warning);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="font-size:13px; color:var(--muted);">ë§›ì§‘ í‚¤ì›Œë“œ (restaurant)</div>
                <div style="font-size:24px; font-weight:700; color:var(--warning);" id="restaurant-n2-change">+0.000
                </div>
              </div>
              <div style="text-align:right;">
                <div style="font-size:12px; color:var(--muted);">ë¶„ì„ ì—…ì²´</div>
                <div style="font-size:18px; font-weight:600;" id="restaurant-count">0</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ë¦¬ë·° ê¸‰ê° ì•Œë¦¼ -->
        <div id="recipe-alerts" style="display:none;">
          <div class="card" style="border-left:4px solid var(--danger);">
            <h3 style="font-size:15px; font-weight:600; color:var(--danger); margin-bottom:12px;">âš ï¸ ë¦¬ë·° ê°ì†Œ ê²½ê³ </h3>
            <div id="recipe-alerts-list"></div>
          </div>
        </div>
      </div>

      <!-- ì—…ì²´ ëŒ€ì‹œë³´ë“œ ìŠ¬ë¼ì´ë“œ íŒ¨ë„ -->
      <div id="business-dashboard-panel" class="slide-panel"
        style="display:none; position:fixed; top:0; right:-500px; width:500px; height:100vh; background:var(--card-bg); box-shadow:-5px 0 30px rgba(0,0,0,0.3); z-index:1000; transition:right 0.3s ease; padding:24px; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
          <h3 id="dashboard-business-name" style="font-size:18px; font-weight:700;">ì—…ì²´ëª…</h3>
          <button onclick="closeDashboardPanel()"
            style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--muted);">&times;</button>
        </div>
        <div id="dashboard-content">
          <!-- ë™ì  ì½˜í…ì¸  -->
        </div>
      </div>

      <!-- íšŒì‚¬ë³„ í˜„í™© -->
      <div class="section">
        <h2 class="section-title">ğŸ“ˆ íšŒì‚¬ë³„ í˜„í™©</h2>
        <div class="grid grid-2">
          <div class="card">
            <h3 style="font-size:16px; font-weight:600; margin-bottom:16px; color:var(--primary);"
              id="company-chart-title-1">ğŸ¢ ì œì´íˆ¬ë©</h3>
            <div class="chart-container" id="chart-company"></div>
          </div>
          <div class="card">
            <h3 style="font-size:16px; font-weight:600; margin-bottom:16px;">ğŸ“Š ìƒíƒœë³„ ë¶„í¬</h3>
            <div class="chart-container" id="chart-status"></div>
          </div>
        </div>
      </div>

      <!-- ìƒí’ˆë³„ / ì›”ë³„ ë¶„ì„ -->
      <div class="section">
        <div class="grid grid-2">
          <div class="card">
            <h3 style="font-size:16px; font-weight:600; margin-bottom:16px;">ğŸ“¦ ìƒí’ˆë³„ ë¶„í¬</h3>
            <div class="chart-container" id="chart-products"></div>
          </div>
          <div class="card">
            <h3 style="font-size:16px; font-weight:600; margin-bottom:16px;">ğŸ“… ì›”ë³„ ê³„ì•½ ê±´ìˆ˜</h3>
            <div class="chart-container" id="chart-monthly"></div>
          </div>
        </div>
      </div>

      <!-- í•„í„° ë° ê²€ìƒ‰ -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">ğŸ“‹ ë³´ì¥ê±´ ëª©ë¡</h2>
          <button class="btn btn-success" id="btn-add">â• ìƒˆ ë³´ì¥ê±´ ë“±ë¡</button>
        </div>
        <div class="filter-bar">
          <div class="filter-group">
            <label class="filter-label">ìƒíƒœ</label>
            <select class="filter-select" id="filter-status">
              <option value="">ì „ì²´</option>
              <option value="ì§„í–‰ì¤‘,í›„ë¶ˆ">ì§„í–‰ì¤‘(í›„ë¶ˆê±´ í¬í•¨)</option>
              <option value="ì„¸íŒ…ëŒ€ê¸°">ì„¸íŒ…ëŒ€ê¸°</option>
              <option value="ì™„ë£Œ">ì™„ë£Œ</option>
              <option value="ì¤‘ë‹¨">ì¤‘ë‹¨</option>
              <option value="í™˜ë¶ˆ">í™˜ë¶ˆ</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">ìƒí’ˆ</label>
            <select class="filter-select" id="filter-product">
              <option value="">ì „ì²´</option>
              <option value="í”Œë ˆì´ìŠ¤">í”Œë ˆì´ìŠ¤</option>
              <option value="ì‡¼í•‘">ì‡¼í•‘</option>
              <option value="ìë™ì™„ì„±">ìë™ì™„ì„±</option>
              <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>
          </div>
          <div class="filter-group" style="flex:2;">
            <label class="filter-label">ê²€ìƒ‰</label>
            <input type="text" class="filter-input" id="search-input" placeholder="ìƒí˜¸ëª…, í‚¤ì›Œë“œ, ëŒ€í–‰ì‚¬ ê²€ìƒ‰...">
          </div>
          <button class="btn btn-primary" id="btn-search">ğŸ” ê²€ìƒ‰</button>
          <button class="btn btn-secondary" id="btn-reset">ğŸ”„ ì´ˆê¸°í™”</button>
        </div>
      </div>

      <!-- í…Œì´ë¸” -->
      <div class="section">
        <div class="table-container">
          <table id="guarantee-table">
            <thead>
              <tr>
                <th>êµ¬ë¶„</th>
                <th class="sortable" data-sort="agency" style="cursor:pointer; user-select:none;">
                  ëŒ€í–‰ì‚¬ <span class="sort-icon">â‡…</span>
                </th>
                <th class="sortable" data-sort="business_name" style="cursor:pointer; user-select:none;">
                  ìƒí˜¸ëª… <span class="sort-icon">â‡…</span>
                </th>
                <th>í‚¤ì›Œë“œ</th>
                <th class="sortable" data-sort="status" style="cursor:pointer; user-select:none;">
                  ìƒíƒœ <span class="sort-icon">â‡…</span>
                </th>
                <th>í˜„ì¬ìˆœìœ„</th>
                <th>N2 ë³€í™”</th>
                <th>ì§„í–‰ì¼</th>
                <th>ë¦¬ë·°ë³€í™”</th>
              </tr>
            </thead>
            <tbody id="table-body">
              <tr>
                <td colspan="9" style="text-align:center; padding:40px; color:var(--muted);">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- ëª¨ë‹¬ -->
  <div class="modal" id="guarantee-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title">ìƒˆ ë³´ì¥ê±´ ë“±ë¡</h3>
        <button class="btn btn-sm btn-secondary" onclick="closeModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <form id="guarantee-form">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">êµ¬ë¶„*</label>
              <select name="type" class="form-select" required>
                <option value="ì‹ ê·œ">ì‹ ê·œ</option>
                <option value="ì—°ì¥">ì—°ì¥</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">íšŒì‚¬*</label>
              <select name="company" class="form-select" required>
                <option value="ì œì´íˆ¬ë©">ì œì´íˆ¬ë©</option>
                <option value="ì¼ë¥˜ê¸°íš">ì¼ë¥˜ê¸°íš</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ê³„ì•½ì¼*</label>
              <input type="date" name="contract_date" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">ì‘ì—… ì‹œì‘ì¼</label>
              <input type="date" name="work_start_date" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ëŒ€í–‰ì‚¬</label>
              <input type="text" name="agency" class="form-input" placeholder="ëŒ€í–‰ì‚¬ëª…">
            </div>
            <div class="form-group">
              <label class="form-label">ìƒí˜¸ëª…*</label>
              <input type="text" name="business_name" class="form-input" placeholder="ì—…ì²´ ìƒí˜¸ëª…" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ë©”ì¸ í‚¤ì›Œë“œ</label>
              <input type="text" name="main_keyword" class="form-input" placeholder="ë…¸ì¶œ í‚¤ì›Œë“œ">
            </div>
            <div class="form-group">
              <label class="form-label">ë³´ì¥ ìˆœìœ„</label>
              <input type="text" name="guarantee_rank" class="form-input" placeholder="ì˜ˆ: 5ìœ„ ì´ìƒ">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ìƒí’ˆ</label>
              <select name="product" class="form-select">
                <option value="í”Œë ˆì´ìŠ¤">í”Œë ˆì´ìŠ¤</option>
                <option value="ì‡¼í•‘">ì‡¼í•‘</option>
                <option value="ìë™ì™„ì„±">ìë™ì™„ì„±</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">ìƒíƒœ</label>
              <select name="status" class="form-select">
                <option value="ì„¸íŒ…ëŒ€ê¸°">ì„¸íŒ…ëŒ€ê¸°</option>
                <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                <option value="ì¤‘ë‹¨">ì¤‘ë‹¨</option>
                <option value="í™˜ë¶ˆ">í™˜ë¶ˆ</option>
                <option value="í›„ë¶ˆ">í›„ë¶ˆ</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ì´ ê³„ì•½ê¸ˆ (VAT ì œì™¸)</label>
              <input type="number" name="total_contract" class="form-input" placeholder="0">
            </div>
            <div class="form-group">
              <label class="form-label">ì…ê¸ˆì•¡/ë§ˆì§„ (VAT ì œì™¸)</label>
              <input type="number" name="deposit_amount" class="form-input" placeholder="0">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">ë©”ëª¨</label>
            <textarea name="memo" class="form-textarea" placeholder="ë©”ëª¨ ì…ë ¥..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
        <button type="submit" form="guarantee-form" class="btn btn-primary">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì‘ì—…ëŸ‰ ìŠ¤ì¼€ì¤„ ëª¨ë‹¬ -->
  <div class="modal" id="workload-modal">
    <div class="modal-content" style="max-width:500px;">
      <div class="modal-header">
        <h3 class="modal-title" style="font-size:16px;">ğŸ“Š ì‘ì—…ëŸ‰ ìŠ¤ì¼€ì¤„ (ìµœê·¼ 4ì£¼)</h3>
        <button class="btn btn-sm btn-secondary" onclick="closeWorkloadModal()">âœ•</button>
      </div>
      <div class="modal-body" style="padding:20px; background:var(--bg);">
        <div id="workload-content" style="font-family:'Malgun Gothic', sans-serif; font-size:13px; line-height:1.6;">
          <div style="text-align:center; padding:40px; color:var(--muted);">
            <div class="loading" style="margin:0 auto 16px;"></div>
            <div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="btn-copy-workload" onclick="copyWorkloadToClipboard()"
          style="display:inline-flex;">ğŸ“‹ ë³µì‚¬</button>
        <button type="button" class="btn btn-secondary" onclick="closeWorkloadModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ë…¸ì¶œ í˜„í™© ìƒì„¸ ëª¨ë‹¬ -->
  <div class="modal" id="exposure-modal">
    <div class="modal-content" style="max-width:600px;">
      <div class="modal-header">
        <h3 class="modal-title">ğŸ“Š ì‹¤ì‹œê°„ ë…¸ì¶œ í˜„í™©</h3>
        <button class="btn btn-sm btn-secondary" onclick="closeExposureModal()">âœ•</button>
      </div>
      <div class="modal-body" style="padding:20px; background:var(--bg); max-height:70vh; overflow-y:auto;">
        <div id="exposure-details-content">
          <div style="text-align:center; padding:40px; color:var(--muted);">
            <div class="loading" style="margin:0 auto 16px;"></div>
            <div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeExposureModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ë§ˆê° ì„ë°• ìƒì„¸ ëª¨ë‹¬ -->
  <div class="modal" id="deadline-modal">
    <div class="modal-content" style="max-width:500px;">
      <div class="modal-header">
        <h3 class="modal-title">â° ë§ˆê° ì„ë°• í˜„í™©</h3>
        <button class="btn btn-sm btn-secondary" onclick="closeDeadlineModal()">âœ•</button>
      </div>
      <div class="modal-body" style="padding:20px; background:var(--bg); max-height:70vh; overflow-y:auto;">
        <div id="deadline-details-content">
          <div style="text-align:center; padding:40px; color:var(--muted);">
            <div class="loading" style="margin:0 auto 16px;"></div>
            <div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeDeadlineModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- ìŠ¤í¬ë¡¤ ë²„íŠ¼ -->
  <div class="scroll-buttons">
    <button class="scroll-btn" id="scroll-top" onclick="scrollToTop()" title="ë§¨ ìœ„ë¡œ">â†‘</button>
    <button class="scroll-btn" id="scroll-bottom" onclick="scrollToBottom()" title="ë§¨ ì•„ë˜ë¡œ">â†“</button>
  </div>

  <script>
    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
    async function loadUserInfo() {
      try {
        const res = await fetch('/api/auth/me');
        if (res.ok) {
          const data = await res.json();
          const user = data.user;
          if (user) {
            const nameEl = document.getElementById('user-name');
            const roleEl = document.getElementById('user-role');
            if (nameEl) nameEl.textContent = user.name || user.username;
            if (roleEl) {
              const roleNames = { admin: 'ê´€ë¦¬ì', manager: 'ë§¤ë‹ˆì €', user: 'ì¼ë°˜' };
              roleEl.textContent = roleNames[user.role] || user.role;
            }
          }
        }
      } catch (e) { console.warn('User info load error:', e); }
    }

    // ë¡œê·¸ì•„ì›ƒ
    async function logout() {
      try {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.href = '/login';
      } catch (e) {
        window.location.href = '/login';
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', loadUserInfo);

    let allData = [];
    let currentEditId = null;
    let currentCompany = 'ì œì´íˆ¬ë©';  // ê¸°ë³¸ê°’
    let businessWorkloadCache = {};  // ì—…ì²´ë³„ ì‘ì—…ëŸ‰ ìºì‹œ
    let currentWorkloadData = null;  // í˜„ì¬ í‘œì‹œì¤‘ì¸ ì‘ì—…ëŸ‰ ë°ì´í„°
    let latestRanks = {};  // í¬ë¡¤ë§ëœ ìµœì‹  ìˆœìœ„ ë°ì´í„° (ìƒí˜¸ëª… -> ìˆœìœ„)

    // ì •ë ¬ ìƒíƒœ ê´€ë¦¬
    let currentSort = {
      field: 'agency',  // ê¸°ë³¸: ëŒ€í–‰ì‚¬ëª…
      direction: 'asc'   // asc | desc
    };

    // Toast
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ì‘ì—…ëŸ‰ ìºì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
    async function updateWorkloadCacheStatus() {
      try {
        const res = await fetch('/api/workload/cache/status');
        const status = await res.json();

        const statusEl = document.getElementById('workload-cache-status');
        if (status.is_valid && status.updated_at) {
          const updateTime = new Date(status.updated_at);
          const timeStr = updateTime.toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
          });
          const businessInfo = status.business_count > 0 ? `, ${status.business_count}ê°œ ì—…ì²´` : '';
          statusEl.innerHTML = `âš¡ ì‘ì—…ëŸ‰ ìºì‹œ: ${timeStr} (${status.company_count}ê°œ íšŒì‚¬${businessInfo})`;
          statusEl.style.color = 'rgba(255,255,255,0.9)';
        } else {
          statusEl.innerHTML = 'âš¡ ì‘ì—…ëŸ‰ ìºì‹œ: ì—†ìŒ (ê°±ì‹  í•„ìš”)';
          statusEl.style.color = 'rgba(255,200,0,0.9)';
        }
      } catch (e) {
        console.error('Failed to load cache status:', e);
        document.getElementById('workload-cache-status').innerHTML = 'âš¡ ì‘ì—…ëŸ‰ ìºì‹œ: ìƒíƒœ í™•ì¸ ì‹¤íŒ¨';
      }
    }

    // ì—…ì²´ë³„ ì‘ì—…ëŸ‰ ë°ì´í„° ë¯¸ë¦¬ ë¡œë“œ
    async function loadBusinessWorkloads() {
      const statusEl = document.getElementById('workload-cache-status');

      try {
        console.log(`Loading business workloads for ${currentCompany}...`);
        statusEl.innerHTML = 'âš¡ ì‘ì—…ëŸ‰ ìºì‹œ: ë¡œë”© ì¤‘...';
        statusEl.style.color = 'rgba(255,200,0,0.9)';

        const res = await fetch(`/api/workload/businesses?company=${encodeURIComponent(currentCompany)}`);
        const data = await res.json();

        if (data.businesses && Object.keys(data.businesses).length > 0) {
          businessWorkloadCache = data.businesses;
          console.log(`âœ… Loaded ${data.count} business workloads from ${data.from_cache ? 'cache' : 'direct'}`);
          console.log(`ğŸ“‹ ì—…ì²´ ëª©ë¡: ${Object.keys(data.businesses).join(', ')}`);
        } else {
          businessWorkloadCache = {};
          console.log('âš ï¸ No business workload data available');
          if (data.message) {
            console.log(data.message);
          }
        }

        // ìºì‹œ ìƒíƒœë„ ì—…ë°ì´íŠ¸
        updateWorkloadCacheStatus();
      } catch (e) {
        console.error('Failed to load business workloads:', e);
        businessWorkloadCache = {};
        statusEl.innerHTML = 'âš¡ ì‘ì—…ëŸ‰ ìºì‹œ: ë¡œë“œ ì‹¤íŒ¨';
        statusEl.style.color = 'rgba(255,100,100,0.9)';
      }
    }

    // íšŒì‚¬ í† ê¸€
    document.querySelectorAll('.toggle-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentCompany = btn.dataset.company;

        // í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.toggle-btn').forEach(b => {
          b.classList.remove('active');
          b.style.color = 'rgba(255,255,255,.7)';
        });
        btn.classList.add('active');
        btn.style.color = '#fff';

        // ë°ì´í„° ì¬ë¡œë“œ
        loadLatestRanks();  // ìˆœìœ„ ë°ì´í„° ë¨¼ì € ë¡œë“œ
        loadData();
        updateExposureStatus();
        updateDeadlineStatus();
        loadBusinessWorkloads();  // ì—…ì²´ë³„ ì‘ì—…ëŸ‰ë„ ì¬ë¡œë“œ
        loadRecipeAnalysis();  // ë ˆì‹œí”¼ ë¶„ì„ë„ ì¬ë¡œë“œ
      });
    });

    // ëª¨ë‹¬
    function openModal(item = null) {
      const modal = document.getElementById('guarantee-modal');
      const form = document.getElementById('guarantee-form');
      const title = document.getElementById('modal-title');

      if (item) {
        title.textContent = 'ë³´ì¥ê±´ ìˆ˜ì •';
        currentEditId = item.id;
        Object.keys(item).forEach(key => {
          if (form[key]) form[key].value = item[key] || '';
        });
      } else {
        title.textContent = 'ìƒˆ ë³´ì¥ê±´ ë“±ë¡';
        currentEditId = null;
        form.reset();
        // í˜„ì¬ ì„ íƒëœ íšŒì‚¬ë¡œ ê¸°ë³¸ê°’ ì„¤ì •
        form.company.value = currentCompany;
      }

      modal.classList.add('show');
    }

    function closeModal() {
      document.getElementById('guarantee-modal').classList.remove('show');
      currentEditId = null;
    }

    // ë…¸ì¶œ í˜„í™© ë¡œë“œ
    async function updateExposureStatus() {
      try {
        const res = await fetch(`/api/guarantee/exposure-status?company=${encodeURIComponent(currentCompany)}`);
        const data = await res.json();

        // í†µê³„ ì—…ë°ì´íŠ¸
        document.getElementById('stat-exposed').textContent = data.exposed || 0;
        document.getElementById('stat-not-exposed').textContent = data.not_exposed || 0;

        // ì§„í–‰ì¤‘ ì—…ì²´ ìˆ˜ (ë…¸ì¶œ+ë¯¸ë…¸ì¶œ)
        const workingCount = (data.exposed || 0) + (data.not_exposed || 0);
        document.getElementById('stat-working').textContent = workingCount;

      } catch (e) {
        console.error('Exposure status error:', e);
      }
    }

    // ë§ˆê° ì„ë°• í˜„í™© ë¡œë“œ
    async function updateDeadlineStatus() {
      try {
        const res = await fetch(`/api/guarantee/deadline-status?company=${encodeURIComponent(currentCompany)}`);
        const data = await res.json();

        // í†µê³„ ì—…ë°ì´íŠ¸
        document.getElementById('stat-deadline-total').textContent = data.total || 0;

        // ì¼ë³„ í†µê³„ ì—…ë°ì´íŠ¸
        const byDays = data.items_by_days_remaining || {};
        for (let i = 0; i <= 5; i++) {
          const el = document.getElementById(`stat-deadline-${i}`);
          if (el) {
            el.textContent = (byDays[i] || []).length;
          }
        }

      } catch (e) {
        console.error('Deadline status error:', e);
      }
    }

    // ë…¸ì¶œ í˜„í™© ìƒì„¸ ëª¨ë‹¬
    async function toggleExposureDetails() {
      const modal = document.getElementById('exposure-modal');
      const content = document.getElementById('exposure-details-content');
      modal.classList.add('show');

      try {
        const res = await fetch(`/api/guarantee/exposure-status?company=${encodeURIComponent(currentCompany)}`);
        const data = await res.json();

        if (!data.exposure_details || data.exposure_details.length === 0) {
          content.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">ğŸ“­</div>
              <div class="empty-title">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
              <div class="empty-desc">ì§„í–‰ì¤‘ì¸ ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
          `;
          return;
        }

        // ë…¸ì¶œ/ë¯¸ë…¸ì¶œ êµ¬ë¶„
        const exposed = data.exposure_details.filter(d => d.is_exposed);
        const notExposed = data.exposure_details.filter(d => !d.is_exposed);

        let html = '';

        if (exposed.length > 0) {
          html += `<div style="margin-bottom:20px;">
            <h4 style="color:var(--success); font-size:15px; font-weight:600; margin-bottom:10px;">âœ… ë…¸ì¶œ ì¤‘ (${exposed.length}ê±´)</h4>
            <div style="display:grid; gap:6px;">`;
          exposed.forEach(item => {
            // í¬ë¡¤ë§ëœ ìˆœìœ„ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
            const displayRank = item.crawled_rank || item.current_rank || '-';
            const rankSource = item.crawled_rank ? '(ì‹¤ì‹œê°„)' : '(ì‹œíŠ¸)';

            html += `
              <div style="padding:10px; background:var(--card-bg); border-radius:6px; border:1px solid #d1fae5;">
                <div style="font-weight:600; font-size:14px; margin-bottom:2px;">${item.business_name}</div>
                <div style="font-size:12px; color:var(--muted);">
                  ${item.main_keyword || '-'} | ìˆœìœ„: <strong style="color:var(--success);">${displayRank}${displayRank !== '-' ? 'ìœ„' : ''}</strong> <span style="font-size:11px;">${displayRank !== '-' ? rankSource : ''}</span>
                </div>
              </div>
            `;
          });
          html += '</div></div>';
        }

        if (notExposed.length > 0) {
          html += `<div>
            <h4 style="color:var(--danger); font-size:15px; font-weight:600; margin-bottom:10px;">âš ï¸ ë¯¸ë…¸ì¶œ (${notExposed.length}ê±´)</h4>
            <div style="display:grid; gap:6px;">`;
          notExposed.forEach(item => {
            // í¬ë¡¤ë§ëœ ìˆœìœ„ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
            const displayRank = item.crawled_rank || item.current_rank || '-';
            const rankSource = item.crawled_rank ? '(ì‹¤ì‹œê°„)' : '(ì‹œíŠ¸)';

            html += `
              <div style="padding:10px; background:var(--card-bg); border-radius:6px; border:1px solid #fee2e2;">
                <div style="font-weight:600; font-size:14px; margin-bottom:2px;">${item.business_name}</div>
                <div style="font-size:12px; color:var(--muted);">
                  ${item.main_keyword || '-'} | ìˆœìœ„: <strong>${displayRank}${displayRank !== '-' ? 'ìœ„' : ''}</strong> <span style="font-size:11px;">${displayRank !== '-' ? rankSource : ''}</span>
                </div>
              </div>
            `;
          });
          html += '</div></div>';
        }

        content.innerHTML = html;
      } catch (e) {
        console.error('Error loading exposure details:', e);
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âš ï¸</div>
            <div class="empty-title">ì˜¤ë¥˜ ë°œìƒ</div>
            <div class="empty-desc">${e.message}</div>
          </div>
        `;
      }
    }

    function closeExposureModal() {
      document.getElementById('exposure-modal').classList.remove('show');
    }

    // ë§ˆê° ì„ë°• ìƒì„¸ ëª¨ë‹¬
    async function toggleDeadlineDetails() {
      const modal = document.getElementById('deadline-modal');
      const content = document.getElementById('deadline-details-content');
      modal.classList.add('show');

      try {
        const res = await fetch(`/api/guarantee/deadline-status?company=${encodeURIComponent(currentCompany)}`);
        const data = await res.json();

        if (data.total === 0) {
          content.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">âœ…</div>
              <div class="empty-title">ë§ˆê° ì„ë°• ê±´ì´ ì—†ìŠµë‹ˆë‹¤</div>
              <div class="empty-desc">5ì¼ ì´ë‚´ ë§ˆê°ë˜ëŠ” ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
          `;
          return;
        }

        const byDays = data.items_by_days_remaining || {};
        let html = '';

        // ë‚¨ì€ ì¼ìˆ˜ë³„ ìƒ‰ìƒ ë° ì•„ì´ì½˜ ë§¤í•‘
        const dayConfig = {
          0: { icon: 'ğŸ”´', label: 'ì˜¤ëŠ˜ ë§Œë£Œ', bg: '#fee2e2', border: 'var(--danger)', color: 'var(--danger)' },
          1: { icon: 'ğŸŸ ', label: '1ì¼ ë‚¨ìŒ', bg: '#ffedd5', border: '#fb923c', color: '#ea580c' },
          2: { icon: 'ğŸŸ¡', label: '2ì¼ ë‚¨ìŒ', bg: '#fef3c7', border: 'var(--warning)', color: 'var(--warning)' },
          3: { icon: 'ğŸŸ¢', label: '3ì¼ ë‚¨ìŒ', bg: '#d1fae5', border: '#10b981', color: '#059669' },
          4: { icon: 'ğŸ”µ', label: '4ì¼ ë‚¨ìŒ', bg: '#dbeafe', border: 'var(--primary)', color: 'var(--primary)' },
          5: { icon: 'âšª', label: '5ì¼ ë‚¨ìŒ', bg: '#e0e7ff', border: '#6366f1', color: '#4f46e5' }
        };

        // 0ì¼ë¶€í„° 5ì¼ê¹Œì§€ ìˆœì„œëŒ€ë¡œ í‘œì‹œ
        for (let i = 0; i <= 5; i++) {
          const items = byDays[i] || [];
          if (items.length === 0) continue;

          const config = dayConfig[i];
          html += `<div style="margin-bottom:16px;">
            <h4 style="color:${config.color}; font-size:15px; font-weight:600; margin-bottom:10px;">
              ${config.icon} ${config.label} (${items.length}ê±´)
            </h4>
            <div style="display:grid; gap:6px;">`;

          items.forEach(item => {
            html += `
              <div style="padding:10px; background:${config.bg}; border-radius:6px; border:1px solid ${config.border};">
                <div style="font-weight:600; font-size:14px; margin-bottom:2px;">${item.business_name}</div>
                <div style="font-size:12px; color:var(--muted);">
                  ${item.main_keyword || '-'}
                </div>
              </div>
            `;
          });

          html += '</div></div>';
        }

        content.innerHTML = html;
      } catch (e) {
        console.error('Error loading deadline details:', e);
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âš ï¸</div>
            <div class="empty-title">ì˜¤ë¥˜ ë°œìƒ</div>
            <div class="empty-desc">${e.message}</div>
          </div>
        `;
      }
    }

    function closeDeadlineModal() {
      document.getElementById('deadline-modal').classList.remove('show');
    }

    // ìµœì‹  ìˆœìœ„ ë°ì´í„° ë¡œë“œ
    let lastCollectedAt = null;  // ë§ˆì§€ë§‰ ìˆ˜ì§‘ ì‹œê°„

    async function loadLatestRanks() {
      try {
        const res = await fetch(`/api/guarantee/latest-ranks?company=${encodeURIComponent(currentCompany)}`);
        const data = await res.json();

        // ìƒí˜¸ëª… -> ìˆœìœ„ ë§¤í•‘
        latestRanks = {};
        (data.ranks || []).forEach(r => {
          latestRanks[r.business_name] = {
            rank: r.rank,
            keyword: r.keyword,
            checked_at: r.checked_at,
            collected_at: r.collected_at
          };
          // ë§ˆì§€ë§‰ ìˆ˜ì§‘ ì‹œê°„ ì €ì¥
          if (r.collected_at) {
            lastCollectedAt = r.collected_at;
          }
        });

        console.log(`âœ… Loaded ${Object.keys(latestRanks).length} latest ranks`);

        // ë§ˆì§€ë§‰ ì§‘ê³„ ì‹œê°„ UI ì—…ë°ì´íŠ¸
        updateLastCrawlTime();
      } catch (e) {
        console.error('Failed to load latest ranks:', e);
        latestRanks = {};
      }
    }

    // ë°ì´í„° ë¡œë“œ
    async function loadData() {
      try {
        const status = document.getElementById('filter-status').value;
        const product = document.getElementById('filter-product').value;

        const params = new URLSearchParams();
        params.append('company', currentCompany);
        if (status) params.append('status', status);
        if (product) params.append('product', product);

        const res = await fetch(`/api/guarantee/items?${params}`);
        const data = await res.json();

        allData = data.items || [];

        // ìµœì‹  ìˆœìœ„ ë°ì´í„°ë„ ë¡œë“œ
        await loadLatestRanks();

        renderTable(allData);
        updateStatistics();
        updateCharts();
      } catch (e) {
        console.error(e);
        showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
      }
    }

    // ì •ë ¬ í•¨ìˆ˜
    function sortItems(items, field, direction) {
      const sorted = [...items].sort((a, b) => {
        let aVal = a[field] || '';
        let bVal = b[field] || '';

        // ëŒ€í–‰ì‚¬ëª… ê¸°ì¤€ ì •ë ¬ ì‹œ: ë¹ˆ ê°’ì€ ë§¨ ë’¤ë¡œ
        if (field === 'agency') {
          if (!aVal) return 1;
          if (!bVal) return -1;
        }

        // ë‚ ì§œ í•„ë“œ ì²˜ë¦¬
        if (field === 'contract_date' || field === 'work_start_date') {
          aVal = aVal || '9999-99-99';  // ë¹ˆ ë‚ ì§œëŠ” ë§¨ ë’¤
          bVal = bVal || '9999-99-99';
        }

        // ë¬¸ìì—´ ë¹„êµ
        if (typeof aVal === 'string' && typeof bVal === 'string') {
          const result = aVal.localeCompare(bVal, 'ko');
          return direction === 'asc' ? result : -result;
        }

        // ìˆ«ì ë¹„êµ
        if (aVal < bVal) return direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return direction === 'asc' ? 1 : -1;
        return 0;
      });

      // ëŒ€í–‰ì‚¬ëª… ì •ë ¬ ì‹œ: ê°™ì€ ëŒ€í–‰ì‚¬ ë‚´ì—ì„œëŠ” ìƒí˜¸ëª… ì •ë ¬ (2ì°¨ ì •ë ¬)
      if (field === 'agency') {
        return sorted.sort((a, b) => {
          const agencyCompare = (a.agency || '').localeCompare(b.agency || '', 'ko');
          if (agencyCompare !== 0) {
            return direction === 'asc' ? agencyCompare : -agencyCompare;
          }
          // ê°™ì€ ëŒ€í–‰ì‚¬ ë‚´ì—ì„œëŠ” ìƒí˜¸ëª… ì˜¤ë¦„ì°¨ìˆœ
          return (a.business_name || '').localeCompare(b.business_name || '', 'ko');
        });
      }

      return sorted;
    }

    // ì •ë ¬ í—¤ë” UI ì—…ë°ì´íŠ¸
    function updateSortHeaders() {
      document.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        const field = th.dataset.sort;
        if (field === currentSort.field) {
          th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
      });
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable(items) {
      const tbody = document.getElementById('table-body');

      if (!items || items.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9">
              <div class="empty-state">
                <div class="empty-icon">ğŸ“­</div>
                <div class="empty-title">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                <div class="empty-desc">í•„í„°ë¥¼ ë³€ê²½í•˜ê±°ë‚˜ ìƒˆ ë³´ì¥ê±´ì„ ë“±ë¡í•´ë³´ì„¸ìš”</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      // ì •ë ¬ ì ìš©
      const sortedItems = sortItems(items, currentSort.field, currentSort.direction);
      updateSortHeaders();

      tbody.innerHTML = sortedItems.map(item => {
        // í¬ë¡¤ë§ëœ ì‹¤ì‹œê°„ ìˆœìœ„ ì‚¬ìš© (ì—†ìœ¼ë©´ ì‹œíŠ¸ ë°ì´í„° ì‚¬ìš©)
        const businessName = item.business_name || '';
        let currentRank = '-';

        // 1ìˆœìœ„: í¬ë¡¤ë§ëœ ìˆœìœ„
        if (latestRanks[businessName]) {
          currentRank = latestRanks[businessName].rank || '-';
        } else {
          // 2ìˆœìœ„: ì‹œíŠ¸ì˜ daily_ranks
          const dailyRanks = item.daily_ranks || {};
          const sortedDays = Object.keys(dailyRanks).map(d => parseInt(d)).sort((a, b) => a - b);

          if (sortedDays.length > 0) {
            const latestDay = sortedDays[sortedDays.length - 1];
            const latestRankData = dailyRanks[latestDay];

            // daily_ranksê°€ ê°ì²´ í˜•íƒœì¸ ê²½ìš° ì²˜ë¦¬ (ìƒˆ í˜•ì‹: {date: "...", rank: 3})
            if (typeof latestRankData === 'object' && latestRankData !== null) {
              currentRank = latestRankData.rank || '-';
            } else {
              // ë ˆê±°ì‹œ í˜•ì‹ (ìˆ«ìë§Œ)
              currentRank = latestRankData || '-';
            }
          }
        }

        // ë ˆì‹œí”¼ ë¶„ì„ ë°ì´í„°ì—ì„œ N2/ë¦¬ë·° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const recipeData = recipeAnalysisData?.businesses?.find(b => b.name === businessName);

        // N2 ë³€í™”
        let n2ChangeHtml = '<span style="color:var(--muted);">-</span>';
        if (recipeData?.n2_analysis?.delta !== null && recipeData?.n2_analysis?.delta !== undefined) {
          const n2Delta = recipeData.n2_analysis.delta;
          const n2Sign = n2Delta >= 0 ? 'â–²' : 'â–¼';
          const n2Color = n2Delta >= 0 ? 'var(--success)' : 'var(--danger)';
          n2ChangeHtml = `<span style="color:${n2Color}; font-weight:600;">${n2Sign}${Math.abs(n2Delta).toFixed(4)}</span>`;
        }

        // ì§„í–‰ì¼
        const exposureDays = recipeData?.exposure_days || item.exposure_days || '-';

        // ë¦¬ë·° ë³€í™”
        let reviewChangeHtml = '<span style="color:var(--muted);">-</span>';
        if (recipeData?.review_analysis?.delta !== null && recipeData?.review_analysis?.delta !== undefined) {
          const reviewDelta = recipeData.review_analysis.delta;
          const reviewSign = reviewDelta >= 0 ? 'â–²' : 'â–¼';
          const reviewColor = reviewDelta >= 0 ? 'var(--success)' : 'var(--danger)';
          reviewChangeHtml = `<span style="color:${reviewColor}; font-weight:600;">${reviewSign}${Math.abs(reviewDelta)}</span>`;
        }

        return `
          <tr onclick="openBusinessSlidePanel('${encodeURIComponent(businessName)}', '${item.id}')" 
              style="cursor:pointer; transition:background 0.2s;"
              onmouseover="this.style.background='rgba(99,102,241,0.08)'" 
              onmouseout="this.style.background=''">
            <td><span class="badge badge-${item.type || 'ì‹ ê·œ'}">${item.type || 'ì‹ ê·œ'}</span></td>
            <td>${item.agency || '-'}</td>
            <td><strong>${item.business_name || ''}</strong></td>
            <td>${item.main_keyword || '-'}</td>
            <td><span class="badge badge-${item.status || 'ì„¸íŒ…ëŒ€ê¸°'}">${item.status || 'ì„¸íŒ…ëŒ€ê¸°'}</span></td>
            <td><strong style="color:${currentRank !== '-' && currentRank <= 5 ? 'var(--success)' : 'var(--text)'};">${currentRank}${currentRank !== '-' ? 'ìœ„' : ''}</strong></td>
            <td>${n2ChangeHtml}</td>
            <td>${exposureDays}${exposureDays !== '-' ? 'ì¼' : ''}</td>
            <td>${reviewChangeHtml}</td>
          </tr>
        `;
      }).join('');
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    async function updateStatistics() {
      try {
        const res = await fetch('/api/guarantee/statistics');
        const stats = await res.json();

        // í›„ë¶ˆ ì§„í–‰ê±´ ìˆ˜ ê³„ì‚°
        let postpaidCount = 0;
        allData.forEach(item => {
          if (item.status === 'í›„ë¶ˆ') postpaidCount++;
        });
        document.getElementById('stat-postpaid').textContent = postpaidCount;

      } catch (e) {
        console.error(e);
      }
    }

    // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    async function updateCharts() {
      try {
        const res = await fetch('/api/guarantee/statistics');
        const stats = await res.json();

        // íšŒì‚¬ë³„ ì°¨íŠ¸
        const companyData = stats.by_company[currentCompany] || {};
        renderCompanyChart(companyData);

        // ìƒíƒœë³„ ì°¨íŠ¸
        const statusData = {};
        allData.forEach(item => {
          const status = item.status || 'ê¸°íƒ€';
          statusData[status] = (statusData[status] || 0) + 1;
        });
        renderBarChart('chart-status', statusData);

        // ìƒí’ˆë³„ ì°¨íŠ¸
        const productData = {};
        allData.forEach(item => {
          const product = item.product || 'ê¸°íƒ€';
          productData[product] = (productData[product] || 0) + 1;
        });
        renderBarChart('chart-products', productData);

        // ì›”ë³„ ì°¨íŠ¸ (ì „ì²´ í†µê³„ ì‚¬ìš©)
        renderBarChart('chart-monthly', stats.by_month || {});
      } catch (e) {
        console.error(e);
      }
    }

    function renderCompanyChart(data) {
      const el = document.getElementById('chart-company');
      const total = data.total || 0;
      const active = data.active || 0;
      const completed = data.completed || 0;

      el.innerHTML = `
        <div class="chart-bar-group">
          <div class="chart-label"><span>ì „ì²´</span><span>${total}ê±´</span></div>
          <div class="chart-bar-bg">
            <div class="chart-bar" style="width:${total > 0 ? 100 : 0}%; background:linear-gradient(90deg, #3b82f6, #2563eb);">${total}</div>
          </div>
        </div>
        <div class="chart-bar-group">
          <div class="chart-label"><span>ì§„í–‰ì¤‘(í›„ë¶ˆ í¬í•¨)</span><span>${active}ê±´</span></div>
          <div class="chart-bar-bg">
            <div class="chart-bar" style="width:${total > 0 ? (active / total * 100) : 0}%; background:linear-gradient(90deg, #3b82f6, #2563eb);">${active}</div>
          </div>
        </div>
        <div class="chart-bar-group">
          <div class="chart-label"><span>ì™„ë£Œ</span><span>${completed}ê±´</span></div>
          <div class="chart-bar-bg">
            <div class="chart-bar" style="width:${total > 0 ? (completed / total * 100) : 0}%; background:linear-gradient(90deg, #10b981, #059669);">${completed}</div>
          </div>
        </div>
      `;
    }

    function renderBarChart(elementId, data) {
      const el = document.getElementById(elementId);
      const entries = Object.entries(data).sort((a, b) => b[1] - a[1]).slice(0, 5);
      const maxValue = Math.max(...entries.map(e => typeof e[1] === 'object' ? e[1].total || 0 : e[1]), 1);

      if (entries.length === 0) {
        el.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px;">ë°ì´í„° ì—†ìŒ</div>';
        return;
      }

      el.innerHTML = entries.map(([key, value]) => {
        const val = typeof value === 'object' ? value.total || 0 : value;
        return `
          <div class="chart-bar-group">
            <div class="chart-label"><span>${key}</span><span>${val}ê±´</span></div>
            <div class="chart-bar-bg">
              <div class="chart-bar" style="width:${(val / maxValue * 100)}%;">${val}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ë™ê¸°í™”
    async function syncData() {
      const btn = document.getElementById('btn-sync');
      const btnText = document.getElementById('sync-btn-text');
      btn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span> ë™ê¸°í™” ì¤‘...';

      try {
        const res = await fetch('/api/guarantee/sync', { method: 'POST' });
        const data = await res.json();

        if (res.ok) {
          showToast(data.message || 'ë™ê¸°í™” ì™„ë£Œ');
          loadData();
          updateExposureStatus();
          updateDeadlineStatus();
          updateSyncStatus();
        } else {
          showToast('ë™ê¸°í™” ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (e) {
        showToast('ë™ê¸°í™” ì‹¤íŒ¨');
      } finally {
        btn.disabled = false;
        btnText.textContent = 'ğŸ”„ ë™ê¸°í™”';
      }
    }

    // ì‘ì—…ëŸ‰ ìºì‹œ ê°±ì‹ 
    async function refreshWorkloadCache() {
      const btn = document.getElementById('btn-refresh-workload');
      const btnText = document.getElementById('workload-btn-text');
      const statusEl = document.getElementById('workload-cache-status');

      btn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span> ê°±ì‹  ì¤‘...';
      statusEl.innerHTML = 'âš¡ ì‘ì—…ëŸ‰ ìºì‹œ: ê°±ì‹  ì¤‘... (ì§„í–‰ì¤‘ì¸ ì—…ì²´ë§Œ ì¡°íšŒ)';
      statusEl.style.color = 'rgba(255,200,0,0.9)';

      // ì‹œì‘ ì‹œê°„ ê¸°ë¡
      const startTime = Date.now();

      try {
        const res = await fetch('/api/workload/cache/refresh', { method: 'POST' });
        const data = await res.json();

        // ì†Œìš” ì‹œê°„ ê³„ì‚°
        const elapsedSeconds = Math.round((Date.now() - startTime) / 1000);

        if (res.ok) {
          const businessCount = data.business_count || 0;
          const msg = `${data.message || 'ì‘ì—…ëŸ‰ ìºì‹œ ê°±ì‹  ì™„ë£Œ'} (${elapsedSeconds}ì´ˆ ì†Œìš”)`;
          showToast(msg);
          console.log('ìºì‹œ ê°±ì‹  ê²°ê³¼:', data);
          console.log(`ì†Œìš” ì‹œê°„: ${elapsedSeconds}ì´ˆ`);

          // ì—…ì²´ë³„ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ (ìºì‹œ ìƒíƒœë„ í•¨ê»˜ ì—…ë°ì´íŠ¸)
          await loadBusinessWorkloads();
        } else {
          showToast('ìºì‹œ ê°±ì‹  ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
          statusEl.innerHTML = 'âš¡ ì‘ì—…ëŸ‰ ìºì‹œ: ê°±ì‹  ì‹¤íŒ¨';
          statusEl.style.color = 'rgba(255,100,100,0.9)';
        }
      } catch (e) {
        console.error('ìºì‹œ ê°±ì‹  ì˜¤ë¥˜:', e);
        showToast('ìºì‹œ ê°±ì‹  ì‹¤íŒ¨');
        statusEl.innerHTML = 'âš¡ ì‘ì—…ëŸ‰ ìºì‹œ: ê°±ì‹  ì‹¤íŒ¨';
        statusEl.style.color = 'rgba(255,100,100,0.9)';
      } finally {
        btn.disabled = false;
        btnText.textContent = 'âš¡ ì‘ì—…ëŸ‰ ê°±ì‹ ';
      }
    }

    async function updateSyncStatus() {
      try {
        const res = await fetch('/api/guarantee/sync-status');
        const data = await res.json();

        if (data.last_sync) {
          const date = new Date(data.last_sync);
          const dateStr = date.toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          });
          document.getElementById('sync-status').textContent =
            `ë§ˆì§€ë§‰ ë™ê¸°í™”: ${dateStr}`;
        }

        if (data.next_sync_kst) {
          // KST ì œê±°
          const nextSyncStr = data.next_sync_kst.replace(' KST', '');
          document.getElementById('next-sync').textContent = `ë‹¤ìŒ: ${nextSyncStr}`;
        }
      } catch (e) {
        console.error(e);
      }
    }

    // í¼ ì œì¶œ
    document.getElementById('guarantee-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);

      try {
        const url = currentEditId
          ? `/api/guarantee/items/${currentEditId}`
          : '/api/guarantee/items';
        const method = currentEditId ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          showToast(currentEditId ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
          closeModal();
          loadData();
          updateExposureStatus();
          updateDeadlineStatus();
        }
      } catch (e) {
        showToast('ì €ì¥ ì‹¤íŒ¨');
      }
    });

    // ìˆœìœ„ í¬ë¡¤ë§
    async function crawlRanks() {
      const btn = document.getElementById('btn-crawl-ranks');
      const btnText = document.getElementById('rank-btn-text');
      btn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span> í¬ë¡¤ë§ ì¤‘...';

      try {
        const res = await fetch(`/api/guarantee/crawl-ranks?company=${encodeURIComponent(currentCompany)}`, {
          method: 'POST'
        });
        const data = await res.json();

        if (res.ok) {
          showToast(data.message || 'ìˆœìœ„ í¬ë¡¤ë§ ì™„ë£Œ');
          // ìˆœìœ„ ë°ì´í„° ì¬ë¡œë“œ
          await loadLatestRanks();
          renderTable(allData);  // í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§
          updateExposureStatus();  // ë…¸ì¶œ í˜„í™©ë„ ì—…ë°ì´íŠ¸
          // ë§ˆì§€ë§‰ ì§‘ê³„ ì‹œê°„ ì—…ë°ì´íŠ¸
          updateLastCrawlTime();
        } else {
          showToast('í¬ë¡¤ë§ ì‹¤íŒ¨: ' + (data.error || data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (e) {
        console.error('Crawling error:', e);
        showToast('í¬ë¡¤ë§ ì‹¤íŒ¨');
      } finally {
        btn.disabled = false;
        btnText.textContent = 'ğŸ† ìˆœìœ„ ê°±ì‹ ';
      }
    }

    // ë§ˆì§€ë§‰ ì§‘ê³„ ì‹œê°„ í‘œì‹œ
    function updateLastCrawlTime() {
      const el = document.getElementById('last-crawl-time');
      if (!el) return;

      if (lastCollectedAt) {
        try {
          const date = new Date(lastCollectedAt);
          const formatted = date.toLocaleString('ko-KR', {
            month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
          });
          el.textContent = `ğŸ“… ë§ˆì§€ë§‰ ì§‘ê³„: ${formatted}`;
        } catch (e) {
          el.textContent = '';
        }
      }
    }

    // ë³µì‚¬ ë²„íŠ¼ í•¨ìˆ˜
    function copyWorkloadToClipboard() {
      if (!currentWorkloadData || !currentWorkloadData.weeks || currentWorkloadData.weeks.length === 0) {
        showToast('ë³µì‚¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }

      // í…ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      const lines = [];

      // í—¤ë” (ì›”ë³´ì¥, ë³´ì¥ ìˆœìœ„, ëŒ€í–‰ì‚¬)
      if (currentWorkloadData.business_name) {
        let rank = '';
        if (currentWorkloadData.guarantee_rank) {
          const rankStr = String(currentWorkloadData.guarantee_rank);
          // "ìœ„"ê°€ ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ, ì—†ìœ¼ë©´ ì¶”ê°€
          rank = rankStr.includes('ìœ„') ? `(${rankStr})` : `(${rankStr}ìœ„)`;
        }
        lines.push(`ì›”ë³´ì¥ ${rank}`);

        const agency = currentWorkloadData.agency || 'íë¦„';
        lines.push(agency);
        lines.push('');  // ëŒ€í–‰ì‚¬ëª…ê³¼ ì‘ì—…ëŸ‰ ì‚¬ì´ì—ë§Œ ë¹ˆ ì¤„
      }

      // ê¸°ê°„ë³„ ì‘ì—…ëŸ‰
      currentWorkloadData.weeks.forEach((week, idx) => {
        // ì‹œì‘ì¼ì´ ì—†ìœ¼ë©´ "~ ë§ˆê°ì¼" í˜•ì‹ìœ¼ë¡œ
        const dateRange = week.start_date
          ? `${week.start_date} ~ ${week.end_date}`
          : `~ ${week.end_date}`;
        lines.push(dateRange);

        week.items.forEach(item => {
          lines.push(`${item.name} : ${item.workload}`);
        });

        // ë§ˆì§€ë§‰ ê¸°ê°„ì´ ì•„ë‹ˆë©´ ë¹ˆ ì¤„ ì¶”ê°€
        if (idx < currentWorkloadData.weeks.length - 1) {
          lines.push('');
        }
      });

      const text = lines.join('\n').trim();

      console.log('ë³µì‚¬í•  í…ìŠ¤íŠ¸:', text);

      // í´ë¦½ë³´ë“œì— ë³µì‚¬
      navigator.clipboard.writeText(text).then(() => {
        showToast('ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
      }).catch(err => {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        showToast('ë³µì‚¬ ì‹¤íŒ¨');
      });
    }

    // ì‘ì—…ëŸ‰ ë°ì´í„° ë Œë”ë§
    function renderWorkloadData(data) {
      const content = document.getElementById('workload-content');
      const copyBtn = document.getElementById('btn-copy-workload');

      // í˜„ì¬ ë°ì´í„° ì €ì¥ (ë³µì‚¬ìš©)
      currentWorkloadData = data;

      if (!data.weeks || data.weeks.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <div class="empty-title">ì‘ì—… ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤</div>
            <div class="empty-desc">ìµœê·¼ 4ì£¼ê°„ ì§„í–‰ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤</div>
          </div>
        `;
        currentWorkloadData = null;
        if (copyBtn) copyBtn.style.display = 'none';
        return;
      }

      // í—¤ë” ìƒì„± (ì›”ë³´ì¥, ë³´ì¥ ìˆœìœ„, ëŒ€í–‰ì‚¬)
      let headerHtml = '';
      if (data.business_name) {
        let rank = '';
        if (data.guarantee_rank) {
          const rankStr = String(data.guarantee_rank);
          // "ìœ„"ê°€ ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ, ì—†ìœ¼ë©´ ì¶”ê°€
          rank = rankStr.includes('ìœ„') ? `(${rankStr})` : `(${rankStr}ìœ„)`;
        }
        const agency = data.agency || 'íë¦„';

        headerHtml = `
          <div style="margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid var(--border);">
            <div style="font-weight:700; font-size:15px; color:var(--primary);">
              ì›”ë³´ì¥ ${rank}
            </div>
            <div style="color:var(--text); font-size:14px; font-weight:500; margin-top:2px;">
              ${agency}
            </div>
          </div>
        `;
      }

      // ìŠ¤ì¼€ì¤„ ë Œë”ë§ (ê°™ì€ ê¸°ê°„ì˜ ì‘ì—…ë“¤ì„ í•¨ê»˜ í‘œì‹œ)
      const weeksHtml = data.weeks.map(week => {
        const itemsText = week.items.map(item =>
          `<div style="padding-left:0; color:var(--text);">${item.name} : ${item.workload}</div>`
        ).join('');

        // ì‹œì‘ì¼ì´ ì—†ìœ¼ë©´ "~ ë§ˆê°ì¼" í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
        const dateRange = week.start_date
          ? `${week.start_date} ~ ${week.end_date}`
          : `~ ${week.end_date}`;

        return `
          <div style="margin-bottom:16px;">
            <div style="font-weight:700; font-size:14px; color:var(--text); margin-bottom:6px;">
              ${dateRange}
            </div>
            ${itemsText}
          </div>
        `;
      }).join('');

      content.innerHTML = headerHtml + weeksHtml;

      // ë³µì‚¬ ë²„íŠ¼ í‘œì‹œ
      if (copyBtn) copyBtn.style.display = 'inline-flex';

      console.log(`ğŸ“Š ë Œë”ë§: ${data.weeks.length}ê°œ ê¸°ê°„, ì´ ${data.weeks.reduce((sum, w) => sum + w.items.length, 0)}ê°œ ì‘ì—…`);

      // ë””ë²„ê¹…: ì²˜ìŒ ëª‡ ê°œ ì¶œë ¥
      data.weeks.slice(0, 3).forEach((week, idx) => {
        console.log(`  [${idx + 1}] ${week.start_date} ~ ${week.end_date}: ${week.items.map(i => i.name).join(', ')}`);
      });
    }

    // ì‘ì—…ëŸ‰ ìŠ¤ì¼€ì¤„ ëª¨ë‹¬
    async function showWorkload(company, businessName = null) {
      const modal = document.getElementById('workload-modal');
      const content = document.getElementById('workload-content');

      // ëª¨ë‹¬ í‘œì‹œ
      modal.classList.add('show');

      // ëª¨ë‹¬ ì œëª© ì—…ë°ì´íŠ¸
      const modalTitle = modal.querySelector('.modal-title');
      if (businessName) {
        modalTitle.textContent = `ğŸ“Š ${businessName}`;
      } else {
        modalTitle.textContent = `ğŸ“Š ì‘ì—…ëŸ‰ ìŠ¤ì¼€ì¤„`;
      }

      // ì—…ì²´ë³„ ì¡°íšŒ: ìºì‹œë§Œ ì‚¬ìš©
      if (businessName) {
        if (businessWorkloadCache[businessName]) {
          console.log(`âœ… Using cached data for ${businessName} (instant load!)`);
          renderWorkloadData(businessWorkloadCache[businessName]);
          return;
        } else {
          // ìºì‹œê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€
          console.log(`âš ï¸ No cache for ${businessName}`);
          console.log('Available businesses in cache:', Object.keys(businessWorkloadCache));

          // ë³µì‚¬ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
          const copyBtn = document.getElementById('btn-copy-workload');
          if (copyBtn) copyBtn.style.display = 'none';

          content.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">â±ï¸</div>
              <div class="empty-title">ìºì‹œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
              <div class="empty-desc" style="margin-bottom:16px;">
                ìƒë‹¨ì˜ <strong style="color:var(--success);">'âš¡ ì‘ì—…ëŸ‰ ê°±ì‹ '</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬<br>
                ì—…ì²´ë³„ ì‘ì—…ëŸ‰ì„ ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
              </div>
              <button class="btn btn-success" onclick="closeWorkloadModal(); document.getElementById('btn-refresh-workload').click();">
                âš¡ ì§€ê¸ˆ ê°±ì‹ í•˜ê¸°
              </button>
            </div>
          `;
          return;
        }
      }

      // íšŒì‚¬ ì „ì²´ ì¡°íšŒ: API í˜¸ì¶œ
      content.innerHTML = `
        <div style="text-align:center; padding:40px; color:var(--muted);">
          <div class="loading" style="margin:0 auto 16px;"></div>
          <div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      `;

      try {
        const url = `/api/workload/schedule?company=${encodeURIComponent(company)}`;
        const res = await fetch(url);
        const data = await res.json();

        renderWorkloadData(data);
      } catch (e) {
        console.error('Workload schedule error:', e);
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âš ï¸</div>
            <div class="empty-title">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>
            <div class="empty-desc">${e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'}</div>
          </div>
        `;
      }
    }

    function closeWorkloadModal() {
      document.getElementById('workload-modal').classList.remove('show');
    }

    window.showWorkload = showWorkload;

    // ê²€ìƒ‰
    document.getElementById('btn-search').addEventListener('click', async () => {
      const query = document.getElementById('search-input').value.trim();
      if (!query) return loadData();

      try {
        const res = await fetch(`/api/guarantee/search?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        // í˜„ì¬ íšŒì‚¬ í•„í„° ì ìš©
        const filtered = data.items.filter(item => item.company === currentCompany);
        renderTable(filtered);
      } catch (e) {
        showToast('ê²€ìƒ‰ ì‹¤íŒ¨');
      }
    });

    // ì´ˆê¸°í™”
    document.getElementById('btn-reset').addEventListener('click', () => {
      document.getElementById('filter-status').value = '';
      document.getElementById('filter-product').value = '';
      document.getElementById('search-input').value = '';
      loadData();
    });

    // ì •ë ¬ í—¤ë” í´ë¦­ ì´ë²¤íŠ¸
    document.querySelectorAll('th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const field = th.dataset.sort;

        // ê°™ì€ í•„ë“œ í´ë¦­ ì‹œ: ë°©í–¥ í† ê¸€
        if (currentSort.field === field) {
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          // ë‹¤ë¥¸ í•„ë“œ í´ë¦­ ì‹œ: ìƒˆ í•„ë“œë¡œ ë³€ê²½, ê¸°ë³¸ ì˜¤ë¦„ì°¨ìˆœ
          currentSort.field = field;
          currentSort.direction = 'asc';
        }

        // í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§
        renderTable(allData);

        // Toastë¡œ ì •ë ¬ ìƒíƒœ ì•ˆë‚´
        const fieldName = {
          'agency': 'ëŒ€í–‰ì‚¬ëª…',
          'business_name': 'ìƒí˜¸ëª…',
          'product': 'ìƒí’ˆ',
          'status': 'ìƒíƒœ',
          'contract_date': 'ê³„ì•½ì¼',
          'work_start_date': 'ì‘ì—…ì‹œì‘ì¼'
        }[field] || field;
        const directionName = currentSort.direction === 'asc' ? 'ì˜¤ë¦„ì°¨ìˆœ' : 'ë‚´ë¦¼ì°¨ìˆœ';
        showToast(`${fieldName} ${directionName} ì •ë ¬`);
      });
    });

    // ì´ë²¤íŠ¸
    document.getElementById('btn-sync').addEventListener('click', syncData);
    document.getElementById('btn-refresh-workload').addEventListener('click', refreshWorkloadCache);
    document.getElementById('btn-crawl-ranks').addEventListener('click', crawlRanks);
    document.getElementById('btn-add').addEventListener('click', () => openModal());
    document.getElementById('filter-status').addEventListener('change', loadData);
    document.getElementById('filter-product').addEventListener('change', loadData);
    document.getElementById('search-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('btn-search').click();
    });

    // ìŠ¤í¬ë¡¤ ë²„íŠ¼ í•¨ìˆ˜
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    function scrollToBottom() {
      window.scrollTo({
        top: document.documentElement.scrollHeight,
        behavior: 'smooth'
      });
    }

    // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ (ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€)
    function updateScrollButtons() {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const scrollHeight = document.documentElement.scrollHeight;
      const clientHeight = document.documentElement.clientHeight;
      const scrollBottom = scrollHeight - scrollTop - clientHeight;

      const btnTop = document.getElementById('scroll-top');
      const btnBottom = document.getElementById('scroll-bottom');

      // ìœ„ë¡œ ë²„íŠ¼: 100px ì´ìƒ ìŠ¤í¬ë¡¤ ì‹œ í‘œì‹œ
      if (scrollTop > 100) {
        btnTop.classList.add('show');
      } else {
        btnTop.classList.remove('show');
      }

      // ì•„ë˜ë¡œ ë²„íŠ¼: í•˜ë‹¨ì—ì„œ 100px ì´ìƒ ë–¨ì–´ì ¸ ìˆì„ ë•Œ í‘œì‹œ
      if (scrollBottom > 100) {
        btnBottom.classList.add('show');
      } else {
        btnBottom.classList.remove('show');
      }
    }

    // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    window.addEventListener('scroll', updateScrollButtons);
    window.addEventListener('resize', updateScrollButtons);

    // === ë ˆì‹œí”¼ ë¶„ì„ í•¨ìˆ˜ ===
    let recipeAnalysisData = null;

    async function loadRecipeAnalysis() {
      try {
        const response = await fetch('/api/recipe-analysis?weeks=3');
        if (!response.ok) throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');

        const rawData = await response.json();

        // í˜„ì¬ ì„ íƒëœ íšŒì‚¬ë¡œ í•„í„°ë§
        const filteredBusinesses = (rawData.businesses || []).filter(
          biz => (biz.company || '') === currentCompany
        );

        // í•„í„°ë§ëœ ë°ì´í„°ë¥¼ recipeAnalysisDataì— ì €ì¥
        recipeAnalysisData = {
          ...rawData,
          businesses: filteredBusinesses
        };

        // N2 í†µê³„ ê³„ì‚° (í•„í„°ë§ëœ ì—…ì²´ ê¸°ì¤€)
        const generalBusinesses = filteredBusinesses.filter(b => !b.is_restaurant);
        const restaurantBusinesses = filteredBusinesses.filter(b => b.is_restaurant);

        // ì¼ë°˜ í‚¤ì›Œë“œ N2 í‰ê·  ë³€í™”
        const generalChanges = generalBusinesses
          .map(b => b.n2_analysis?.delta)
          .filter(d => d !== null && d !== undefined);
        const generalAvg = generalChanges.length > 0
          ? generalChanges.reduce((a, b) => a + b, 0) / generalChanges.length
          : 0;

        // ë§›ì§‘ í‚¤ì›Œë“œ N2 í‰ê·  ë³€í™”
        const restaurantChanges = restaurantBusinesses
          .map(b => b.n2_analysis?.delta)
          .filter(d => d !== null && d !== undefined);
        const restaurantAvg = restaurantChanges.length > 0
          ? restaurantChanges.reduce((a, b) => a + b, 0) / restaurantChanges.length
          : 0;

        document.getElementById('general-n2-change').textContent =
          (generalAvg >= 0 ? '+' : '') + generalAvg.toFixed(4);
        document.getElementById('general-count').textContent = generalBusinesses.length;

        document.getElementById('restaurant-n2-change').textContent =
          (restaurantAvg >= 0 ? '+' : '') + restaurantAvg.toFixed(4);
        document.getElementById('restaurant-count').textContent = restaurantBusinesses.length;

        // ì•Œë¦¼ ë Œë”ë§ (í˜„ì¬ íšŒì‚¬ì˜ ì•Œë¦¼ë§Œ)
        const filteredAlerts = (rawData.alerts || []).filter(
          alert => filteredBusinesses.some(b => b.name === alert.business_name)
        );
        renderAlerts(filteredAlerts);

        // í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§ (N2 ë°ì´í„° ë°˜ì˜)
        renderTable(allData);

      } catch (error) {
        console.error('Recipe analysis error:', error);
      }
    }

    function renderAlerts(alerts) {
      const container = document.getElementById('recipe-alerts');
      const list = document.getElementById('recipe-alerts-list');

      if (!alerts.length) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      let html = '';

      alerts.forEach(alert => {
        const icon = alert.level === 'ê²½ê³ ' ? 'ğŸš¨' : 'âš ï¸';
        html += `<div style="padding:8px 0; border-bottom:1px solid var(--border);">
          ${icon} <strong>${alert.business_name}</strong>: ${alert.message}
        </div>`;
      });

      list.innerHTML = html;
    }

    function openDashboardPanel(encodedName) {
      const name = decodeURIComponent(encodedName);
      const panel = document.getElementById('business-dashboard-panel');
      const content = document.getElementById('dashboard-content');

      document.getElementById('dashboard-business-name').textContent = name;

      // ë°ì´í„°ì—ì„œ ì°¾ê¸°
      const biz = recipeAnalysisData?.businesses?.find(b => b.name === name);

      if (!biz) {
        content.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted);">ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
      } else {
        content.innerHTML = renderDashboardContent(biz);
      }

      panel.style.display = 'block';
      setTimeout(() => panel.style.right = '0', 10);
    }

    function closeDashboardPanel() {
      const panel = document.getElementById('business-dashboard-panel');
      panel.style.right = '-500px';
      setTimeout(() => panel.style.display = 'none', 300);
    }

    function renderDashboardContent(biz) {
      const n2 = biz.n2_analysis;
      const review = biz.review_analysis;

      let html = '';

      // í˜„ì¬ ìˆœìœ„
      const currentRank = biz.current_rank;
      const rankSource = biz.rank_source === 'crawled' ? '(í¬ë¡¤ë§)' : '(ì‹œíŠ¸)';
      const rankDisplay = currentRank ? `${currentRank}ìœ„ ${rankSource}` : 'ìˆœìœ„ ì—†ìŒ';

      html += `<div class="card" style="margin-bottom:16px; border-left:4px solid var(--primary);">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div style="font-size:13px; color:var(--muted);">ğŸ† í˜„ì¬ ìˆœìœ„</div>
            <div style="font-size:28px; font-weight:700; color:var(--primary);">${rankDisplay}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:13px; color:var(--muted);">ë³´ì¥ìˆœìœ„</div>
            <div style="font-size:20px; font-weight:600;">${biz.guarantee_rank || '-'}ìœ„</div>
          </div>
        </div>
      </div>`;

      // ê¸°ë³¸ ì •ë³´
      html += `<div class="card" style="margin-bottom:16px;">
        <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">ğŸ“ ê¸°ë³¸ ì •ë³´</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px;">
          <div>í‚¤ì›Œë“œ: <strong>${biz.keyword || '-'}</strong></div>
          <div>ìœ í˜•: <strong>${biz.is_restaurant ? 'ë§›ì§‘' : 'ì¼ë°˜'}</strong></div>
          <div>ìƒíƒœ: <strong>${biz.status || '-'}</strong></div>
          <div>ë…¸ì¶œì¼ìˆ˜: <strong>${biz.exposure_days || 0}ì¼</strong></div>
          <div>ëŒ€í–‰ì‚¬: <strong>${biz.agency || '-'}</strong></div>
          <div>íšŒì‚¬: <strong>${biz.company || '-'}</strong></div>
        </div>
      </div>`;

      // ì‘ì—…ëŸ‰ ë²„íŠ¼
      html += `<div class="card" style="margin-bottom:16px;">
        <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">ğŸ“‹ ì‘ì—…ëŸ‰</div>
        <button class="btn btn-primary" style="width:100%;" onclick="showBusinessWorkload('${encodeURIComponent(biz.company || 'ì œì´íˆ¬ë©')}', '${encodeURIComponent(biz.name)}')">
          ğŸ” ì‘ì—…ëŸ‰ ìƒì„¸ë³´ê¸°
        </button>
      </div>`;

      // N2 ë¶„ì„
      if (n2) {
        const n2Color = n2.delta >= 0 ? 'var(--success)' : 'var(--danger)';
        html += `<div class="card" style="margin-bottom:16px;">
          <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">ğŸ“ˆ N2 ì ìˆ˜ ë³€í™” (${n2.day_used}ì¼ì§¸ ê¸°ì¤€)</div>
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <span style="font-size:16px;">${n2.start_n2?.toFixed(4) || '-'}</span>
              <span style="margin:0 8px;">â†’</span>
              <span style="font-size:16px;">${n2.end_n2?.toFixed(4) || '-'}</span>
            </div>
            <div style="font-size:24px; font-weight:700; color:${n2Color};">
              ${n2.delta >= 0 ? '+' : ''}${n2.delta?.toFixed(4) || '-'}
            </div>
          </div>
        </div>`;
      }

      // ë¦¬ë·° ë¶„ì„
      if (review) {
        const reviewColor = review.delta >= 0 ? 'var(--success)' : 'var(--danger)';
        html += `<div class="card" style="margin-bottom:16px;">
          <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">ğŸ’¬ ë¦¬ë·° ë³€í™”</div>
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <span style="font-size:16px;">${review.start_reviews}</span>
              <span style="margin:0 8px;">â†’</span>
              <span style="font-size:16px;">${review.end_reviews}</span>
            </div>
            <div style="font-size:18px; font-weight:700; color:${reviewColor};">
              ${review.delta >= 0 ? '+' : ''}${review.delta} (${review.change_rate >= 0 ? '+' : ''}${review.change_rate}%)
            </div>
          </div>
          ${review.warning ? `<div style="margin-top:8px; padding:8px; background:rgba(239,68,68,0.1); border-radius:6px; color:var(--danger); font-size:12px;">
            âš ï¸ ë¦¬ë·° ê°ì†Œ ${review.warning}
          </div>` : ''}
        </div>`;
      }

      return html;
    }

    // í…Œì´ë¸” í–‰ í´ë¦­ ì‹œ ìŠ¬ë¼ì´ë“œ íŒ¨ë„ ì—´ê¸°
    function openBusinessSlidePanel(encodedName, itemId) {
      const name = decodeURIComponent(encodedName);
      const panel = document.getElementById('business-dashboard-panel');
      const content = document.getElementById('dashboard-content');

      document.getElementById('dashboard-business-name').textContent = name;

      // ë³´ì¥ê±´ ë°ì´í„°ì—ì„œ ì°¾ê¸°
      const guaranteeItem = allData.find(item => item.business_name === name);
      // ë ˆì‹œí”¼ ë¶„ì„ ë°ì´í„°ì—ì„œ ì°¾ê¸°
      const recipeData = recipeAnalysisData?.businesses?.find(b => b.name === name);

      // ë‘ ë°ì´í„°ë¥¼ í•©ì³ì„œ íŒ¨ë„ ë‚´ìš© ìƒì„±
      content.innerHTML = renderCombinedDashboardContent(guaranteeItem, recipeData);

      panel.style.display = 'block';
      setTimeout(() => panel.style.right = '0', 10);
    }

    // í†µí•© ëŒ€ì‹œë³´ë“œ ë‚´ìš© ë Œë”ë§
    function renderCombinedDashboardContent(guaranteeItem, recipeData) {
      let html = '';

      const biz = recipeData || {};
      const item = guaranteeItem || {};
      const businessName = biz.name || item.business_name || '';
      const company = biz.company || item.company || currentCompany;

      // í˜„ì¬ ìˆœìœ„
      let currentRank = biz.current_rank;
      let rankSource = biz.rank_source === 'crawled' ? '(í¬ë¡¤ë§)' : '(ì‹œíŠ¸)';

      if (!currentRank && latestRanks[businessName]) {
        currentRank = latestRanks[businessName].rank;
        rankSource = '(í¬ë¡¤ë§)';
      }

      const rankDisplay = currentRank ? `${currentRank}ìœ„ ${rankSource}` : 'ìˆœìœ„ ì—†ìŒ';
      const guaranteeRank = biz.guarantee_rank || item.guarantee_rank || '-';

      html += `<div class="card" style="margin-bottom:16px; border-left:4px solid var(--primary);">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div style="font-size:13px; color:var(--muted);">ğŸ† í˜„ì¬ ìˆœìœ„</div>
            <div style="font-size:28px; font-weight:700; color:var(--primary);">${rankDisplay}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:13px; color:var(--muted);">ë³´ì¥ìˆœìœ„</div>
            <div style="font-size:20px; font-weight:600;">${guaranteeRank}${guaranteeRank !== '-' ? 'ìœ„' : ''}</div>
          </div>
        </div>
      </div>`;

      // ì§„í–‰ ì •ë³´
      const exposureDays = biz.exposure_days || item.exposure_days || 0;
      html += `<div class="card" style="margin-bottom:16px; border-left:4px solid var(--warning);">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div style="font-size:13px; color:var(--muted);">ğŸ“… ì´ ì§„í–‰ì¼</div>
            <div style="font-size:28px; font-weight:700; color:var(--warning);">${exposureDays}ì¼</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:13px; color:var(--muted);">ìƒíƒœ</div>
            <div style="font-size:16px; font-weight:600;">${item.status || biz.status || '-'}</div>
          </div>
        </div>
      </div>`;

      // ê¸°ë³¸ ì •ë³´
      html += `<div class="card" style="margin-bottom:16px;">
        <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">ğŸ“ ê¸°ë³¸ ì •ë³´</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px;">
          <div>í‚¤ì›Œë“œ: <strong>${item.main_keyword || biz.keyword || '-'}</strong></div>
          <div>ìœ í˜•: <strong>${biz.is_restaurant ? 'ë§›ì§‘' : (item.product || 'ì¼ë°˜')}</strong></div>
          <div>ê³„ì•½ì¼: <strong>${item.contract_date || '-'}</strong></div>
          <div>ì‘ì—…ì‹œì‘: <strong>${item.work_start_date || '-'}</strong></div>
          <div>ëŒ€í–‰ì‚¬: <strong>${item.agency || biz.agency || '-'}</strong></div>
          <div>íšŒì‚¬: <strong>${company}</strong></div>
        </div>
      </div>`;

      // ì‘ì—…ëŸ‰ ë²„íŠ¼
      html += `<div class="card" style="margin-bottom:16px;">
        <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">ğŸ“‹ ì‘ì—…ëŸ‰</div>
        <button class="btn btn-primary" style="width:100%;" onclick="showWorkload('${company}', '${businessName}')">
          ğŸ” ì‘ì—…ëŸ‰ ìƒì„¸ë³´ê¸°
        </button>
      </div>`;

      // N2 ë¶„ì„
      const n2 = biz.n2_analysis;
      if (n2) {
        const n2Color = n2.delta >= 0 ? 'var(--success)' : 'var(--danger)';
        html += `<div class="card" style="margin-bottom:16px;">
          <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">ğŸ“ˆ N2 ì ìˆ˜ ë³€í™” (${n2.day_used || '-'}ì¼ì§¸ ê¸°ì¤€)</div>
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <span style="font-size:16px;">${n2.start_n2?.toFixed(4) || '-'}</span>
              <span style="margin:0 8px;">â†’</span>
              <span style="font-size:16px;">${n2.end_n2?.toFixed(4) || '-'}</span>
            </div>
            <div style="font-size:24px; font-weight:700; color:${n2Color};">
              ${n2.delta >= 0 ? '+' : ''}${n2.delta?.toFixed(4) || '-'}
            </div>
          </div>
        </div>`;
      }

      // ë¦¬ë·° ë¶„ì„
      const review = biz.review_analysis;
      if (review) {
        const reviewColor = review.delta >= 0 ? 'var(--success)' : 'var(--danger)';
        html += `<div class="card" style="margin-bottom:16px;">
          <div style="font-size:13px; color:var(--muted); margin-bottom:8px;">ğŸ’¬ ë¦¬ë·° ë³€í™”</div>
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <span style="font-size:16px;">${review.start_reviews}</span>
              <span style="margin:0 8px;">â†’</span>
              <span style="font-size:16px;">${review.end_reviews}</span>
            </div>
            <div style="font-size:18px; font-weight:700; color:${reviewColor};">
              ${review.delta >= 0 ? '+' : ''}${review.delta} (${review.change_rate >= 0 ? '+' : ''}${review.change_rate}%)
            </div>
          </div>
          ${review.warning ? `<div style="margin-top:8px; padding:8px; background:rgba(239,68,68,0.1); border-radius:6px; color:var(--danger); font-size:12px;">
            âš ï¸ ë¦¬ë·° ê°ì†Œ ${review.warning}
          </div>` : ''}
        </div>`;
      }

      return html;
    }

    // ì—…ì²´ë³„ ì‘ì—…ëŸ‰ ìƒì„¸ ë³´ê¸°
    function showBusinessWorkload(encodedCompany, encodedName) {
      const company = decodeURIComponent(encodedCompany);
      const name = decodeURIComponent(encodedName);

      // showWorkload í•¨ìˆ˜ í˜¸ì¶œ
      showWorkload(company, name);
    }

    // ì´ˆê¸° ë¡œë“œ
    loadData();
    updateExposureStatus();
    updateDeadlineStatus();
    updateSyncStatus();
    loadBusinessWorkloads();  // ì—…ì²´ë³„ ì‘ì—…ëŸ‰ ë¯¸ë¦¬ ë¡œë“œ
    updateScrollButtons();  // ìŠ¤í¬ë¡¤ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
    loadRecipeAnalysis();  // ë ˆì‹œí”¼ ë¶„ì„ ë¡œë“œ
  </script>
</body>

</html>