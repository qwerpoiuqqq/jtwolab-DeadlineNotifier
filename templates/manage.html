<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>내부 보장건 관리</title>
    <style>
      :root{ --bg:#ffffff; --text:#1f2328; --muted:#6b778c; --line:#e5e7eb; --panel:#ffffff; --pill:#f6f8fa; --btn:#111827; }
      html,body{ height:100% }
      body{ margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, "Noto Sans KR", Arial; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
      .container{ max-width:980px; margin:0 auto; padding:24px; }
      .title{ font-weight:800; letter-spacing:.2px; font-size:18px; margin-bottom:16px; }
      .home-link{ color:inherit; text-decoration:none; }
      .home-link:hover{ text-decoration:underline; }
      .nav{ display:flex; gap:8px; margin-bottom:12px; }
      .btn{ border:1px solid var(--line); background:#fff; color:#111827; padding:10px 14px; border-radius:10px; cursor:pointer; }
      .btn-primary{ background:#111827; color:#fff; border-color:#111827; }
      .panel{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:16px; }
      .stack{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      input[type="text"]{ background:#fff; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px; min-width:220px; outline:none; }
      .muted{ color:var(--muted); }
      table{ width:100%; border-collapse: collapse; }
      th, td{ border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; }
      th{ font-size:12px; color:var(--muted); font-weight:600; }
      .badge{ display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:var(--pill); font-size:12px; }
      .right{ margin-left:auto; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="title"><a class="home-link" href="/">마감 안내 생성기</a> · <span class="muted">내부 보장건</span></div>

      <div class="panel" style="margin-bottom:12px">
        <div class="stack">
          <div class="nav">
            <a class="btn" href="/">마감 안내</a>
            <a class="btn btn-primary" href="/manage">보장 관리</a>
          </div>
          <div class="right stack">
            <span class="muted">마지막 업데이트:</span>
            <span id="last-updated" class="badge">{{ updated_at or '없음' }}</span>
            <button id="refresh" class="btn">작업 불러오기</button>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-bottom:12px">
        <div class="stack" style="align-items:flex-end">
          <div>
            <label class="muted" style="display:block; font-size:12px; margin-bottom:6px">날짜 선택 (해당 날짜 기준 잔여일 재계산)</label>
            <input id="q-date" type="date" />
          </div>
          <div>
            <label class="muted" style="display:block; font-size:12px; margin-bottom:6px">상호명</label>
            <input id="q-biz" type="text" placeholder="상호명 검색" list="dl-biz" />
            <datalist id="dl-biz"></datalist>
          </div>
          <div>
            <label class="muted" style="display:block; font-size:12px; margin-bottom:6px">대행사명</label>
            <input id="q-agency" type="text" placeholder="대행사명 검색" list="dl-agency" />
            <datalist id="dl-agency"></datalist>
          </div>
          <span class="muted">(둘 중 하나만 입력)</span>
        </div>
      </div>

      <div class="panel" style="margin-bottom:12px">
        <div class="muted" style="margin-bottom:8px">총 <span id="count">0</span>건</div>
        <div style="overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th>대행사</th>
                <th>상호명</th>
                <th>작업명</th>
                <th>마감 잔여일</th>
                <th>일작업량</th>
                <th>체크</th>
                <th>탭</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </div>

    <div class="panel" id="toast" style="display:none; position:fixed; right:16px; bottom:16px; background:#111827; color:#fff; border:1px solid #111827; padding:10px 12px; border-radius:10px;">완료</div>

    <script>
      const initialItems = {{ (initial_items or []) | tojson | safe }};
      const initialUpdatedAt = {{ (updated_at or 'null') | tojson | safe }};
      const $ = (sel)=>document.querySelector(sel);
      function toast(msg){ const t=$('#toast'); if(!t) return; t.textContent=msg||'완료'; t.style.display='block'; setTimeout(()=>t.style.display='none', 1200); }

      function norm(s){ return (s||'').toString().trim().toLowerCase(); }
      let allItems = Array.isArray(initialItems) ? initialItems : [];
      let lastUpdatedAt = typeof initialUpdatedAt==='string' ? initialUpdatedAt : null;

      function toKSTString(iso){
        try{
          const d = new Date(iso);
          // KST 포맷
          return d.toLocaleString('ko-KR', { timeZone: 'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }).replaceAll('.', '-').replace(' ', ' ').replace(/\.$/, '') + ' KST';
        }catch(e){ return iso||''; }
      }
      function setUpdatedBadge(){
        const el = document.getElementById('last-updated');
        if(!el) return;
        el.textContent = lastUpdatedAt ? toKSTString(lastUpdatedAt) : '없음';
      }

      function ymd(date){ const y=date.getFullYear(); const m=String(date.getMonth()+1).padStart(2,'0'); const d=String(date.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }
      function parseYMD(str){ const [y,m,d]=(str||'').split('-').map(v=>parseInt(v,10)); if(!y||!m||!d) return null; return new Date(Date.UTC(y, m-1, d)); }
      function toUTCDateOnly(iso){ try{ const d=new Date(iso); return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())); }catch(e){ return null; } }
      function daysBetween(aUTCDateOnly, bUTCDateOnly){ if(!aUTCDateOnly||!bUTCDateOnly) return 0; const ms= aUTCDateOnly.getTime()-bUTCDateOnly.getTime(); return Math.round(ms/86400000); }

      function buildSuggestions(){
        const dlBiz = document.getElementById('dl-biz');
        const dlAgency = document.getElementById('dl-agency');
        if(!dlBiz || !dlAgency) return;
        const bizSet = new Set();
        const agencySet = new Set();
        for(const it of allItems){ if(it.bizname) bizSet.add(it.bizname.trim()); if(it.agency) agencySet.add(it.agency.trim()); }
        const bizArr = Array.from(bizSet).sort((a,b)=>a.localeCompare(b,'ko')); 
        const agencyArr = Array.from(agencySet).sort((a,b)=>a.localeCompare(b,'ko'));
        dlBiz.innerHTML = bizArr.map(v=>`<option value="${v}"></option>`).join('');
        dlAgency.innerHTML = agencyArr.map(v=>`<option value="${v}"></option>`).join('');
      }

      function render(items){
        const tb = document.querySelector('#tbl tbody');
        tb.innerHTML = '';
        for(const it of items){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${it.agency||''}</td>
            <td>${it.bizname||''}</td>
            <td>${it.task_display||''}</td>
            <td>${(it._effective_remain??'')!==''? it._effective_remain: ''}</td>
            <td>${it.daily_workload||''}</td>
            <td>${it.checked? '✓' : ''}</td>
            <td>${it.tab_title||''}</td>
          `;
          tb.appendChild(tr);
        }
        document.getElementById('count').textContent = items.length.toString();
      }

      function applyFilter(){
        const qb = norm(document.getElementById('q-biz').value);
        const qa = norm(document.getElementById('q-agency').value);
        const dateStr = document.getElementById('q-date').value;
        const userDate = parseYMD(dateStr);
        const snapshotDate = toUTCDateOnly(lastUpdatedAt || new Date().toISOString());
        const userDateUTC = userDate ? userDate : toUTCDateOnly(new Date().toISOString());
        const delta = daysBetween(userDateUTC, snapshotDate); // 사용자날짜 - 스냅샷날짜

        let list = allItems.map(it=>{
          const r = (typeof it.remain_days === 'number') ? (it.remain_days - delta) : null;
          return Object.assign({}, it, { _effective_remain: r });
        });

        // 날짜 기준: 해당 날짜에 구동 중인 항목만 (잔여일>=0)
        list = list.filter(it=> it._effective_remain === null ? false : (it._effective_remain >= 0));

        if(qb && qa){
          list = list.filter(it=> norm(it.bizname).includes(qb) && norm(it.agency).includes(qa));
        }else if(qb){
          list = list.filter(it=> norm(it.bizname).includes(qb));
        }else if(qa){
          list = list.filter(it=> norm(it.agency).includes(qa));
        }
        render(list);
      }

      document.getElementById('q-biz').addEventListener('input', applyFilter);
      document.getElementById('q-agency').addEventListener('input', applyFilter);
      document.getElementById('q-date').addEventListener('change', applyFilter);

      document.getElementById('refresh').addEventListener('click', async()=>{
        const btn = document.getElementById('refresh');
        btn.disabled = true; btn.textContent = '불러오는 중...';
        try{
          const res = await fetch('/api/internal/refresh', { method: 'POST' });
          const data = await res.json().catch(()=>({}));
          if(!res.ok){ throw new Error(data?.error||'갱신 실패'); }
          allItems = Array.isArray(data.items) ? data.items : [];
          lastUpdatedAt = data.updated_at || null;
          setUpdatedBadge();
          buildSuggestions();
          applyFilter();
          toast('업데이트 완료');
        }catch(e){
          toast(e.message || '업데이트 실패');
        }finally{
          btn.disabled = false; btn.textContent = '작업 불러오기';
        }
      });

      // 초기 상태 설정: 업데이트 시간 배지(KST), 날짜 기본값(오늘 KST), 자동완성 목록, 렌더
      (function init(){
        setUpdatedBadge();
        try{
          const now = new Date();
          const yyyy = now.getFullYear();
          const mm = String(now.getMonth()+1).padStart(2,'0');
          const dd = String(now.getDate()).padStart(2,'0');
          document.getElementById('q-date').value = `${yyyy}-${mm}-${dd}`;
        }catch(e){}
        buildSuggestions();
        applyFilter();
      })();
    </script>
  </body>
  </html>


