<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>월보장 관리 대시보드</title>
    <style>
    :root{
      --bg:#f8fafc; --text:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --primary:#3b82f6; --primary-dark:#2563eb; --success:#10b981; --warning:#f59e0b; --danger:#ef4444;
      --card-bg:#ffffff; --hover:#f1f5f9;
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; }
    body{ background:var(--bg); color:var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif; -webkit-font-smoothing: antialiased; }
    
    /* 레이아웃 */
    .header{ background:var(--card-bg); border-bottom:1px solid var(--line); padding:20px 0; position:sticky; top:0; z-index:50; box-shadow:0 1px 3px rgba(0,0,0,.05); }
    .container{ max-width:1400px; margin:0 auto; padding:0 24px; }
    .header-content{ display:flex; justify-content:space-between; align-items:center; gap:20px; flex-wrap:wrap; }
    .logo{ font-size:24px; font-weight:800; color:var(--text); text-decoration:none; }
    .logo:hover{ color:var(--primary); }
    .nav-links{ display:flex; gap:8px; }
    .nav-link{ padding:8px 16px; border-radius:8px; color:var(--muted); text-decoration:none; font-size:14px; font-weight:500; transition:all .2s; }
    .nav-link:hover{ background:var(--hover); color:var(--text); }
    .nav-link.active{ background:var(--primary); color:#fff; }
    
    .main{ padding:32px 0; }
    .section{ margin-bottom:32px; }
    .section-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .section-title{ font-size:20px; font-weight:700; color:var(--text); }
    
    /* 토글 스위치 */
    .company-toggle{ display:flex; gap:8px; background:var(--card-bg); border:1px solid var(--line); border-radius:10px; padding:4px; }
    .toggle-btn{ padding:10px 24px; border-radius:8px; border:none; background:transparent; color:var(--muted); font-size:14px; font-weight:600; cursor:pointer; transition:all .2s; }
    .toggle-btn.active{ background:var(--primary); color:#fff; }
    
    /* 버튼 */
    .btn{ display:inline-flex; align-items:center; gap:6px; padding:10px 16px; border-radius:8px; font-size:14px; font-weight:500; cursor:pointer; border:none; transition:all .2s; white-space:nowrap; }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-primary:hover{ background:var(--primary-dark); }
    .btn-secondary{ background:#fff; color:var(--text); border:1px solid var(--line); }
    .btn-secondary:hover{ background:var(--hover); }
    .btn-success{ background:var(--success); color:#fff; }
    .btn-danger{ background:var(--danger); color:#fff; }
    .btn-sm{ padding:6px 12px; font-size:13px; }
    .btn:disabled{ opacity:0.6; cursor:not-allowed; }
    
    /* 그리드 */
    .grid{ display:grid; gap:20px; }
    .grid-2{ grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); }
    .grid-3{ grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); }
    .grid-4{ grid-template-columns:repeat(4, 1fr); }
    
    /* 카드 */
    .card{ background:var(--card-bg); border:1px solid var(--line); border-radius:12px; padding:20px; transition:all .2s; }
    .card:hover{ box-shadow:0 4px 12px rgba(0,0,0,.08); }
    
    /* 통계 카드 */
    .stat-card{ position:relative; overflow:hidden; }
    .stat-icon{ position:absolute; top:16px; right:16px; font-size:32px; opacity:0.2; }
    .stat-label{ font-size:13px; color:var(--muted); font-weight:500; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; }
    .stat-value{ font-size:36px; font-weight:800; line-height:1; margin-bottom:8px; }
    .stat-change{ font-size:12px; font-weight:500; }
    .stat-change.up{ color:var(--success); }
    .stat-change.down{ color:var(--danger); }
    
    /* 동기화 배너 */
    .sync-banner{ background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border-radius:12px; padding:20px; display:flex; justify-content:space-between; align-items:center; gap:20px; flex-wrap:wrap; }
    .sync-info{ flex:1; }
    .sync-title{ font-size:16px; font-weight:600; margin-bottom:4px; }
    .sync-meta{ font-size:13px; opacity:0.9; }
    
    /* 차트 */
    .chart-container{ padding:20px 0; }
    .chart-bar-group{ margin-bottom:16px; }
    .chart-label{ font-size:13px; color:var(--muted); margin-bottom:6px; display:flex; justify-content:space-between; }
    .chart-bar-bg{ background:var(--line); height:32px; border-radius:6px; overflow:hidden; position:relative; }
    .chart-bar{ background:linear-gradient(90deg, var(--primary), var(--primary-dark)); height:100%; transition:width .4s ease; display:flex; align-items:center; padding:0 12px; color:#fff; font-size:12px; font-weight:600; }
    
    /* 필터 */
    .filter-bar{ background:var(--card-bg); border:1px solid var(--line); border-radius:10px; padding:16px; display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; }
    .filter-group{ flex:1; min-width:150px; }
    .filter-label{ font-size:12px; color:var(--muted); font-weight:500; margin-bottom:6px; display:block; }
    .filter-input, .filter-select{ width:100%; padding:8px 12px; border:1px solid var(--line); border-radius:8px; font-size:14px; outline:none; transition:all .2s; }
    .filter-input:focus, .filter-select:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    
    /* 테이블 */
    .table-container{ overflow-x:auto; border-radius:10px; border:1px solid var(--line); }
    table{ width:100%; border-collapse:collapse; background:var(--card-bg); }
    th{ background:var(--hover); padding:12px 16px; text-align:left; font-size:12px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; white-space:nowrap; }
    td{ padding:14px 16px; border-top:1px solid var(--line); font-size:14px; }
    tbody tr{ transition:background .2s; }
    tbody tr:hover{ background:var(--hover); }
    
    /* 배지 */
    .badge{ display:inline-flex; align-items:center; padding:4px 10px; border-radius:12px; font-size:11px; font-weight:600; white-space:nowrap; }
    .badge-진행중{ background:#dbeafe; color:#1e40af; }
    .badge-완료{ background:#d1fae5; color:#065f46; }
    .badge-세팅대기{ background:#fef3c7; color:#92400e; }
    .badge-중단{ background:#fee2e2; color:#991b1b; }
    .badge-환불{ background:#f3e8ff; color:#6b21a8; }
    .badge-후불{ background:#fce7f3; color:#9f1239; }
    .badge-신규{ background:#e0f2fe; color:#075985; }
    .badge-연장{ background:#fce7f3; color:#9f1239; }
    
    /* 증감 표시 */
    .trend{ font-size:12px; font-weight:600; }
    .trend-up{ color:var(--success); }
    .trend-down{ color:var(--danger); }
    
    /* 모달 */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:100; }
    .modal.show{ display:flex; }
    .modal-content{ background:#fff; border-radius:16px; max-width:600px; width:90%; max-height:90vh; overflow:auto; }
    .modal-header{ padding:24px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; }
    .modal-title{ font-size:20px; font-weight:700; }
    .modal-body{ padding:24px; }
    .form-group{ margin-bottom:16px; }
    .form-row{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .form-label{ display:block; font-size:13px; font-weight:500; color:var(--muted); margin-bottom:6px; }
    .form-input, .form-select, .form-textarea{ width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:8px; font-size:14px; outline:none; transition:all .2s; }
    .form-input:focus, .form-select:focus, .form-textarea:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    .form-textarea{ resize:vertical; min-height:80px; }
    .modal-footer{ padding:24px; border-top:1px solid var(--line); display:flex; justify-content:flex-end; gap:12px; }
    
    /* Toast */
    .toast{ position:fixed; bottom:24px; right:24px; background:var(--text); color:#fff; padding:14px 20px; border-radius:10px; font-size:14px; font-weight:500; box-shadow:0 8px 24px rgba(0,0,0,.15); z-index:200; opacity:0; transform:translateY(20px); transition:all .3s; }
    .toast.show{ opacity:1; transform:translateY(0); }
    
    /* 빈 상태 */
    .empty-state{ text-align:center; padding:60px 20px; color:var(--muted); }
    .empty-icon{ font-size:48px; margin-bottom:16px; }
    .empty-title{ font-size:18px; font-weight:600; margin-bottom:8px; color:var(--text); }
    .empty-desc{ font-size:14px; }
    
    /* 로딩 */
    .loading{ display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,.3); border-top-color:#fff; border-radius:50%; animation:spin .6s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg); } }
    
    /* 반응형 */
    @media(max-width:768px){
      .header-content{ flex-direction:column; align-items:stretch; }
      .grid-2, .grid-3, .grid-4{ grid-template-columns:1fr; }
      .filter-bar{ flex-direction:column; align-items:stretch; }
      .modal-content{ width:95%; }
    }
    </style>
  </head>
  <body>
  <!-- 헤더 -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="/" class="logo">🏢 제이투랩 관리시스템</a>
        <div class="nav-links">
          <a href="/" class="nav-link">마감 안내</a>
          <a href="/manage" class="nav-link active">월보장 관리</a>
          <a href="/settlement" class="nav-link">결재선 · 정산</a>
        </div>
      </div>
    </div>
  </header>

  <!-- 메인 -->
  <main class="main">
    <div class="container">
      <!-- 동기화 배너 -->
      <div class="sync-banner">
        <div class="sync-info">
          <div class="sync-title">📡 구글 시트 동기화</div>
          <div class="sync-meta">
            <span id="sync-status">마지막 동기화: -</span> · 
            <span id="next-sync">다음: -</span>
          </div>
          <div class="sync-meta" style="margin-top:4px; font-size:12px; opacity:0.85;">
            <span id="workload-cache-status">⚡ 작업량 캐시: 로딩 중...</span>
          </div>
        </div>
        <div style="display:flex; gap:12px; align-items:center;">
          <!-- 회사 토글 -->
          <div class="company-toggle" style="background:rgba(255,255,255,.15); border-color:rgba(255,255,255,.2);">
            <button class="toggle-btn active" data-company="제이투랩" style="color:#fff;">🏢 제이투랩</button>
            <button class="toggle-btn" data-company="일류기획" style="color:rgba(255,255,255,.7);">🏢 일류기획</button>
          </div>
          <button class="btn" id="btn-sync" style="background:#fff; color:var(--primary); font-weight:600; box-shadow:0 2px 8px rgba(0,0,0,.15);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,.2)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(0,0,0,.15)'">
            <span id="sync-btn-text">🔄 동기화</span>
          </button>
          <button class="btn" id="btn-refresh-workload" style="background:#10b981; color:#fff; font-weight:600; box-shadow:0 2px 8px rgba(0,0,0,.15);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,.2)'; this.style.background='#059669'" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px rgba(0,0,0,.15)'; this.style.background='#10b981'">
            <span id="workload-btn-text">⚡ 작업량 갱신</span>
          </button>
      </div>
      </div>

      <!-- 주요 통계 -->
      <div class="section" style="margin-top:32px;">
        <div class="grid grid-4">
          <div class="card stat-card" style="border-left:4px solid var(--primary);">
            <div class="stat-icon">🚀</div>
            <div class="stat-label">진행중 업체</div>
            <div class="stat-value" id="stat-working">0</div>
            <div class="stat-change muted" style="font-size:11px;">진행중 + 후불</div>
          </div>
          <div class="card stat-card" style="border-left:4px solid var(--success);">
            <div class="stat-icon">✅</div>
            <div class="stat-label">실시간 노출</div>
            <div class="stat-value" style="color:var(--success);" id="stat-exposed">0</div>
            <div class="stat-change" id="stat-exposed-change"></div>
              </div>
          <div class="card stat-card" style="border-left:4px solid var(--danger);">
            <div class="stat-icon">⚠️</div>
            <div class="stat-label">실시간 미노출</div>
            <div class="stat-value" style="color:var(--danger);" id="stat-not-exposed">0</div>
            <div class="stat-change" id="stat-not-exposed-change"></div>
            </div>
          <div class="card stat-card" style="border-left:4px solid #8b5cf6;">
            <div class="stat-icon">💳</div>
            <div class="stat-label">후불 진행건</div>
            <div class="stat-value" style="color:#8b5cf6;" id="stat-postpaid">0</div>
          </div>
          </div>
        </div>
        
      <!-- 회사별 현황 -->
      <div class="section">
        <h2 class="section-title">📈 회사별 현황</h2>
        <div class="grid grid-2">
          <div class="card">
            <h3 style="font-size:16px; font-weight:600; margin-bottom:16px; color:var(--primary);" id="company-chart-title-1">🏢 제이투랩</h3>
            <div class="chart-container" id="chart-company"></div>
          </div>
            <div class="card">
            <h3 style="font-size:16px; font-weight:600; margin-bottom:16px;">📊 상태별 분포</h3>
            <div class="chart-container" id="chart-status"></div>
          </div>
        </div>
            </div>

      <!-- 상품별 / 월별 분석 -->
      <div class="section">
        <div class="grid grid-2">
            <div class="card">
            <h3 style="font-size:16px; font-weight:600; margin-bottom:16px;">📦 상품별 분포</h3>
            <div class="chart-container" id="chart-products"></div>
            </div>
            <div class="card">
            <h3 style="font-size:16px; font-weight:600; margin-bottom:16px;">📅 월별 계약 건수</h3>
            <div class="chart-container" id="chart-monthly"></div>
          </div>
          </div>
        </div>

        <!-- 필터 및 검색 -->
      <div class="section">
        <div class="section-header">
          <h2 class="section-title">📋 보장건 목록</h2>
          <button class="btn btn-success" id="btn-add">➕ 새 보장건 등록</button>
            </div>
        <div class="filter-bar">
          <div class="filter-group">
            <label class="filter-label">상태</label>
            <select class="filter-select" id="filter-status">
                <option value="">전체</option>
                <option value="진행중">진행중</option>
                <option value="세팅대기">세팅대기</option>
                <option value="완료">완료</option>
                <option value="중단">중단</option>
                <option value="환불">환불</option>
              <option value="후불">후불</option>
              </select>
            </div>
          <div class="filter-group">
            <label class="filter-label">상품</label>
            <select class="filter-select" id="filter-product">
              <option value="">전체</option>
              <option value="플레이스">플레이스</option>
              <option value="쇼핑">쇼핑</option>
              <option value="자동완성">자동완성</option>
              <option value="기타">기타</option>
            </select>
            </div>
          <div class="filter-group" style="flex:2;">
            <label class="filter-label">검색</label>
            <input type="text" class="filter-input" id="search-input" placeholder="상호명, 키워드, 대행사 검색...">
          </div>
          <button class="btn btn-primary" id="btn-search">🔍 검색</button>
          <button class="btn btn-secondary" id="btn-reset">🔄 초기화</button>
          </div>
        </div>

      <!-- 테이블 -->
      <div class="section">
        <div class="table-container">
            <table id="guarantee-table">
              <thead>
                <tr>
                  <th>구분</th>
                  <th>대행사</th>
                  <th>상호명</th>
                  <th>키워드</th>
                <th>상품</th>
                <th>상태</th>
                <th>현재순위</th>
                <th>증감</th>
                <th>계약일</th>
                  <th>작업시작</th>
                  <th>액션</th>
                </tr>
              </thead>
            <tbody id="table-body">
              <tr>
                <td colspan="11" style="text-align:center; padding:40px; color:var(--muted);">데이터를 불러오는 중...</td>
              </tr>
            </tbody>
            </table>
        </div>
      </div>
    </div>
  </main>

  <!-- 모달 -->
    <div class="modal" id="guarantee-modal">
      <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title">새 보장건 등록</h3>
        <button class="btn btn-sm btn-secondary" onclick="closeModal()">✕</button>
        </div>
      <div class="modal-body">
        <form id="guarantee-form">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">구분*</label>
              <select name="type" class="form-select" required>
                <option value="신규">신규</option>
                <option value="연장">연장</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">회사*</label>
              <select name="company" class="form-select" required>
                <option value="제이투랩">제이투랩</option>
                <option value="일류기획">일류기획</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">계약일*</label>
              <input type="date" name="contract_date" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">작업 시작일</label>
              <input type="date" name="work_start_date" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">대행사</label>
              <input type="text" name="agency" class="form-input" placeholder="대행사명">
            </div>
            <div class="form-group">
              <label class="form-label">상호명*</label>
              <input type="text" name="business_name" class="form-input" placeholder="업체 상호명" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">메인 키워드</label>
              <input type="text" name="main_keyword" class="form-input" placeholder="노출 키워드">
            </div>
            <div class="form-group">
              <label class="form-label">보장 순위</label>
              <input type="text" name="guarantee_rank" class="form-input" placeholder="예: 5위 이상">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">상품</label>
              <select name="product" class="form-select">
                <option value="플레이스">플레이스</option>
                <option value="쇼핑">쇼핑</option>
                <option value="자동완성">자동완성</option>
                <option value="기타">기타</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">상태</label>
              <select name="status" class="form-select">
                <option value="세팅대기">세팅대기</option>
                <option value="진행중">진행중</option>
                <option value="완료">완료</option>
                <option value="중단">중단</option>
                <option value="환불">환불</option>
                <option value="후불">후불</option>
              </select>
            </div>
          </div>
          <div class="form-row">
          <div class="form-group">
              <label class="form-label">총 계약금 (VAT 제외)</label>
              <input type="number" name="total_contract" class="form-input" placeholder="0">
          </div>
          <div class="form-group">
              <label class="form-label">입금액/마진 (VAT 제외)</label>
              <input type="number" name="deposit_amount" class="form-input" placeholder="0">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">메모</label>
            <textarea name="memo" class="form-textarea" placeholder="메모 입력..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
        <button type="submit" form="guarantee-form" class="btn btn-primary">💾 저장</button>
      </div>
    </div>
  </div>

  <!-- 작업량 스케줄 모달 -->
  <div class="modal" id="workload-modal">
    <div class="modal-content" style="max-width:700px;">
      <div class="modal-header">
        <h3 class="modal-title">📊 작업량 스케줄 (최근 4주)</h3>
        <button class="btn btn-sm btn-secondary" onclick="closeWorkloadModal()">✕</button>
      </div>
      <div class="modal-body" style="padding:32px; background:var(--bg);">
        <div id="workload-content" style="font-family:monospace;">
          <div style="text-align:center; padding:40px; color:var(--muted);">
            <div class="loading" style="margin:0 auto 16px;"></div>
            <div>데이터를 불러오는 중...</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="btn-copy-workload" onclick="copyWorkloadToClipboard()" style="display:inline-flex;">📋 복사</button>
        <button type="button" class="btn btn-secondary" onclick="closeWorkloadModal()">닫기</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

    <script>
    let allData = [];
    let currentEditId = null;
    let currentCompany = '제이투랩';  // 기본값
    let businessWorkloadCache = {};  // 업체별 작업량 캐시
    let currentWorkloadData = null;  // 현재 표시중인 작업량 데이터

    // Toast
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // 작업량 캐시 상태 업데이트
    async function updateWorkloadCacheStatus() {
      try {
        const res = await fetch('/api/workload/cache/status');
        const status = await res.json();
        
        const statusEl = document.getElementById('workload-cache-status');
        if (status.is_valid && status.updated_at) {
          const updateTime = new Date(status.updated_at);
          const timeStr = updateTime.toLocaleString('ko-KR', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
          const businessInfo = status.business_count > 0 ? `, ${status.business_count}개 업체` : '';
          statusEl.innerHTML = `⚡ 작업량 캐시: ${timeStr} (${status.company_count}개 회사${businessInfo})`;
          statusEl.style.color = 'rgba(255,255,255,0.9)';
        } else {
          statusEl.innerHTML = '⚡ 작업량 캐시: 없음 (갱신 필요)';
          statusEl.style.color = 'rgba(255,200,0,0.9)';
        }
      } catch (e) {
        console.error('Failed to load cache status:', e);
        document.getElementById('workload-cache-status').innerHTML = '⚡ 작업량 캐시: 상태 확인 실패';
      }
    }
    
    // 업체별 작업량 데이터 미리 로드
    async function loadBusinessWorkloads() {
      const statusEl = document.getElementById('workload-cache-status');
      
      try {
        console.log(`Loading business workloads for ${currentCompany}...`);
        statusEl.innerHTML = '⚡ 작업량 캐시: 로딩 중...';
        statusEl.style.color = 'rgba(255,200,0,0.9)';
        
        const res = await fetch(`/api/workload/businesses?company=${encodeURIComponent(currentCompany)}`);
        const data = await res.json();
        
        if (data.businesses && Object.keys(data.businesses).length > 0) {
          businessWorkloadCache = data.businesses;
          console.log(`✅ Loaded ${data.count} business workloads from ${data.from_cache ? 'cache' : 'direct'}`);
          console.log(`📋 업체 목록: ${Object.keys(data.businesses).join(', ')}`);
        } else {
          businessWorkloadCache = {};
          console.log('⚠️ No business workload data available');
          if (data.message) {
            console.log(data.message);
          }
        }
        
        // 캐시 상태도 업데이트
        updateWorkloadCacheStatus();
      } catch (e) {
        console.error('Failed to load business workloads:', e);
        businessWorkloadCache = {};
        statusEl.innerHTML = '⚡ 작업량 캐시: 로드 실패';
        statusEl.style.color = 'rgba(255,100,100,0.9)';
      }
    }
    
    // 회사 토글
    document.querySelectorAll('.toggle-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentCompany = btn.dataset.company;
        
        // 토글 버튼 스타일 업데이트
        document.querySelectorAll('.toggle-btn').forEach(b => {
          b.classList.remove('active');
          b.style.color = 'rgba(255,255,255,.7)';
        });
        btn.classList.add('active');
        btn.style.color = '#fff';
        
        // 데이터 재로드
        loadData();
        updateExposureStatus();
        loadBusinessWorkloads();  // 업체별 작업량도 재로드
      });
    });

    // 모달
    function openModal(item = null) {
        const modal = document.getElementById('guarantee-modal');
        const form = document.getElementById('guarantee-form');
        const title = document.getElementById('modal-title');
        
      if (item) {
          title.textContent = '보장건 수정';
          currentEditId = item.id;
        Object.keys(item).forEach(key => {
          if (form[key]) form[key].value = item[key] || '';
        });
        } else {
          title.textContent = '새 보장건 등록';
          currentEditId = null;
          form.reset();
        // 현재 선택된 회사로 기본값 설정
        form.company.value = currentCompany;
      }
      
      modal.classList.add('show');
    }

    function closeModal() {
      document.getElementById('guarantee-modal').classList.remove('show');
        currentEditId = null;
      }
      
    // 노출 현황 로드
    async function updateExposureStatus() {
      try {
        const res = await fetch(`/api/guarantee/exposure-status?company=${encodeURIComponent(currentCompany)}`);
        const data = await res.json();
        
        // 통계 업데이트
        document.getElementById('stat-exposed').textContent = data.exposed || 0;
        document.getElementById('stat-not-exposed').textContent = data.not_exposed || 0;
        
        // 진행중 업체 수 (노출+미노출)
        const workingCount = (data.exposed || 0) + (data.not_exposed || 0);
        document.getElementById('stat-working').textContent = workingCount;
        
      } catch (e) {
        console.error('Exposure status error:', e);
      }
    }

    // 데이터 로드
    async function loadData() {
      try {
        const status = document.getElementById('filter-status').value;
        const product = document.getElementById('filter-product').value;
        
        const params = new URLSearchParams();
        params.append('company', currentCompany);
        if (status) params.append('status', status);
        if (product) params.append('product', product);
        
          const res = await fetch(`/api/guarantee/items?${params}`);
          const data = await res.json();
          
        allData = data.items || [];
        renderTable(allData);
        updateStatistics();
        updateCharts();
      } catch (e) {
        console.error(e);
        showToast('데이터 로드 실패');
      }
    }

    // 테이블 렌더링
    function renderTable(items) {
      const tbody = document.getElementById('table-body');
      
      if (!items || items.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="11">
              <div class="empty-state">
                <div class="empty-icon">📭</div>
                <div class="empty-title">데이터가 없습니다</div>
                <div class="empty-desc">필터를 변경하거나 새 보장건을 등록해보세요</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = items.map(item => {
        const dailyRanks = item.daily_ranks || {};
        const sortedDays = Object.keys(dailyRanks).map(d => parseInt(d)).sort((a,b) => a-b);
        
        let currentRank = '-';
        let trendHtml = '';
        
        if (sortedDays.length > 0) {
          const latestDay = sortedDays[sortedDays.length - 1];
          currentRank = dailyRanks[latestDay] || '-';
          
          // 증감 계산
          const trends = [];
          if (sortedDays.length >= 2) {
            const prevRank = dailyRanks[sortedDays[sortedDays.length - 2]];
            if (prevRank && currentRank !== '-') {
              const diff = parseInt(prevRank) - parseInt(currentRank);
              if (diff > 0) trends.push(`<span class="trend trend-up">▲${diff}</span>`);
              else if (diff < 0) trends.push(`<span class="trend trend-down">▼${Math.abs(diff)}</span>`);
              else trends.push('<span class="trend">-</span>');
            }
          }
          if (sortedDays.length >= 3) {
            const prevRank2 = dailyRanks[sortedDays[sortedDays.length - 3]];
            if (prevRank2 && currentRank !== '-') {
              const diff = parseInt(prevRank2) - parseInt(currentRank);
              if (diff > 0) trends.push(`<span class="trend trend-up">▲${diff}</span>`);
              else if (diff < 0) trends.push(`<span class="trend trend-down">▼${Math.abs(diff)}</span>`);
            }
          }
          if (sortedDays.length >= 4) {
            const prevRank3 = dailyRanks[sortedDays[sortedDays.length - 4]];
            if (prevRank3 && currentRank !== '-') {
              const diff = parseInt(prevRank3) - parseInt(currentRank);
              if (diff > 0) trends.push(`<span class="trend trend-up">▲${diff}</span>`);
              else if (diff < 0) trends.push(`<span class="trend trend-down">▼${Math.abs(diff)}</span>`);
            }
          }
          
          trendHtml = trends.slice(0, 3).join(' ');
        }
        
        return `
          <tr>
            <td><span class="badge badge-${item.type || '신규'}">${item.type || '신규'}</span></td>
            <td>${item.agency || '-'}</td>
            <td><strong>${item.business_name || ''}</strong></td>
            <td>${item.main_keyword || '-'}</td>
            <td>${item.product || '플레이스'}</td>
            <td><span class="badge badge-${item.status || '세팅대기'}">${item.status || '세팅대기'}</span></td>
            <td><strong>${currentRank}</strong></td>
            <td style="min-width:120px;">${trendHtml}</td>
            <td>${item.contract_date || '-'}</td>
            <td>${item.work_start_date || '-'}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick='showWorkload("${item.company || currentCompany}", "${item.business_name || ''}")'>📊 작업량</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // 통계 업데이트
    async function updateStatistics() {
      try {
        const res = await fetch('/api/guarantee/statistics');
        const stats = await res.json();
        
        // 후불 진행건 수 계산
        let postpaidCount = 0;
        allData.forEach(item => {
          if (item.status === '후불') postpaidCount++;
        });
        document.getElementById('stat-postpaid').textContent = postpaidCount;
        
      } catch (e) {
        console.error(e);
      }
    }

    // 차트 업데이트
    async function updateCharts() {
      try {
          const res = await fetch('/api/guarantee/statistics');
          const stats = await res.json();
          
        // 회사별 차트
        const companyData = stats.by_company[currentCompany] || {};
        renderCompanyChart(companyData);
        
        // 상태별 차트
        const statusData = {};
        allData.forEach(item => {
          const status = item.status || '기타';
          statusData[status] = (statusData[status] || 0) + 1;
        });
        renderBarChart('chart-status', statusData);
        
        // 상품별 차트
        const productData = {};
        allData.forEach(item => {
          const product = item.product || '기타';
          productData[product] = (productData[product] || 0) + 1;
        });
        renderBarChart('chart-products', productData);
        
        // 월별 차트 (전체 통계 사용)
        renderBarChart('chart-monthly', stats.by_month || {});
      } catch (e) {
          console.error(e);
        }
      }
      
    function renderCompanyChart(data) {
      const el = document.getElementById('chart-company');
      const total = data.total || 0;
      const active = data.active || 0;
      const completed = data.completed || 0;
      
      el.innerHTML = `
        <div class="chart-bar-group">
          <div class="chart-label"><span>전체</span><span>${total}건</span></div>
          <div class="chart-bar-bg">
            <div class="chart-bar" style="width:${total > 0 ? 100 : 0}%; background:linear-gradient(90deg, #3b82f6, #2563eb);">${total}</div>
          </div>
        </div>
        <div class="chart-bar-group">
          <div class="chart-label"><span>진행중</span><span>${active}건</span></div>
          <div class="chart-bar-bg">
            <div class="chart-bar" style="width:${total > 0 ? (active/total*100) : 0}%; background:linear-gradient(90deg, #3b82f6, #2563eb);">${active}</div>
          </div>
        </div>
        <div class="chart-bar-group">
          <div class="chart-label"><span>완료</span><span>${completed}건</span></div>
          <div class="chart-bar-bg">
            <div class="chart-bar" style="width:${total > 0 ? (completed/total*100) : 0}%; background:linear-gradient(90deg, #10b981, #059669);">${completed}</div>
          </div>
        </div>
      `;
    }

    function renderBarChart(elementId, data) {
      const el = document.getElementById(elementId);
      const entries = Object.entries(data).sort((a, b) => b[1] - a[1]).slice(0, 5);
      const maxValue = Math.max(...entries.map(e => typeof e[1] === 'object' ? e[1].total || 0 : e[1]), 1);
      
      if (entries.length === 0) {
        el.innerHTML = '<div style="text-align:center; color:var(--muted); padding:20px;">데이터 없음</div>';
        return;
      }
      
      el.innerHTML = entries.map(([key, value]) => {
        const val = typeof value === 'object' ? value.total || 0 : value;
        return `
          <div class="chart-bar-group">
            <div class="chart-label"><span>${key}</span><span>${val}건</span></div>
            <div class="chart-bar-bg">
              <div class="chart-bar" style="width:${(val/maxValue*100)}%;">${val}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // 동기화
    async function syncData() {
      const btn = document.getElementById('btn-sync');
      const btnText = document.getElementById('sync-btn-text');
      btn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span> 동기화 중...';
      
      try {
        const res = await fetch('/api/guarantee/sync', { method: 'POST' });
        const data = await res.json();
        
        if (res.ok) {
          showToast(data.message || '동기화 완료');
          loadData();
          updateExposureStatus();
          updateSyncStatus();
          } else {
          showToast('동기화 실패: ' + (data.error || '알 수 없는 오류'));
        }
      } catch (e) {
        showToast('동기화 실패');
      } finally {
        btn.disabled = false;
        btnText.textContent = '🔄 동기화';
      }
    }
    
    // 작업량 캐시 갱신
    async function refreshWorkloadCache() {
      const btn = document.getElementById('btn-refresh-workload');
      const btnText = document.getElementById('workload-btn-text');
      const statusEl = document.getElementById('workload-cache-status');
      
      btn.disabled = true;
      btnText.innerHTML = '<span class="loading"></span> 갱신 중...';
      statusEl.innerHTML = '⚡ 작업량 캐시: 갱신 중... (진행중인 업체만 조회)';
      statusEl.style.color = 'rgba(255,200,0,0.9)';
      
      // 시작 시간 기록
      const startTime = Date.now();
      
      try {
        const res = await fetch('/api/workload/cache/refresh', { method: 'POST' });
        const data = await res.json();
        
        // 소요 시간 계산
        const elapsedSeconds = Math.round((Date.now() - startTime) / 1000);
        
        if (res.ok) {
          const businessCount = data.business_count || 0;
          const msg = `${data.message || '작업량 캐시 갱신 완료'} (${elapsedSeconds}초 소요)`;
          showToast(msg);
          console.log('캐시 갱신 결과:', data);
          console.log(`소요 시간: ${elapsedSeconds}초`);
          
          // 업체별 데이터 다시 로드 (캐시 상태도 함께 업데이트)
          await loadBusinessWorkloads();
        } else {
          showToast('캐시 갱신 실패: ' + (data.error || '알 수 없는 오류'));
          statusEl.innerHTML = '⚡ 작업량 캐시: 갱신 실패';
          statusEl.style.color = 'rgba(255,100,100,0.9)';
        }
      } catch (e) {
        console.error('캐시 갱신 오류:', e);
        showToast('캐시 갱신 실패');
        statusEl.innerHTML = '⚡ 작업량 캐시: 갱신 실패';
        statusEl.style.color = 'rgba(255,100,100,0.9)';
      } finally {
        btn.disabled = false;
        btnText.textContent = '⚡ 작업량 갱신';
      }
    }

    async function updateSyncStatus() {
      try {
          const res = await fetch('/api/guarantee/sync-status');
          const data = await res.json();
          
        if (data.last_sync) {
          const date = new Date(data.last_sync);
          const dateStr = date.toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          });
          document.getElementById('sync-status').textContent = 
            `마지막 동기화: ${dateStr}`;
        }
        
        if (data.next_sync_kst) {
          // KST 제거
          const nextSyncStr = data.next_sync_kst.replace(' KST', '');
          document.getElementById('next-sync').textContent = `다음: ${nextSyncStr}`;
        }
      } catch (e) {
          console.error(e);
        }
      }

    // 폼 제출
    document.getElementById('guarantee-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      try {
        const url = currentEditId 
          ? `/api/guarantee/items/${currentEditId}`
          : '/api/guarantee/items';
        const method = currentEditId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          showToast(currentEditId ? '수정되었습니다' : '등록되었습니다');
          closeModal();
          loadData();
          updateExposureStatus();
        }
      } catch (e) {
        showToast('저장 실패');
      }
    });

    // 복사 버튼 함수
    function copyWorkloadToClipboard() {
      if (!currentWorkloadData || !currentWorkloadData.weeks || currentWorkloadData.weeks.length === 0) {
        showToast('복사할 데이터가 없습니다');
        return;
      }
      
      // 텍스트 형식으로 변환 (같은 기간의 작업들을 함께)
      const lines = [];
      currentWorkloadData.weeks.forEach(week => {
        lines.push(`${week.start_date} ~ ${week.end_date}`);
        week.items.forEach(item => {
          lines.push(`${item.name} : ${item.workload}`);
        });
        lines.push(''); // 빈 줄
      });
      
      const text = lines.join('\n').trim();
      
      console.log('복사할 텍스트:', text);
      
      // 클립보드에 복사
      navigator.clipboard.writeText(text).then(() => {
        showToast('📋 클립보드에 복사되었습니다');
      }).catch(err => {
        console.error('복사 실패:', err);
        showToast('복사 실패');
      });
    }
    
    // 작업량 데이터 렌더링
    function renderWorkloadData(data) {
      const content = document.getElementById('workload-content');
      const copyBtn = document.getElementById('btn-copy-workload');
      
      // 현재 데이터 저장 (복사용)
      currentWorkloadData = data;
      
      if (!data.weeks || data.weeks.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">📭</div>
            <div class="empty-title">작업 스케줄이 없습니다</div>
            <div class="empty-desc">최근 4주간 진행된 작업이 없습니다</div>
          </div>
        `;
        currentWorkloadData = null;
        if (copyBtn) copyBtn.style.display = 'none';
        return;
      }
      
      // 스케줄 렌더링 (같은 기간의 작업들을 함께 표시)
      const html = data.weeks.map(week => {
        const itemsText = week.items.map(item => 
          `<div style="padding-left:0; color:var(--text); line-height:1.8;">${item.name} : ${item.workload}</div>`
        ).join('');
        
        return `
          <div style="margin-bottom:20px; font-size:14px;">
            <div style="font-weight:700; font-size:15px; color:var(--primary); margin-bottom:8px;">
              ${week.start_date} ~ ${week.end_date}
            </div>
            ${itemsText}
          </div>
        `;
      }).join('');
      
      content.innerHTML = html;
      
      console.log(`📊 렌더링: ${data.weeks.length}개 기간, 총 ${data.weeks.reduce((sum, w) => sum + w.items.length, 0)}개 작업`);
      
      // 디버깅: 처음 몇 개 출력
      data.weeks.slice(0, 3).forEach((week, idx) => {
        console.log(`  [${idx+1}] ${week.start_date} ~ ${week.end_date}: ${week.items.map(i => i.name).join(', ')}`);
      });
    }
    
    // 작업량 스케줄 모달
    async function showWorkload(company, businessName = null) {
      const modal = document.getElementById('workload-modal');
      const content = document.getElementById('workload-content');
      
      // 모달 표시
      modal.classList.add('show');
      
      // 모달 제목 업데이트
      const modalTitle = modal.querySelector('.modal-title');
      if (businessName) {
        modalTitle.textContent = `📊 ${businessName} - 작업량 스케줄 (최근 4주)`;
      } else {
        modalTitle.textContent = `📊 작업량 스케줄 (최근 4주)`;
      }
      
      // 업체별 조회: 캐시만 사용
      if (businessName) {
        if (businessWorkloadCache[businessName]) {
          console.log(`✅ Using cached data for ${businessName} (instant load!)`);
          renderWorkloadData(businessWorkloadCache[businessName]);
          return;
        } else {
          // 캐시가 없으면 안내 메시지
          console.log(`⚠️ No cache for ${businessName}`);
          console.log('Available businesses in cache:', Object.keys(businessWorkloadCache));
          
          // 복사 버튼 숨기기
          const copyBtn = document.getElementById('btn-copy-workload');
          if (copyBtn) copyBtn.style.display = 'none';
          
          content.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">⏱️</div>
              <div class="empty-title">캐시된 데이터가 없습니다</div>
              <div class="empty-desc" style="margin-bottom:16px;">
                상단의 <strong style="color:var(--success);">'⚡ 작업량 갱신'</strong> 버튼을 눌러<br>
                업체별 작업량을 미리 불러온 후 다시 시도해주세요.
              </div>
              <button class="btn btn-success" onclick="closeWorkloadModal(); document.getElementById('btn-refresh-workload').click();">
                ⚡ 지금 갱신하기
              </button>
            </div>
          `;
          return;
        }
      }
      
      // 회사 전체 조회: API 호출
      content.innerHTML = `
        <div style="text-align:center; padding:40px; color:var(--muted);">
          <div class="loading" style="margin:0 auto 16px;"></div>
          <div>데이터를 불러오는 중...</div>
        </div>
      `;
      
      try {
        const url = `/api/workload/schedule?company=${encodeURIComponent(company)}`;
        const res = await fetch(url);
        const data = await res.json();
        
        renderWorkloadData(data);
      } catch (e) {
        console.error('Workload schedule error:', e);
        content.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">⚠️</div>
            <div class="empty-title">데이터 로드 실패</div>
            <div class="empty-desc">${e.message || '알 수 없는 오류가 발생했습니다'}</div>
          </div>
        `;
      }
    }
    
    function closeWorkloadModal() {
      document.getElementById('workload-modal').classList.remove('show');
    }
    
    window.showWorkload = showWorkload;

    // 검색
    document.getElementById('btn-search').addEventListener('click', async () => {
      const query = document.getElementById('search-input').value.trim();
      if (!query) return loadData();
      
      try {
        const res = await fetch(`/api/guarantee/search?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        // 현재 회사 필터 적용
        const filtered = data.items.filter(item => item.company === currentCompany);
        renderTable(filtered);
      } catch (e) {
        showToast('검색 실패');
      }
    });

    // 초기화
    document.getElementById('btn-reset').addEventListener('click', () => {
      document.getElementById('filter-status').value = '';
      document.getElementById('filter-product').value = '';
      document.getElementById('search-input').value = '';
      loadData();
    });

    // 이벤트
    document.getElementById('btn-sync').addEventListener('click', syncData);
    document.getElementById('btn-refresh-workload').addEventListener('click', refreshWorkloadCache);
    document.getElementById('btn-add').addEventListener('click', () => openModal());
    document.getElementById('filter-status').addEventListener('change', loadData);
    document.getElementById('filter-product').addEventListener('change', loadData);
    document.getElementById('search-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('btn-search').click();
    });

    // 초기 로드
    loadData();
    updateExposureStatus();
    updateSyncStatus();
    loadBusinessWorkloads();  // 업체별 작업량 미리 로드
    </script>
  </body>
  </html>
