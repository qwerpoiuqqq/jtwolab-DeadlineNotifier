<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>내부 보장건 관리</title>
    <style>
      :root{ --bg:#ffffff; --text:#1f2328; --muted:#6b778c; --line:#e5e7eb; --panel:#ffffff; --pill:#f6f8fa; --btn:#111827; }
      html,body{ height:100% }
      body{ margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, "Noto Sans KR", Arial; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
      .container{ max-width:980px; margin:0 auto; padding:24px; }
      .title{ font-weight:800; letter-spacing:.2px; font-size:18px; margin-bottom:16px; }
      .home-link{ color:inherit; text-decoration:none; }
      .home-link:hover{ text-decoration:underline; }
      .nav{ display:flex; gap:8px; margin-bottom:12px; }
      .btn{ border:1px solid var(--line); background:#fff; color:#111827; padding:10px 14px; border-radius:10px; cursor:pointer; }
      .btn-primary{ background:#111827; color:#fff; border-color:#111827; }
      .panel{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:16px; }
      .stack{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      input[type="text"]{ background:#fff; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px; min-width:220px; outline:none; }
      .muted{ color:var(--muted); }
      table{ width:100%; border-collapse: collapse; }
      th, td{ border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; }
      th{ font-size:12px; color:var(--muted); font-weight:600; }
      .badge{ display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:var(--pill); font-size:12px; }
      .right{ margin-left:auto; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="title"><a class="home-link" href="/">마감 안내 생성기</a> · <span class="muted">내부 보장건</span></div>

      <div class="panel" style="margin-bottom:12px">
        <div class="stack">
          <div class="nav">
            <a class="btn" href="/">마감 안내</a>
            <a class="btn btn-primary" href="/manage">보장 관리</a>
          </div>
          <div class="right stack">
            <span class="muted">마지막 업데이트:</span>
            <span id="last-updated" class="badge">{{ updated_at or '없음' }}</span>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-bottom:12px">
        <div class="stack" style="align-items:flex-end">
          <div>
            <label class="muted" style="display:block; font-size:12px; margin-bottom:6px">기준일</label>
            <input id="base-date" type="date" />
          </div>
          <div>
            <label class="muted" style="display:block; font-size:12px; margin-bottom:6px">최근 주 수</label>
            <input id="weeks" type="text" value="3" style="min-width:80px" />
          </div>
          <button id="load-weekly" class="btn btn-primary">주간 요약 불러오기</button>
        </div>
      </div>

      <div class="panel" style="margin-bottom:12px">
        <div class="muted" style="margin-bottom:8px">총 <span id="count">0</span>개 업체</div>
        <div id="cards" class="grid" style="grid-template-columns: 1fr;"> </div>
      </div>

    </div>

    <div class="panel" id="toast" style="display:none; position:fixed; right:16px; bottom:16px; background:#111827; color:#fff; border:1px solid #111827; padding:10px 12px; border-radius:10px;">완료</div>

    <script>
      const initialItems = {{ (initial_items or []) | tojson | safe }};
      const initialUpdatedAt = {{ (updated_at or 'null') | tojson | safe }};
      const $ = (sel)=>document.querySelector(sel);
      function toast(msg){ const t=$('#toast'); if(!t) return; t.textContent=msg||'완료'; t.style.display='block'; setTimeout(()=>t.style.display='none', 1200); }

      function norm(s){ return (s||'').toString().trim().toLowerCase(); }
      let lastUpdatedAt = typeof initialUpdatedAt==='string' ? initialUpdatedAt : null;
      let weeklyGroups = [];

      function toKSTString(iso){
        try{
          const d = new Date(iso);
          // KST 포맷
          return d.toLocaleString('ko-KR', { timeZone: 'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }).replaceAll('.', '-').replace(' ', ' ').replace(/\.$/, '') + ' KST';
        }catch(e){ return iso||''; }
      }
      function setUpdatedBadge(){
        const el = document.getElementById('last-updated');
        if(!el) return;
        el.textContent = lastUpdatedAt ? toKSTString(lastUpdatedAt) : '없음';
      }

      function ymd(date){ const y=date.getFullYear(); const m=String(date.getMonth()+1).padStart(2,'0'); const d=String(date.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }
      function parseYMD(str){ const [y,m,d]=(str||'').split('-').map(v=>parseInt(v,10)); if(!y||!m||!d) return null; return new Date(Date.UTC(y, m-1, d)); }
      function toUTCDateOnly(iso){ try{ const d=new Date(iso); return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())); }catch(e){ return null; } }
      function daysBetween(aUTCDateOnly, bUTCDateOnly){ if(!aUTCDateOnly||!bUTCDateOnly) return 0; const ms= aUTCDateOnly.getTime()-bUTCDateOnly.getTime(); return Math.round(ms/86400000); }

      let bizOptions = [];
      let agencyOptions = [];
      function buildOptionSets(){
        const bizSet = new Set();
        const agencySet = new Set();
        for(const it of allItems){ if(it.bizname) bizSet.add(it.bizname.trim()); if(it.agency) agencySet.add(it.agency.trim()); }
        bizOptions = Array.from(bizSet).sort((a,b)=>a.localeCompare(b,'ko'));
        agencyOptions = Array.from(agencySet).sort((a,b)=>a.localeCompare(b,'ko'));
      }
      function updateDatalistFor(inputId, datalistId, options){
        const inp = document.getElementById(inputId);
        const dl = document.getElementById(datalistId);
        if(!inp || !dl) return;
        const q = norm(inp.value);
        if(!q){ dl.innerHTML = ''; return; }
        const filtered = options.filter(v=> norm(v).includes(q)).slice(0, 30);
        dl.innerHTML = filtered.map(v=>`<option value="${v}"></option>`).join('');
      }

      function renderWeekly(groups){
        const container = document.getElementById('cards');
        container.innerHTML = '';
        for(const g of groups){
          const card = document.createElement('div');
          card.className = 'panel';
          const id = Math.random().toString(36).slice(2,8);
          const header = document.createElement('div');
          header.className = 'stack';
          header.style.justifyContent = 'space-between';
          header.innerHTML = `
            <div class="stack"><span class="badge">${g.agency||''}</span><span class="badge">${g.bizname||''}</span></div>
            <div class="stack"><button class="btn" data-copy>복사</button></div>
          `;
          const ta = document.createElement('textarea');
          ta.value = g.text || '';
          ta.style.minHeight = '120px';
          ta.setAttribute('data-textarea', '1');
          card.appendChild(header);
          card.appendChild(ta);
          container.appendChild(card);
          const btn = header.querySelector('[data-copy]');
          btn.addEventListener('click', ()=>{
            const tx = ta.value;
            (navigator.clipboard?.writeText? navigator.clipboard.writeText(tx) : new Promise((res,rej)=>{ const t=document.createElement('textarea'); t.value=tx; document.body.appendChild(t); t.select(); document.execCommand('copy')?res():rej(); document.body.removeChild(t);})).then(()=>toast('복사되었습니다.')).catch(()=>toast('복사 실패'));
          });
        }
        document.getElementById('count').textContent = groups.length.toString();
      }

      async function loadWeekly(){
        const base = document.getElementById('base-date').value;
        const weeks = document.getElementById('weeks').value || '3';
        const params = new URLSearchParams({ base_date: base, weeks });
        const btn = document.getElementById('load-weekly');
        btn.disabled = true; btn.textContent = '불러오는 중...';
        try{
          const res = await fetch(`/api/internal/weekly?${params.toString()}`);
          const data = await res.json().catch(()=>({}));
          if(!res.ok) throw new Error(data?.error||'불러오기 실패');
          weeklyGroups = Array.isArray(data.groups)? data.groups: [];
          renderWeekly(weeklyGroups);
          toast('완료');
        }catch(e){ toast(e.message||'실패'); }
        finally{ btn.disabled=false; btn.textContent='주간 요약 불러오기'; }
      }

      document.getElementById('load-weekly').addEventListener('click', loadWeekly);

      // 상단 자동 로드로 충분하여 수동 불러오기 버튼 제거됨

      // 초기 상태 설정: 업데이트 시간 배지(KST), 날짜 기본값(오늘 KST), 자동완성 목록, 렌더
      (function init(){
        setUpdatedBadge();
        try{
          const now = new Date();
          const yyyy = now.getFullYear();
          const mm = String(now.getMonth()+1).padStart(2,'0');
          const dd = String(now.getDate()).padStart(2,'0');
          document.getElementById('base-date').value = `${yyyy}-${mm}-${dd}`;
        }catch(e){}
        loadWeekly();
      })();
    </script>
  </body>
  </html>


