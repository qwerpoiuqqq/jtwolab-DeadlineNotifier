# Place Manager (마감 안내 자동화)

구글 스프레드시트의 각 작업 탭(워크시트)에서 공통 컬럼들을 읽어, 대행사별/작업별로 복사 가능한 카톡 마감 안내 문구를 자동 생성합니다.

## 요구 사항
- Python 3.10+
- 구글 서비스 계정 (해당 스프레드시트에 조회 권한 공유 필요)
- Playwright (순위 크롤링용)

## 설치
```powershell
cd place_manager
python -m venv .venv
. .venv\Scripts\activate
pip install -r requirements.txt
playwright install chromium
```

## 환경 설정
1) `env.example` 파일을 복사하여 `.env` 파일을 만듭니다. (Windows 탐색기에서 파일 이름 앞에 점을 붙여 저장하세요)
2) 서비스 계정 키를 준비합니다. 두 가지 방법 중 하나를 사용하세요.
   - 키 파일 사용: `GOOGLE_APPLICATION_CREDENTIALS`에 파일 경로 설정 (예: `service_account.json`)
   - 인라인 JSON 사용: `SERVICE_ACCOUNT_JSON`에 키 JSON 문자열 전체를 넣기
3) 스프레드시트 ID를 `SPREADSHEET_ID`에 설정합니다. 주소가 `https://docs.google.com/spreadsheets/d/<ID>/edit`면 `<ID>` 부분입니다.
4) 시트별로 열 구조가 달라도 아래 5개 컬럼명이 있어야 합니다.
   - 대행사 명
   - 내부 진행건
   - 마감 잔여일
   - 마감 안내 체크
   - 상호명

`.env` 예시는 `env.example` 참고.

## 실행
개발 실행(Flask 내장 서버):
```powershell
python app.py
```
프로덕션 실행(Waitress):
```powershell
python app.py --prod
```
기본 주소: `http://localhost:8080`

## 사용 방법
- 상단 입력창에 만료 기준 일수(0=오늘, 1=1일뒤, 2=2일뒤 …)를 콤마(,)로 입력하고 조회
- 결과는 [대행사] 묶음으로 보이며, 각 대행사 카드의 복사 버튼을 눌러 바로 카톡에 붙여넣기
- 실제 복사되는 내용에는 대행사명은 포함되지 않고, 아래 형식으로 출력됩니다:

```
<작업명>
상호명1
상호명2

<작업명>
상호명1
상호명2
상호명3
```

## 주요 기능

### 1. 마감 안내 자동화
- 구글 시트에서 대행사별 마감건을 조회하여 카카오톡 안내 문구 자동 생성
- 날짜별, 작업별 그룹핑으로 효율적인 관리

### 2. 월보장 관리
- 제이투랩, 일류기획 보장건 통합 관리
- 실시간 노출 현황 확인
- 일차별 순위 추적 및 증감 분석
- 자동 동기화 (매일 9시, 16시)

### 3. 작업량 캐시 시스템 ⚡ (NEW)
- **성능 개선**: 작업량 조회 속도 10-20배 향상 (5-10초 → 0.5초)
- **자동 갱신**: 매일 오전 11시 30분에 업체별 3주치 작업량 자동 캐시
- **즉시 반영**: 버튼 클릭만으로 캐시된 데이터 즉시 표시
- **API 호출 최소화**: 구글 시트 API 호출을 하루 1-2회로 감소

자세한 내용은 [WORKLOAD_CACHE_README.md](WORKLOAD_CACHE_README.md) 참고

### 4. 결재선 · 정산
- 엑셀 업로드를 통한 단가표 관리
- 월별 결재선 집계 및 정산 자동 계산

### 5. 실시간 순위 크롤링 🏆 (NEW)
- **애드로그 연동**: 네이버 플레이스 순위 자동 크롤링
- **실시간 데이터**: 크롤링된 순위를 우선 표시 (시트 데이터 대신)
- **자동 갱신**: 매일 14시 30분 자동 크롤링
- **수동 갱신**: "🏆 순위 갱신" 버튼으로 즉시 크롤링
- **히스토리 저장**: SQLite DB에 순위 변동 히스토리 저장

## 스케줄러 작업
애플리케이션은 다음 작업을 자동으로 실행합니다:
- **매일 09:00**: 보장건 데이터 동기화
- **매일 11:30**: 작업량 캐시 갱신 (업체별 3주치)
- **매일 14:30**: 순위 크롤링 (제이투랩, 일류기획)
- **매일 16:00**: 보장건 데이터 동기화

## 배포 옵션

### 옵션 1: 로컬 서버
- 사내 24시간 구동 PC에 설치 후 `--prod`로 실행
- Windows 서비스(작업 스케줄러)로 등록하면 자동 재시작 가능

### 옵션 2: Render 클라우드 배포
- 무료 호스팅 가능 (Free Tier)
- 자동 배포 및 스케줄링 지원
- **주의**: 파일시스템이 임시이므로 재시작 시 DB/캐시 초기화됨
- 자세한 내용은 [DEPLOY.md](DEPLOY.md) 및 [README_RENDER.md](README_RENDER.md) 참고
